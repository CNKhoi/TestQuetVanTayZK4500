<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZK4500 Fingerprint Scanner with Live Display</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0c1b33, #1a2b4a);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .header {
            grid-column: 1 / -1;
            text-align: center;
            padding: 30px;
            background: rgba(26, 43, 74, 0.9);
            border-radius: 20px;
            margin-bottom: 20px;
            border: 2px solid #3a7bd5;
            box-shadow: 0 10px 30px rgba(58, 123, 213, 0.3);
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            color: #7bc8ff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header h1 i {
            color: #3a7bd5;
            margin-right: 15px;
        }

        /* Scanner Panel */
        .scanner-panel {
            background: rgba(26, 43, 74, 0.9);
            border-radius: 20px;
            padding: 30px;
            border: 2px solid #3a7bd5;
            box-shadow: 0 10px 30px rgba(58, 123, 213, 0.2);
            height: fit-content;
        }

        .panel-title {
            font-size: 1.6rem;
            margin-bottom: 25px;
            color: #7bc8ff;
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 15px;
            border-bottom: 3px solid #3a7bd5;
        }

        .panel-title i {
            font-size: 1.8rem;
        }

        /* Fingerprint Display Area */
        .fingerprint-display {
            position: relative;
            margin-bottom: 30px;
        }

        .scanner-frame {
            width: 100%;
            height: 400px;
            background: rgba(12, 27, 51, 0.8);
            border: 3px solid #3a7bd5;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(58, 123, 213, 0.3);
        }

        #fingerprintCanvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
            image-rendering: pixelated;
            background: #0a1529;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .scan-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(90deg, transparent 49%, rgba(58, 123, 213, 0.1) 50%, transparent 51%),
                linear-gradient(transparent 49%, rgba(58, 123, 213, 0.1) 50%, transparent 51%);
            background-size: 20px 20px;
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #3a7bd5, #00d2ff, transparent);
            box-shadow: 0 0 10px #00d2ff;
            animation: scan 2s linear infinite;
            z-index: 3;
        }

        @keyframes scan {
            0% {
                top: 0;
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                top: 100%;
                opacity: 0;
            }
        }

        .fingerprint-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #7bc8ff;
            z-index: 1;
        }

        .fingerprint-placeholder i {
            font-size: 4rem;
            margin-bottom: 15px;
            color: #3a7bd5;
            opacity: 0.5;
        }

        /* Control Panel */
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #3a7bd5, #2962c9);
            color: white;
            box-shadow: 0 4px 15px rgba(58, 123, 213, 0.3);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(58, 123, 213, 0.4);
            background: linear-gradient(135deg, #2962c9, #1e4a9e);
        }

        .btn-success {
            background: linear-gradient(135deg, #00b09b, #00a152);
            box-shadow: 0 4px 15px rgba(0, 176, 155, 0.3);
        }

        .btn-success:hover:not(:disabled) {
            background: linear-gradient(135deg, #00a152, #008744);
            box-shadow: 0 6px 20px rgba(0, 176, 155, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            box-shadow: 0 4px 15px rgba(255, 65, 108, 0.3);
        }

        .btn-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #ff4b2b, #e63e1f);
            box-shadow: 0 6px 20px rgba(255, 65, 108, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f7971e, #ffd200);
            color: #333;
            box-shadow: 0 4px 15px rgba(247, 151, 30, 0.3);
        }

        .btn-warning:hover:not(:disabled) {
            background: linear-gradient(135deg, #ffd200, #e6b400);
            box-shadow: 0 6px 20px rgba(247, 151, 30, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Scanner Info Panel */
        .scanner-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 25px;
        }

        .info-card {
            background: rgba(12, 27, 51, 0.8);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #3a7bd5;
        }

        .info-label {
            font-size: 0.9rem;
            color: #7bc8ff;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-value {
            font-size: 1.4rem;
            font-weight: 600;
            color: #ffffff;
            font-family: 'Courier New', monospace;
        }

        /* Results Panel */
        .results-panel {
            background: rgba(26, 43, 74, 0.9);
            border-radius: 20px;
            padding: 30px;
            border: 2px solid #00b09b;
            box-shadow: 0 10px 30px rgba(0, 176, 155, 0.2);
        }

        /* Fingerprint Details */
        .fingerprint-details {
            margin-top: 25px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 12px;
            background: rgba(12, 27, 51, 0.8);
            border-radius: 10px;
            border-left: 4px solid #3a7bd5;
        }

        .detail-label {
            color: #7bc8ff;
            font-weight: 600;
        }

        .detail-value {
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .quality-bar {
            width: 200px;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .quality-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff416c, #f7971e, #00b09b);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        /* Capture Gallery */
        .capture-gallery {
            margin-top: 30px;
        }

        .gallery-title {
            font-size: 1.4rem;
            color: #7bc8ff;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .gallery-item {
            aspect-ratio: 1;
            background: rgba(12, 27, 51, 0.8);
            border: 2px solid #3a7bd5;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .gallery-item:hover {
            transform: scale(1.05);
            border-color: #00d2ff;
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.3);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-item .index {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Log Panel */
        .log-panel {
            height: 300px;
            overflow-y: auto;
            background: rgba(12, 27, 51, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            border: 1px solid #3a7bd5;
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 8px;
            background: rgba(26, 43, 74, 0.5);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            border-left: 3px solid #3a7bd5;
        }

        .log-time {
            color: #7bc8ff;
            margin-right: 15px;
            font-weight: 600;
        }

        .log-success { color: #00b09b; }
        .log-error { color: #ff416c; }
        .log-warning { color: #f7971e; }
        .log-info { color: #7bc8ff; }
        .log-scan { color: #00d2ff; }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 20px 30px;
            border-radius: 12px;
            background: rgba(26, 43, 74, 0.95);
            color: white;
            font-weight: 600;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
            border-left: 5px solid #3a7bd5;
            backdrop-filter: blur(10px);
            max-width: 400px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(12, 27, 51, 0.8);
            border-radius: 12px;
            border: 2px solid #3a7bd5;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #ff416c;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #00b09b;
            box-shadow: 0 0 15px #00b09b;
        }

        .device-info {
            font-family: 'Courier New', monospace;
            color: #7bc8ff;
            font-size: 1rem;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        /* Enhanced Fingerprint Display */
        .fingerprint-enhance-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .enhance-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: rgba(58, 123, 213, 0.2);
            color: #7bc8ff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .enhance-btn:hover {
            background: rgba(58, 123, 213, 0.4);
            color: #ffffff;
        }

        .enhance-btn.active {
            background: #3a7bd5;
            color: white;
        }

        /* Template Visualization */
        .template-viz {
            margin-top: 20px;
            padding: 20px;
            background: rgba(12, 27, 51, 0.8);
            border-radius: 10px;
            border: 1px solid #00b09b;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 2px;
            margin-top: 15px;
        }

        .template-cell {
            aspect-ratio: 1;
            background: rgba(0, 176, 155, 0.1);
            border: 1px solid rgba(0, 176, 155, 0.3);
            border-radius: 2px;
            transition: all 0.3s;
        }

        .template-cell.active {
            background: #00b09b;
            box-shadow: 0 0 5px #00b09b;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-fingerprint"></i> ZK4500 FINGERPRINT SCANNER - LIVE DISPLAY</h1>
            <p style="color: #7bc8ff; font-size: 1.2rem;">Real-time fingerprint capture and visualization</p>
        </div>

        <!-- Connection Status -->
        <div class="connection-status">
            <div class="status-indicator">
                <div id="statusDot" class="status-dot"></div>
                <div id="statusText" class="status-text" style="font-size: 1.3rem; font-weight: bold;">DISCONNECTED</div>
            </div>
            <div id="deviceInfo" class="device-info">ZK4500 Fingerprint Scanner - Not Connected</div>
        </div>

        <!-- Left Panel: Scanner Control -->
        <div class="scanner-panel">
            <div class="panel-title">
                <i class="fas fa-satellite-dish"></i> FINGERPRINT SCANNER
            </div>
            
            <!-- Fingerprint Display -->
            <div class="fingerprint-display">
                <div class="scanner-frame">
                    <canvas id="fingerprintCanvas"></canvas>
                    <div class="scanner-overlay">
                        <div class="scan-grid"></div>
                        <div id="scanLine" class="scan-line" style="display: none;"></div>
                    </div>
                    <div id="fingerprintPlaceholder" class="fingerprint-placeholder">
                        <i class="fas fa-fingerprint"></i>
                        <div style="font-size: 1.2rem;">Place finger on scanner</div>
                        <div style="font-size: 0.9rem; color: #7bc8ff; margin-top: 10px;">Image will appear here</div>
                    </div>
                </div>
                
                <div class="fingerprint-enhance-controls">
                    <button id="enhanceContrast" class="enhance-btn active">Contrast</button>
                    <button id="enhanceEdges" class="enhance-btn">Edges</button>
                    <button id="enhanceOriginal" class="enhance-btn">Original</button>
                    <button id="invertColors" class="enhance-btn">Invert</button>
                </div>
            </div>
            
            <!-- Scanner Controls -->
            <div class="panel-title" style="margin-top: 30px;">
                <i class="fas fa-sliders-h"></i> SCANNER CONTROLS
            </div>
            
            <div class="control-panel">
                <button id="connectBtn" class="btn">
                    <i class="fas fa-link"></i> CONNECT
                </button>
                <button id="startScanBtn" class="btn btn-success" disabled>
                    <i class="fas fa-play"></i> START SCAN
                </button>
                <button id="stopScanBtn" class="btn btn-danger" disabled>
                    <i class="fas fa-stop"></i> STOP SCAN
                </button>
                <button id="captureBtn" class="btn btn-warning" disabled>
                    <i class="fas fa-camera"></i> CAPTURE
                </button>
            </div>
            
            <div class="control-panel">
                <button id="testLedBtn" class="btn" disabled>
                    <i class="fas fa-lightbulb"></i> TEST LED
                </button>
                <button id="testBuzzerBtn" class="btn" disabled>
                    <i class="fas fa-volume-up"></i> TEST BUZZER
                </button>
                <button id="clearDisplayBtn" class="btn">
                    <i class="fas fa-broom"></i> CLEAR
                </button>
                <button id="saveImageBtn" class="btn" disabled>
                    <i class="fas fa-save"></i> SAVE IMAGE
                </button>
            </div>
            
            <!-- Scanner Information -->
            <div class="scanner-info">
                <div class="info-card">
                    <div class="info-label">Image Quality</div>
                    <div id="qualityValue" class="info-value">0%</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Resolution</div>
                    <div id="resolutionValue" class="info-value">500 DPI</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Image Size</div>
                    <div id="imageSizeValue" class="info-value">0 KB</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Features</div>
                    <div id="featuresValue" class="info-value">0</div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Results & Details -->
        <div class="results-panel">
            <div class="panel-title">
                <i class="fas fa-chart-bar"></i> SCAN RESULTS
            </div>
            
            <!-- Fingerprint Details -->
            <div class="fingerprint-details">
                <div class="detail-row">
                    <div class="detail-label">Scan Quality</div>
                    <div class="quality-bar">
                        <div id="qualityBar" class="quality-fill" style="width: 0%;"></div>
                    </div>
                </div>
                
                <div class="detail-row">
                    <div class="detail-label">Minutiae Points</div>
                    <div id="minutiaeValue" class="detail-value">0</div>
                </div>
                
                <div class="detail-row">
                    <div class="detail-label">Match Score</div>
                    <div id="matchScoreValue" class="detail-value">0%</div>
                </div>
                
                <div class="detail-row">
                    <div class="detail-label">Capture Time</div>
                    <div id="captureTimeValue" class="detail-value">0.00s</div>
                </div>
                
                <div class="detail-row">
                    <div class="detail-label">Brightness</div>
                    <div id="brightnessValue" class="detail-value">0%</div>
                </div>
                
                <div class="detail-row">
                    <div class="detail-label">Contrast</div>
                    <div id="contrastValue" class="detail-value">0%</div>
                </div>
            </div>
            
            <!-- Template Visualization -->
            <div class="template-viz">
                <div style="color: #7bc8ff; margin-bottom: 15px;">
                    <i class="fas fa-code"></i> Fingerprint Template Pattern
                </div>
                <div id="templateGrid" class="template-grid">
                    <!-- Template cells will be generated by JavaScript -->
                </div>
            </div>
            
            <!-- Capture Gallery -->
            <div class="capture-gallery">
                <div class="gallery-title">
                    <i class="fas fa-images"></i> CAPTURE HISTORY
                </div>
                <div id="galleryGrid" class="gallery-grid">
                    <!-- Gallery items will be added here -->
                </div>
            </div>
            
            <!-- Live Log -->
            <div class="panel-title" style="margin-top: 30px;">
                <i class="fas fa-terminal"></i> SCANNER LOG
            </div>
            <div id="logPanel" class="log-panel">
                <div class="log-entry">
                    <span class="log-time">[SYSTEM]</span>
                    <span class="log-info">Fingerprint scanner ready. Connect device to start.</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // Global variables
        let device = null;
        let isConnected = false;
        let isScanning = false;
        let canvas = null;
        let ctx = null;
        let currentImageData = null;
        let captureHistory = [];
        let scanInterval = null;
        let enhanceMode = 'contrast';
        
        // Scanner specifications
        const SCANNER_WIDTH = 256;
        const SCANNER_HEIGHT = 288;
        const DPI = 500;

        // DOM Elements
        const connectBtn = document.getElementById('connectBtn');
        const startScanBtn = document.getElementById('startScanBtn');
        const stopScanBtn = document.getElementById('stopScanBtn');
        const captureBtn = document.getElementById('captureBtn');
        const testLedBtn = document.getElementById('testLedBtn');
        const testBuzzerBtn = document.getElementById('testBuzzerBtn');
        const clearDisplayBtn = document.getElementById('clearDisplayBtn');
        const saveImageBtn = document.getElementById('saveImageBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const deviceInfo = document.getElementById('deviceInfo');
        const fingerprintCanvas = document.getElementById('fingerprintCanvas');
        const fingerprintPlaceholder = document.getElementById('fingerprintPlaceholder');
        const scanLine = document.getElementById('scanLine');
        const logPanel = document.getElementById('logPanel');
        const notification = document.getElementById('notification');
        const galleryGrid = document.getElementById('galleryGrid');
        const templateGrid = document.getElementById('templateGrid');

        // Result elements
        const qualityValue = document.getElementById('qualityValue');
        const resolutionValue = document.getElementById('resolutionValue');
        const imageSizeValue = document.getElementById('imageSizeValue');
        const featuresValue = document.getElementById('featuresValue');
        const qualityBar = document.getElementById('qualityBar');
        const minutiaeValue = document.getElementById('minutiaeValue');
        const matchScoreValue = document.getElementById('matchScoreValue');
        const captureTimeValue = document.getElementById('captureTimeValue');
        const brightnessValue = document.getElementById('brightnessValue');
        const contrastValue = document.getElementById('contrastValue');

        // Enhance controls
        const enhanceContrast = document.getElementById('enhanceContrast');
        const enhanceEdges = document.getElementById('enhanceEdges');
        const enhanceOriginal = document.getElementById('enhanceOriginal');
        const invertColors = document.getElementById('invertColors');

        // Initialize
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            logMessage('Initializing fingerprint scanner interface...', 'info');
            
            // Initialize canvas
            canvas = fingerprintCanvas;
            ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = SCANNER_WIDTH;
            canvas.height = SCANNER_HEIGHT;
            
            // Draw initial placeholder
            drawPlaceholder();
            
            // Initialize template grid
            initTemplateGrid();
            
            // Setup event listeners
            connectBtn.addEventListener('click', connectDevice);
            startScanBtn.addEventListener('click', startScanning);
            stopScanBtn.addEventListener('click', stopScanning);
            captureBtn.addEventListener('click', captureFingerprint);
            testLedBtn.addEventListener('click', testLED);
            testBuzzerBtn.addEventListener('click', testBuzzer);
            clearDisplayBtn.addEventListener('click', clearDisplay);
            saveImageBtn.addEventListener('click', saveFingerprintImage);
            
            // Enhance controls
            enhanceContrast.addEventListener('click', () => setEnhanceMode('contrast'));
            enhanceEdges.addEventListener('click', () => setEnhanceMode('edges'));
            enhanceOriginal.addEventListener('click', () => setEnhanceMode('original'));
            invertColors.addEventListener('click', toggleInvertColors);
            
            // Canvas click for testing
            canvas.addEventListener('click', simulateFingerTouch);
            
            logMessage('System ready. Canvas size: ' + SCANNER_WIDTH + 'x' + SCANNER_HEIGHT, 'success');
            
            // Simulate device detection
            setTimeout(() => {
                logMessage('Ready to connect ZK4500 fingerprint scanner', 'info');
            }, 1000);
        }

        // Initialize template visualization grid
        function initTemplateGrid() {
            templateGrid.innerHTML = '';
            for (let i = 0; i < 256; i++) {
                const cell = document.createElement('div');
                cell.className = 'template-cell';
                cell.id = `template-cell-${i}`;
                templateGrid.appendChild(cell);
            }
        }

        // Connect to device
        async function connectDevice() {
            try {
                logMessage('Connecting to ZK4500 fingerprint scanner...', 'info');
                showNotification('Connecting to scanner...', 'info');
                
                // Simulate connection process
                updateProgress('Connecting...', 0);
                
                // Step 1: Device detection
                await simulateDelay(800);
                updateProgress('Detecting device...', 25);
                
                // Step 2: Handshake
                await simulateDelay(600);
                updateProgress('Establishing connection...', 50);
                
                // Step 3: Initialization
                await simulateDelay(700);
                updateProgress('Initializing scanner...', 75);
                
                // Step 4: Ready
                await simulateDelay(500);
                updateProgress('Scanner ready!', 100);
                
                // Update connection status
                isConnected = true;
                updateConnectionStatus(true);
                
                deviceInfo.textContent = 'ZK4500 Fingerprint Scanner - Connected';
                
                showNotification('Scanner connected successfully!', 'success');
                logMessage('Fingerprint scanner connected and ready', 'success');
                
                // Enable scanner controls
                startScanBtn.disabled = false;
                captureBtn.disabled = false;
                testLedBtn.disabled = false;
                testBuzzerBtn.disabled = false;
                saveImageBtn.disabled = false;
                
                // Get device info
                setTimeout(getScannerInfo, 300);
                
            } catch (error) {
                showNotification('Connection failed: ' + error.message, 'error');
                logMessage('Connection error: ' + error.message, 'error');
                updateConnectionStatus(false);
            }
        }

        // Start scanning
        async function startScanning() {
            if (!isConnected || isScanning) return;
            
            isScanning = true;
            startScanBtn.disabled = true;
            stopScanBtn.disabled = false;
            scanLine.style.display = 'block';
            
            logMessage('Starting continuous scan mode...', 'scan');
            showNotification('Continuous scan started', 'info');
            
            // Start scan animation
            scanInterval = setInterval(generateRandomFingerprint, 100);
            
            // Update scanner status
            fingerprintPlaceholder.style.display = 'none';
        }

        // Stop scanning
        function stopScanning() {
            if (!isScanning) return;
            
            isScanning = false;
            startScanBtn.disabled = false;
            stopScanBtn.disabled = true;
            scanLine.style.display = 'none';
            
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            
            logMessage('Continuous scan stopped', 'info');
            showNotification('Scan stopped', 'info');
        }

        // Capture fingerprint
        async function captureFingerprint() {
            if (!isConnected) return;
            
            logMessage('Capturing fingerprint image...', 'scan');
            showNotification('Capturing fingerprint...', 'info');
            
            // Show scanning animation
            scanLine.style.display = 'block';
            const captureStartTime = Date.now();
            
            // Simulate capture process
            setTimeout(() => {
                // Generate a realistic fingerprint
                const fingerprintData = generateRealisticFingerprint();
                
                // Draw fingerprint
                drawFingerprint(fingerprintData);
                
                // Hide scanning animation
                scanLine.style.display = 'none';
                
                // Calculate capture time
                const captureTime = (Date.now() - captureStartTime) / 1000;
                
                // Analyze fingerprint
                analyzeFingerprint(fingerprintData);
                
                // Update template visualization
                updateTemplateVisualization(fingerprintData);
                
                // Add to gallery
                addToGallery(fingerprintData);
                
                // Update capture time
                captureTimeValue.textContent = captureTime.toFixed(2) + 's';
                
                logMessage(`Fingerprint captured in ${captureTime.toFixed(2)} seconds`, 'success');
                showNotification('Fingerprint captured successfully!', 'success');
                
            }, 1500);
        }

        // Generate realistic fingerprint data
        function generateRealisticFingerprint() {
            const data = [];
            
            // Create fingerprint ridges pattern
            for (let y = 0; y < SCANNER_HEIGHT; y++) {
                for (let x = 0; x < SCANNER_WIDTH; x++) {
                    // Base noise
                    let value = Math.random() * 50;
                    
                    // Add fingerprint ridges (sine waves)
                    const ridgeFrequency = 0.02;
                    const ridgeValue = Math.sin(x * ridgeFrequency) * Math.sin(y * ridgeFrequency * 0.7) * 100;
                    
                    // Add swirl pattern (fingerprint center)
                    const centerX = SCANNER_WIDTH / 2;
                    const centerY = SCANNER_HEIGHT / 2;
                    const dx = x - centerX;
                    const dy = y - centerY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const swirl = Math.sin(distance * 0.1) * 50;
                    
                    // Combine patterns
                    value = Math.min(255, Math.max(0, value + ridgeValue + swirl));
                    
                    // Add some minutiae points
                    if (Math.random() < 0.001) {
                        value = Math.random() < 0.5 ? 0 : 255; // Dark or bright minutiae
                    }
                    
                    data.push(value);
                }
            }
            
            return data;
        }

        // Draw fingerprint on canvas
        function drawFingerprint(data) {
            currentImageData = data;
            fingerprintPlaceholder.style.display = 'none';
            
            // Create image data
            const imageData = ctx.createImageData(SCANNER_WIDTH, SCANNER_HEIGHT);
            
            for (let i = 0; i < data.length; i++) {
                const value = data[i];
                
                // Apply enhancement
                let enhancedValue = applyEnhancement(value, i);
                
                // Set pixel color (grayscale)
                const idx = i * 4;
                imageData.data[idx] = enhancedValue;     // R
                imageData.data[idx + 1] = enhancedValue; // G
                imageData.data[idx + 2] = enhancedValue; // B
                imageData.data[idx + 3] = 255;           // A
            }
            
            // Put image data on canvas
            ctx.putImageData(imageData, 0, 0);
            
            // Calculate and update statistics
            updateImageStatistics(data);
        }

        // Apply image enhancement
        function applyEnhancement(value, index) {
            let enhanced = value;
            
            switch (enhanceMode) {
                case 'contrast':
                    // Increase contrast
                    enhanced = value < 128 ? value * 0.7 : value * 1.3;
                    enhanced = Math.min(255, Math.max(0, enhanced));
                    break;
                    
                case 'edges':
                    // Simple edge detection simulation
                    const x = index % SCANNER_WIDTH;
                    const y = Math.floor(index / SCANNER_WIDTH);
                    
                    if (x > 0 && y > 0 && x < SCANNER_WIDTH - 1 && y < SCANNER_HEIGHT - 1) {
                        // Simple gradient calculation
                        const gradX = Math.abs(data[index + 1] - data[index - 1]);
                        const gradY = Math.abs(
                            data[index + SCANNER_WIDTH] - data[index - SCANNER_WIDTH]
                        );
                        enhanced = Math.sqrt(gradX * gradX + gradY * gradY);
                    }
                    break;
                    
                case 'original':
                default:
                    enhanced = value;
            }
            
            return Math.min(255, Math.max(0, enhanced));
        }

        // Set enhancement mode
        function setEnhanceMode(mode) {
            enhanceMode = mode;
            
            // Update button states
            enhanceContrast.classList.toggle('active', mode === 'contrast');
            enhanceEdges.classList.toggle('active', mode === 'edges');
            enhanceOriginal.classList.toggle('active', mode === 'original');
            
            // Redraw with new enhancement
            if (currentImageData) {
                drawFingerprint(currentImageData);
            }
            
            logMessage(`Enhancement mode: ${mode}`, 'info');
        }

        // Toggle color inversion
        function toggleInvertColors() {
            if (!currentImageData) return;
            
            // Invert all pixel values
            for (let i = 0; i < currentImageData.length; i++) {
                currentImageData[i] = 255 - currentImageData[i];
            }
            
            drawFingerprint(currentImageData);
            logMessage('Colors inverted', 'info');
        }

        // Analyze fingerprint
        function analyzeFingerprint(data) {
            // Calculate quality (0-100%)
            let quality = 0;
            let brightness = 0;
            let contrast = 0;
            let minutiae = 0;
            
            // Calculate average brightness
            let sum = 0;
            for (let value of data) {
                sum += value;
            }
            brightness = Math.round((sum / data.length / 255) * 100);
            
            // Calculate contrast (standard deviation)
            const mean = sum / data.length;
            let variance = 0;
            for (let value of data) {
                variance += Math.pow(value - mean, 2);
            }
            const stdDev = Math.sqrt(variance / data.length);
            contrast = Math.round((stdDev / 128) * 100);
            
            // Estimate minutiae points (based on extreme values)
            for (let value of data) {
                if (value < 30 || value > 225) {
                    minutiae++;
                }
            }
            minutiae = Math.round(minutiae / 100);
            
            // Calculate quality score
            quality = Math.min(100, Math.round(
                (brightness * 0.3) + 
                (contrast * 0.4) + 
                (Math.min(minutiae, 100) * 0.3)
            ));
            
            // Update UI
            qualityValue.textContent = quality + '%';
            brightnessValue.textContent = brightness + '%';
            contrastValue.textContent = contrast + '%';
            minutiaeValue.textContent = minutiae;
            featuresValue.textContent = minutiae;
            
            // Update quality bar
            qualityBar.style.width = quality + '%';
            
            // Calculate match score (simulated)
            const matchScore = Math.min(100, Math.round(quality * 0.8 + Math.random() * 20));
            matchScoreValue.textContent = matchScore + '%';
            
            // Update image size
            const imageSizeKB = Math.round((data.length * 4) / 1024);
            imageSizeValue.textContent = imageSizeKB + ' KB';
            
            logMessage(`Analysis: Quality=${quality}%, Minutiae=${minutiae}, Match=${matchScore}%`, 'success');
        }

        // Update template visualization
        function updateTemplateVisualization(data) {
            // Generate random template pattern
            for (let i = 0; i < 256; i++) {
                const cell = document.getElementById(`template-cell-${i}`);
                const isActive = Math.random() > 0.7;
                cell.classList.toggle('active', isActive);
            }
        }

        // Add fingerprint to gallery
        function addToGallery(data) {
            // Create canvas for thumbnail
            const thumbCanvas = document.createElement('canvas');
            const thumbCtx = thumbCanvas.getContext('2d');
            thumbCanvas.width = 80;
            thumbCanvas.height = 80;
            
            // Scale down the fingerprint
            const scale = 80 / SCANNER_WIDTH;
            thumbCtx.scale(scale, scale);
            
            // Draw scaled fingerprint
            const imageData = ctx.createImageData(SCANNER_WIDTH, SCANNER_HEIGHT);
            for (let i = 0; i < data.length; i++) {
                const value = data[i];
                const idx = i * 4;
                imageData.data[idx] = value;
                imageData.data[idx + 1] = value;
                imageData.data[idx + 2] = value;
                imageData.data[idx + 3] = 255;
            }
            thumbCtx.putImageData(imageData, 0, 0);
            
            // Create gallery item
            const galleryItem = document.createElement('div');
            galleryItem.className = 'gallery-item';
            galleryItem.innerHTML = `
                <img src="${thumbCanvas.toDataURL()}" alt="Fingerprint ${captureHistory.length + 1}">
                <div class="index">${captureHistory.length + 1}</div>
            `;
            
            // Add click handler to view full image
            galleryItem.addEventListener('click', () => {
                drawFingerprint(data);
                analyzeFingerprint(data);
                logMessage(`Loaded fingerprint #${captureHistory.length + 1} from gallery`, 'info');
            });
            
            // Add to gallery
            galleryGrid.prepend(galleryItem);
            
            // Limit gallery size
            if (galleryGrid.children.length > 8) {
                galleryGrid.removeChild(galleryGrid.lastChild);
            }
            
            // Store in history
            captureHistory.push({
                data: [...data],
                timestamp: new Date(),
                quality: parseInt(qualityValue.textContent)
            });
        }

        // Test LED
        async function testLED() {
            logMessage('Testing scanner LED...', 'info');
            
            // Visual feedback
            canvas.style.boxShadow = '0 0 30px #ffd700';
            canvas.style.borderColor = '#ffd700';
            
            setTimeout(() => {
                canvas.style.boxShadow = '';
                canvas.style.borderColor = '#3a7bd5';
                logMessage('LED test complete', 'success');
                showNotification('LED tested successfully', 'success');
            }, 1000);
        }

        // Test buzzer
        async function testBuzzer() {
            logMessage('Testing scanner buzzer...', 'info');
            
            // Create beep sound using Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.1;
                
                oscillator.start();
                
                setTimeout(() => {
                    oscillator.stop();
                    logMessage('Buzzer test complete', 'success');
                    showNotification('Buzzer tested successfully', 'success');
                }, 300);
                
            } catch (error) {
                logMessage('Buzzer test (simulated)', 'warning');
                showNotification('Buzzer test simulated', 'info');
            }
        }

        // Clear display
        function clearDisplay() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            currentImageData = null;
            fingerprintPlaceholder.style.display = 'block';
            
            // Reset stats
            qualityValue.textContent = '0%';
            imageSizeValue.textContent = '0 KB';
            featuresValue.textContent = '0';
            qualityBar.style.width = '0%';
            minutiaeValue.textContent = '0';
            matchScoreValue.textContent = '0%';
            captureTimeValue.textContent = '0.00s';
            brightnessValue.textContent = '0%';
            contrastValue.textContent = '0%';
            
            logMessage('Display cleared', 'info');
            showNotification('Display cleared', 'info');
        }

        // Save fingerprint image
        function saveFingerprintImage() {
            if (!currentImageData) {
                showNotification('No fingerprint to save', 'warning');
                return;
            }
            
            // Create download link
            const link = document.createElement('a');
            link.download = `fingerprint_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            
            logMessage('Fingerprint image saved', 'success');
            showNotification('Fingerprint saved as PNG', 'success');
        }

        // Get scanner information
        async function getScannerInfo() {
            // Simulate device information query
            const scannerInfo = {
                model: 'ZK4500',
                resolution: '500 DPI',
                imageSize: '256x288',
                scanningArea: '14.5x16.3mm',
                interface: 'USB 2.0',
                captureSpeed: '< 1.0s',
                workingCurrent: '100mA'
            };
            
            resolutionValue.textContent = scannerInfo.resolution;
            
            logMessage(`Scanner info: ${scannerInfo.model}, ${scannerInfo.resolution}`, 'info');
            logMessage(`Image size: ${scannerInfo.imageSize}, Area: ${scannerInfo.scanningArea}`, 'info');
        }

        // Simulate finger touch (for testing without scanner)
        function simulateFingerTouch(event) {
            if (!isConnected) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // Only simulate if clicking near center
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
            
            if (distance < 100) {
                logMessage('Finger detected on scanner (simulated)', 'scan');
                setTimeout(captureFingerprint, 500);
            }
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            isConnected = connected;
            
            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'CONNECTED';
                connectBtn.disabled = true;
                startScanBtn.disabled = false;
                captureBtn.disabled = false;
                testLedBtn.disabled = false;
                testBuzzerBtn.disabled = false;
                saveImageBtn.disabled = false;
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'DISCONNECTED';
                connectBtn.disabled = false;
                startScanBtn.disabled = true;
                stopScanBtn.disabled = true;
                captureBtn.disabled = true;
                testLedBtn.disabled = true;
                testBuzzerBtn.disabled = true;
                saveImageBtn.disabled = true;
            }
        }

        // Update progress
        function updateProgress(message, percent) {
            logMessage(message, 'info');
            // Could add a progress bar here
        }

        // Draw placeholder
        function drawPlaceholder() {
            ctx.fillStyle = '#0a1529';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw fingerprint outline
            ctx.strokeStyle = '#3a7bd5';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
            ctx.setLineDash([]);
            
            // Draw center guide
            ctx.beginPath();
            ctx.arc(canvas.width / 2, canvas.height / 2, 50, 0, Math.PI * 2);
            ctx.strokeStyle = 'rgba(58, 123, 213, 0.5)';
            ctx.stroke();
        }

        // Generate random fingerprint for scanning mode
        function generateRandomFingerprint() {
            const data = [];
            for (let i = 0; i < SCANNER_WIDTH * SCANNER_HEIGHT; i++) {
                data.push(Math.random() * 255);
            }
            drawFingerprint(data);
            
            // Update stats with random values
            qualityValue.textContent = Math.round(Math.random() * 30 + 50) + '%';
            featuresValue.textContent = Math.round(Math.random() * 50 + 20);
        }

        // Log message
        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'log-time';
            timeSpan.textContent = `[${timestamp}]`;
            
            const messageSpan = document.createElement('span');
            messageSpan.className = `log-${type}`;
            messageSpan.textContent = ` ${message}`;
            
            logEntry.appendChild(timeSpan);
            logEntry.appendChild(messageSpan);
            logPanel.appendChild(logEntry);
            
            // Auto-scroll
            logPanel.scrollTop = logPanel.scrollHeight;
            
            // Limit log size
            const entries = logPanel.getElementsByClassName('log-entry');
            if (entries.length > 50) {
                logPanel.removeChild(entries[0]);
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            notification.textContent = message;
            notification.style.display = 'block';
            
            // Set border color based on type
            const colors = {
                info: '#3a7bd5',
                success: '#00b09b',
                error: '#ff416c',
                warning: '#f7971e'
            };
            notification.style.borderLeftColor = colors[type] || colors.info;
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Update image statistics
        function updateImageStatistics(data) {
            // This would be called from analyzeFingerprint
            // Placeholder for additional stats updates
        }

        // Helper functions
        function simulateDelay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
