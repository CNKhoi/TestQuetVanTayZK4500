<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZK4500 - Kiểm Tra Máy Quét Vân Tay</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Noto Sans', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 100%);
            color: #e0e1dd;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: rgba(26, 35, 53, 0.9);
            border-radius: 20px;
            padding: 25px 40px;
            margin-bottom: 30px;
            border: 2px solid #415a77;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #778da9;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header h1 i {
            color: #415a77;
        }

        .device-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .info-tag {
            background: rgba(65, 90, 119, 0.3);
            padding: 8px 20px;
            border-radius: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            border: 1px solid #415a77;
        }

        /* Main Layout */
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        /* Control Panel */
        .control-panel {
            background: rgba(26, 35, 53, 0.9);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #415a77;
            height: fit-content;
        }

        .panel-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.2rem;
            color: #778da9;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #415a77;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            font-size: 1.1rem;
        }

        /* Status Indicator */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(11, 19, 30, 0.7);
            border-radius: 10px;
            border: 1px solid #415a77;
        }

        .status-led {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #e63946;
            box-shadow: 0 0 10px #e63946;
            animation: pulse 2s infinite;
        }

        .status-led.ready {
            background: #2a9d8f;
            box-shadow: 0 0 15px #2a9d8f;
        }

        .status-led.scanning {
            background: #f4a261;
            box-shadow: 0 0 15px #f4a261;
            animation: scanning 1s infinite;
        }

        @keyframes scanning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .status-text {
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* Control Buttons */
        .control-grid {
            display: grid;
            gap: 12px;
        }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #415a77, #2d4363);
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(65, 90, 119, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2a9d8f, #21867a);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e63946, #d32f2f);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f4a261, #e68c3a);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #778da9, #5d7290);
        }

        /* Scanner Parameters */
        .param-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .param-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .param-label {
            font-size: 0.9rem;
            color: #a3b1c6;
        }

        .param-value {
            padding: 10px;
            background: rgba(11, 19, 30, 0.7);
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            border: 1px solid #415a77;
            font-weight: 600;
        }

        /* Scanner Display */
        .scanner-display {
            background: rgba(26, 35, 53, 0.9);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid #415a77;
            display: flex;
            flex-direction: column;
        }

        .display-area {
            flex: 1;
            background: #0b131e;
            border-radius: 12px;
            border: 3px solid #415a77;
            position: relative;
            overflow: hidden;
            min-height: 500px;
            margin-bottom: 20px;
        }

        #scannerCanvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: pointer;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .scanner-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px dashed rgba(65, 90, 119, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #778da9;
            text-align: center;
        }

        .scanner-guide i {
            font-size: 3rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .scan-progress {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            height: 6px;
            background: rgba(65, 90, 119, 0.3);
            border-radius: 3px;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #2a9d8f, #f4a261);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        /* Results Panel */
        .results-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .result-card {
            background: rgba(26, 35, 53, 0.9);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #415a77;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .result-title {
            color: #778da9;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .result-value {
            font-size: 1.8rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .quality-excellent { color: #2a9d8f; }
        .quality-good { color: #f4a261; }
        .quality-poor { color: #e63946; }

        .detail-list {
            list-style: none;
            margin-top: 15px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(65, 90, 119, 0.3);
            font-size: 0.95rem;
        }

        .detail-label {
            color: #a3b1c6;
        }

        .detail-value {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        /* Capture History */
        .capture-history {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .history-item {
            aspect-ratio: 1;
            background: rgba(11, 19, 30, 0.7);
            border-radius: 10px;
            border: 2px solid #415a77;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .history-item:hover {
            transform: scale(1.05);
            border-color: #2a9d8f;
            box-shadow: 0 5px 15px rgba(42, 157, 143, 0.3);
        }

        .history-item.active {
            border-color: #f4a261;
            box-shadow: 0 0 20px rgba(244, 162, 97, 0.4);
        }

        .history-item canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .history-index {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Log Console */
        .log-console {
            background: rgba(11, 19, 30, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            border: 1px solid #415a77;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            background: rgba(26, 35, 53, 0.5);
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .log-time {
            color: #778da9;
            flex-shrink: 0;
            min-width: 70px;
        }

        .log-message {
            flex: 1;
            word-break: break-word;
        }

        .log-success { color: #2a9d8f; }
        .log-error { color: #e63946; }
        .log-warning { color: #f4a261; }
        .log-info { color: #a3b1c6; }
        .log-scan { color: #4cc9f0; }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-fingerprint"></i> KIỂM TRA MÁY QUÉT VÂN TAY ZK4500</h1>
            <p style="color: #a3b1c6; margin-top: 10px;">Kiểm tra toàn diện chất lượng và chức năng máy quét vân tay</p>
            <div class="device-info">
                <span class="info-tag"><i class="fas fa-microchip"></i> Model: ZK4500</span>
                <span class="info-tag"><i class="fas fa-tachometer-alt"></i> Độ phân giải: 500 DPI</span>
                <span class="info-tag"><i class="fas fa-expand-alt"></i> Kích thước: 14.5×16.3mm</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Control Panel -->
            <div class="control-panel">
                <!-- Status Section -->
                <div class="panel-section">
                    <div class="section-title"><i class="fas fa-info-circle"></i> TRẠNG THÁI</div>
                    <div class="status-indicator">
                        <div id="statusLed" class="status-led"></div>
                        <div id="statusText" class="status-text">CHƯA KẾT NỐI</div>
                    </div>
                </div>

                <!-- Connection Section -->
                <div class="panel-section">
                    <div class="section-title"><i class="fas fa-plug"></i> KẾT NỐI</div>
                    <div class="control-grid">
                        <button id="connectBtn" class="btn btn-primary">
                            <i class="fas fa-link"></i> KẾT NỐI THIẾT BỊ
                        </button>
                        <button id="disconnectBtn" class="btn btn-danger" disabled>
                            <i class="fas fa-unlink"></i> NGẮT KẾT NỐI
                        </button>
                        <button id="testConnectionBtn" class="btn btn-secondary" disabled>
                            <i class="fas fa-wifi"></i> KIỂM TRA KẾT NỐI
                        </button>
                    </div>
                </div>

                <!-- Scanner Control Section -->
                <div class="panel-section">
                    <div class="section-title"><i class="fas fa-sliders-h"></i> ĐIỀU KHIỂN</div>
                    <div class="control-grid">
                        <button id="startScanBtn" class="btn btn-primary" disabled>
                            <i class="fas fa-play"></i> BẮT ĐẦU QUÉT
                        </button>
                        <button id="stopScanBtn" class="btn btn-danger" disabled>
                            <i class="fas fa-stop"></i> DỪNG QUÉT
                        </button>
                        <button id="singleCaptureBtn" class="btn btn-warning" disabled>
                            <i class="fas fa-camera"></i> CHỤP ẢNH ĐƠN
                        </button>
                        <button id="clearDisplayBtn" class="btn btn-secondary">
                            <i class="fas fa-eraser"></i> XÓA MÀN HÌNH
                        </button>
                    </div>
                </div>

                <!-- Hardware Test Section -->
                <div class="panel-section">
                    <div class="section-title"><i class="fas fa-tools"></i> KIỂM TRA PHẦN CỨNG</div>
                    <div class="control-grid">
                        <button id="testLedBtn" class="btn" disabled>
                            <i class="fas fa-lightbulb"></i> TEST ĐÈN
                        </button>
                        <button id="testBuzzerBtn" class="btn" disabled>
                            <i class="fas fa-volume-up"></i> TEST CÒI
                        </button>
                        <button id="getInfoBtn" class="btn" disabled>
                            <i class="fas fa-info-circle"></i> THÔNG TIN THIẾT BỊ
                        </button>
                    </div>
                </div>

                <!-- Scanner Parameters -->
                <div class="panel-section">
                    <div class="section-title"><i class="fas fa-cog"></i> THÔNG SỐ</div>
                    <div class="param-grid">
                        <div class="param-item">
                            <div class="param-label">Chất lượng ảnh</div>
                            <div id="qualityParam" class="param-value">0%</div>
                        </div>
                        <div class="param-item">
                            <div class="param-label">Độ sáng</div>
                            <div id="brightnessParam" class="param-value">50%</div>
                        </div>
                        <div class="param-item">
                            <div class="param-label">Độ tương phản</div>
                            <div id="contrastParam" class="param-value">70%</div>
                        </div>
                        <div class="param-item">
                            <div class="param-label">Tốc độ quét</div>
                            <div id="speedParam" class="param-value">Trung bình</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scanner Display -->
            <div class="scanner-display">
                <div class="section-title"><i class="fas fa-desktop"></i> MÀN HÌNH QUÉT VÂN TAY</div>
                
                <div class="display-area">
                    <canvas id="scannerCanvas"></canvas>
                    
                    <div class="scanner-overlay">
                        <div class="scanner-guide" id="scannerGuide">
                            <i class="fas fa-fingerprint"></i>
                            <div>Đặt ngón tay vào vùng này</div>
                            <div style="font-size: 0.8rem; margin-top: 5px;">(Nhấn để mô phỏng)</div>
                        </div>
                    </div>
                    
                    <div class="scan-progress" id="scanProgress">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>

                <div class="section-title mt-20"><i class="fas fa-chart-line"></i> KẾT QUẢ PHÂN TÍCH</div>
                
                <div class="results-panel">
                    <!-- Quality Result -->
                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-title">CHẤT LƯỢNG ẢNH</div>
                            <div id="qualityValue" class="result-value quality-poor">0%</div>
                        </div>
                        <ul class="detail-list">
                            <li class="detail-item">
                                <span class="detail-label">Độ sáng:</span>
                                <span id="detailBrightness" class="detail-value">0%</span>
                            </li>
                            <li class="detail-item">
                                <span class="detail-label">Độ tương phản:</span>
                                <span id="detailContrast" class="detail-value">0%</span>
                            </li>
                            <li class="detail-item">
                                <span class="detail-label">Độ nhiễu:</span>
                                <span id="detailNoise" class="detail-value">0%</span>
                            </li>
                        </ul>
                    </div>

                    <!-- Feature Result -->
                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-title">ĐẶC TRƯNG</div>
                            <div id="featureValue" class="result-value">0</div>
                        </div>
                        <ul class="detail-list">
                            <li class="detail-item">
                                <span class="detail-label">Điểm kết thúc:</span>
                                <span id="detailEndings" class="detail-value">0</span>
                            </li>
                            <li class="detail-item">
                                <span class="detail-label">Điểm rẽ nhánh:</span>
                                <span id="detailBifurcations" class="detail-value">0</span>
                            </li>
                            <li class="detail-item">
                                <span class="detail-label">Điểm đặc biệt:</span>
                                <span id="detailSpecial" class="detail-value">0</span>
                            </li>
                        </ul>
                    </div>

                    <!-- Capture Result -->
                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-title">THỜI GIAN</div>
                            <div id="timeValue" class="result-value">0.00s</div>
                        </div>
                        <ul class="detail-list">
                            <li class="detail-item">
                                <span class="detail-label">Thời gian quét:</span>
                                <span id="detailScanTime" class="detail-value">0.00s</span>
                            </li>
                            <li class="detail-item">
                                <span class="detail-label">Xử lý ảnh:</span>
                                <span id="detailProcessTime" class="detail-value">0.00s</span>
                            </li>
                            <li class="detail-item">
                                <span class="detail-label">Trích xuất đặc trưng:</span>
                                <span id="detailExtractTime" class="detail-value">0.00s</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Capture History -->
        <div class="capture-history">
            <div class="section-title"><i class="fas fa-history"></i> LỊCH SỬ QUÉT</div>
            <div id="historyGrid" class="history-grid">
                <!-- History items will be added here -->
            </div>
        </div>

        <!-- Log Console -->
        <div class="log-console" id="logConsole">
            <div class="log-entry">
                <span class="log-time">[SYSTEM]</span>
                <span class="log-message">Hệ thống kiểm tra ZK4500 đã sẵn sàng. Kết nối thiết bị để bắt đầu.</span>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const SCANNER_CONFIG = {
            width: 256,
            height: 288,
            dpi: 500,
            areaWidth: 14.5, // mm
            areaHeight: 16.3, // mm
            maxCaptures: 6
        };

        // State Management
        let state = {
            connected: false,
            scanning: false,
            capturing: false,
            currentImage: null,
            captures: [],
            lastQuality: 0,
            logEntries: []
        };

        // DOM Elements
        const elements = {
            // Status
            statusLed: document.getElementById('statusLed'),
            statusText: document.getElementById('statusText'),
            
            // Buttons
            connectBtn: document.getElementById('connectBtn'),
            disconnectBtn: document.getElementById('disconnectBtn'),
            testConnectionBtn: document.getElementById('testConnectionBtn'),
            startScanBtn: document.getElementById('startScanBtn'),
            stopScanBtn: document.getElementById('stopScanBtn'),
            singleCaptureBtn: document.getElementById('singleCaptureBtn'),
            clearDisplayBtn: document.getElementById('clearDisplayBtn'),
            testLedBtn: document.getElementById('testLedBtn'),
            testBuzzerBtn: document.getElementById('testBuzzerBtn'),
            getInfoBtn: document.getElementById('getInfoBtn'),
            
            // Display
            scannerCanvas: document.getElementById('scannerCanvas'),
            scannerGuide: document.getElementById('scannerGuide'),
            scanProgress: document.getElementById('scanProgress'),
            progressBar: document.getElementById('progressBar'),
            historyGrid: document.getElementById('historyGrid'),
            logConsole: document.getElementById('logConsole'),
            
            // Parameters
            qualityParam: document.getElementById('qualityParam'),
            brightnessParam: document.getElementById('brightnessParam'),
            contrastParam: document.getElementById('contrastParam'),
            speedParam: document.getElementById('speedParam'),
            
            // Results
            qualityValue: document.getElementById('qualityValue'),
            featureValue: document.getElementById('featureValue'),
            timeValue: document.getElementById('timeValue'),
            
            // Details
            detailBrightness: document.getElementById('detailBrightness'),
            detailContrast: document.getElementById('detailContrast'),
            detailNoise: document.getElementById('detailNoise'),
            detailEndings: document.getElementById('detailEndings'),
            detailBifurcations: document.getElementById('detailBifurcations'),
            detailSpecial: document.getElementById('detailSpecial'),
            detailScanTime: document.getElementById('detailScanTime'),
            detailProcessTime: document.getElementById('detailProcessTime'),
            detailExtractTime: document.getElementById('detailExtractTime')
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            log('Khởi tạo hệ thống kiểm tra ZK4500...', 'info');
            
            // Setup canvas
            setupCanvas();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initial UI state
            updateUI();
            
            log('Hệ thống sẵn sàng. Vui lòng kết nối thiết bị.', 'success');
        }

        function setupCanvas() {
            const canvas = elements.scannerCanvas;
            const ctx = canvas.getContext('2d');
            
            canvas.width = SCANNER_CONFIG.width;
            canvas.height = SCANNER_CONFIG.height;
            
            // Draw initial state
            ctx.fillStyle = '#0b131e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw scanner area outline
            ctx.strokeStyle = 'rgba(65, 90, 119, 0.5)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 3]);
            ctx.strokeRect(10, 10, canvas.width - 20, canvas.height - 20);
            ctx.setLineDash([]);
        }

        function setupEventListeners() {
            // Connection buttons
            elements.connectBtn.addEventListener('click', connectDevice);
            elements.disconnectBtn.addEventListener('click', disconnectDevice);
            elements.testConnectionBtn.addEventListener('click', testConnection);
            
            // Scanner control buttons
            elements.startScanBtn.addEventListener('click', startScanning);
            elements.stopScanBtn.addEventListener('click', stopScanning);
            elements.singleCaptureBtn.addEventListener('click', captureSingle);
            elements.clearDisplayBtn.addEventListener('click', clearDisplay);
            
            // Hardware test buttons
            elements.testLedBtn.addEventListener('click', testLED);
            elements.testBuzzerBtn.addEventListener('click', testBuzzer);
            elements.getInfoBtn.addEventListener('click', getDeviceInfo);
            
            // Canvas click for simulation
            elements.scannerCanvas.addEventListener('click', handleCanvasClick);
        }

        // ========== CONNECTION MANAGEMENT ==========
        async function connectDevice() {
            if (state.connected) return;
            
            log('Đang kết nối đến ZK4500...', 'info');
            updateStatus('Đang kết nối...', 'scanning');
            
            // Simulate connection process
            await simulateProcess([
                { message: 'Phát hiện thiết bị...', duration: 800 },
                { message: 'Thiết lập giao tiếp...', duration: 600 },
                { message: 'Khởi tạo máy quét...', duration: 700 },
                { message: 'Kiểm tra phần cứng...', duration: 500 }
            ]);
            
            state.connected = true;
            updateStatus('ĐÃ KẾT NỐI', 'ready');
            log('Thiết bị ZK4500 đã kết nối thành công!', 'success');
            
            // Enable scanner controls
            updateUI();
            
            // Get device info automatically
            setTimeout(getDeviceInfo, 300);
        }

        function disconnectDevice() {
            if (!state.connected) return;
            
            log('Đang ngắt kết nối thiết bị...', 'info');
            
            if (state.scanning) {
                stopScanning();
            }
            
            state.connected = false;
            state.currentImage = null;
            updateStatus('CHƯA KẾT NỐI', 'disconnected');
            
            log('Thiết bị đã ngắt kết nối.', 'info');
            updateUI();
            
            // Clear display
            clearDisplay();
        }

        function testConnection() {
            log('Kiểm tra kết nối thiết bị...', 'info');
            
            simulateProcess([
                { message: 'Kiểm tra giao tiếp USB...', duration: 400 },
                { message: 'Kiểm tra tín hiệu máy quét...', duration: 300 },
                { message: 'Kiểm tra tốc độ truyền dữ liệu...', duration: 400 }
            ]).then(() => {
                log('Kết nối ổn định. Thiết bị hoạt động bình thường.', 'success');
            });
        }

        // ========== SCANNER CONTROL ==========
        async function startScanning() {
            if (!state.connected || state.scanning) return;
            
            state.scanning = true;
            updateStatus('ĐANG QUÉT...', 'scanning');
            elements.scannerGuide.classList.add('hidden');
            elements.scanProgress.classList.remove('hidden');
            
            log('Bắt đầu chế độ quét liên tục...', 'scan');
            
            // Simulate scanning process
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                elements.progressBar.style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    captureAndAnalyze();
                    progress = 0;
                    elements.progressBar.style.width = '0%';
                    
                    // Continue scanning
                    if (state.scanning) {
                        setTimeout(() => startScanning(), 500);
                    }
                }
            }, 100);
        }

        function stopScanning() {
            if (!state.scanning) return;
            
            state.scanning = false;
            updateStatus('ĐÃ KẾT NỐI', 'ready');
            elements.scanProgress.classList.add('hidden');
            elements.scannerGuide.classList.remove('hidden');
            
            log('Đã dừng chế độ quét.', 'info');
        }

        async function captureSingle() {
            if (!state.connected || state.capturing) return;
            
            state.capturing = true;
            log('Bắt đầu chụp ảnh vân tay...', 'scan');
            
            // Show scanning progress
            elements.scannerGuide.classList.add('hidden');
            elements.scanProgress.classList.remove('hidden');
            
            await simulateCaptureProcess();
            
            elements.scanProgress.classList.add('hidden');
            state.capturing = false;
        }

        function handleCanvasClick(event) {
            if (!state.connected) {
                log('Vui lòng kết nối thiết bị trước.', 'warning');
                return;
            }
            
            // Check if click is within scanner area
            const rect = elements.scannerCanvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // Center area check
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
            
            if (distance < 100) {
                log('Phát hiện ngón tay trên máy quét...', 'scan');
                captureSingle();
            }
        }

        // ========== FINGERPRINT GENERATION & ANALYSIS ==========
        async function simulateCaptureProcess() {
            const startTime = Date.now();
            
            // Phase 1: Scanning (0-60%)
            for (let i = 0; i <= 60; i += 10) {
                elements.progressBar.style.width = `${i}%`;
                await delay(150);
            }
            
            // Phase 2: Image processing (60-80%)
            log('Đang xử lý hình ảnh...', 'info');
            for (let i = 60; i <= 80; i += 5) {
                elements.progressBar.style.width = `${i}%`;
                await delay(100);
            }
            
            // Phase 3: Feature extraction (80-100%)
            log('Đang trích xuất đặc trưng...', 'info');
            for (let i = 80; i <= 100; i += 5) {
                elements.progressBar.style.width = `${i}%`;
                await delay(80);
            }
            
            // Generate fingerprint
            const fingerprint = generateFingerprint();
            state.currentImage = fingerprint;
            
            // Draw to canvas
            drawFingerprint(fingerprint);
            
            // Analyze
            const analysis = analyzeFingerprint(fingerprint);
            const totalTime = (Date.now() - startTime) / 1000;
            
            // Update results
            updateResults(analysis, totalTime);
            
            // Add to history
            addToHistory(fingerprint, analysis);
            
            log(`Đã chụp ảnh vân tay thành công! Thời gian: ${totalTime.toFixed(2)}s`, 'success');
            
            // Reset progress
            setTimeout(() => {
                elements.progressBar.style.width = '0%';
                elements.scannerGuide.classList.remove('hidden');
            }, 500);
        }

        function generateFingerprint() {
            const data = new Array(SCANNER_CONFIG.width * SCANNER_CONFIG.height);
            
            // Generate fingerprint-like pattern
            for (let y = 0; y < SCANNER_CONFIG.height; y++) {
                for (let x = 0; x < SCANNER_CONFIG.width; x++) {
                    const idx = y * SCANNER_CONFIG.width + x;
                    
                    // Base noise
                    let value = Math.random() * 40 + 20;
                    
                    // Add ridge patterns (sine waves)
                    const ridgeX = Math.sin(x * 0.03) * 60;
                    const ridgeY = Math.sin(y * 0.02) * 40;
                    
                    // Add swirl pattern (center of fingerprint)
                    const centerX = SCANNER_CONFIG.width / 2;
                    const centerY = SCANNER_CONFIG.height / 2;
                    const dx = x - centerX;
                    const dy = y - centerY;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const swirl = Math.sin(distance * 0.1) * 30;
                    
                    // Combine patterns
                    value += ridgeX + ridgeY + swirl;
                    
                    // Add some minutiae points randomly
                    if (Math.random() < 0.002) {
                        value = Math.random() < 0.5 ? 10 : 240;
                    }
                    
                    // Clamp value
                    data[idx] = Math.max(0, Math.min(255, value));
                }
            }
            
            return data;
        }

        function drawFingerprint(data) {
            const canvas = elements.scannerCanvas;
            const ctx = canvas.getContext('2d');
            const imageData = ctx.createImageData(SCANNER_CONFIG.width, SCANNER_CONFIG.height);
            
            // Get current enhancement settings
            const brightness = parseInt(elements.brightnessParam.textContent) / 100;
            const contrast = parseInt(elements.contrastParam.textContent) / 100;
            
            for (let i = 0; i < data.length; i++) {
                let value = data[i];
                
                // Apply brightness and contrast
                value = applyEnhancement(value, brightness, contrast);
                
                const idx = i * 4;
                imageData.data[idx] = value;      // R
                imageData.data[idx + 1] = value;  // G
                imageData.data[idx + 2] = value;  // B
                imageData.data[idx + 3] = 255;    // A
            }
            
            ctx.putImageData(imageData, 0, 0);
        }

        function applyEnhancement(value, brightness, contrast) {
            // Adjust brightness
            let enhanced = value * brightness;
            
            // Adjust contrast
            const factor = (259 * (contrast * 255 + 255)) / (255 * (259 - contrast * 255));
            enhanced = factor * (enhanced - 128) + 128;
            
            return Math.max(0, Math.min(255, enhanced));
        }

        function analyzeFingerprint(data) {
            // Calculate basic statistics
            let sum = 0;
            let min = 255;
            let max = 0;
            
            for (const value of data) {
                sum += value;
                min = Math.min(min, value);
                max = Math.max(max, value);
            }
            
            const mean = sum / data.length;
            
            // Calculate variance and standard deviation
            let variance = 0;
            for (const value of data) {
                variance += Math.pow(value - mean, 2);
            }
            variance /= data.length;
            const stdDev = Math.sqrt(variance);
            
            // Calculate noise level (percentage of extreme values)
            let noise = 0;
            for (const value of data) {
                if (value < 20 || value > 235) noise++;
            }
            noise = (noise / data.length) * 100;
            
            // Calculate brightness (0-100%)
            const brightness = (mean / 255) * 100;
            
            // Calculate contrast (0-100%)
            const contrast = (stdDev / 128) * 100;
            
            // Calculate quality score
            const quality = calculateQualityScore(brightness, contrast, noise);
            
            // Count minutiae-like features
            const features = countFeatures(data);
            
            return {
                quality,
                brightness,
                contrast,
                noise,
                features,
                minutiae: features
            };
        }

        function calculateQualityScore(brightness, contrast, noise) {
            // Ideal brightness: 40-60%
            const brightnessScore = Math.max(0, 100 - Math.abs(brightness - 50) * 2);
            
            // Ideal contrast: >30%
            const contrastScore = Math.min(100, contrast * 2);
            
            // Noise penalty: <5% is good
            const noiseScore = Math.max(0, 100 - noise * 10);
            
            // Weighted average
            return Math.round(
                brightnessScore * 0.3 +
                contrastScore * 0.4 +
                noiseScore * 0.3
            );
        }

        function countFeatures(data) {
            // Simple feature detection
            let features = 0;
            
            // Detect ridge endings and bifurcations
            for (let y = 1; y < SCANNER_CONFIG.height - 1; y++) {
                for (let x = 1; x < SCANNER_CONFIG.width - 1; x++) {
                    const idx = y * SCANNER_CONFIG.width + x;
                    const value = data[idx];
                    
                    // Only check dark ridges
                    if (value < 100) {
                        // Check 8 neighbors
                        let darkNeighbors = 0;
                        for (let dy = -1; dy <= 1; dy++) {
                            for (let dx = -1; dx <= 1; dx++) {
                                if (dx === 0 && dy === 0) continue;
                                const nIdx = (y + dy) * SCANNER_CONFIG.width + (x + dx);
                                if (data[nIdx] < 100) darkNeighbors++;
                            }
                        }
                        
                        // Ridge ending (1 neighbor) or bifurcation (3+ neighbors)
                        if (darkNeighbors === 1 || darkNeighbors >= 3) {
                            features++;
                        }
                    }
                }
            }
            
            return Math.round(features / 10); // Scale down for display
        }

        function updateResults(analysis, totalTime) {
            // Update quality with color coding
            elements.qualityValue.textContent = `${analysis.quality}%`;
            elements.qualityValue.className = `result-value ${
                analysis.quality >= 80 ? 'quality-excellent' :
                analysis.quality >= 60 ? 'quality-good' : 'quality-poor'
            }`;
            
            // Update feature count
            elements.featureValue.textContent = analysis.features;
            
            // Update time
            elements.timeValue.textContent = `${totalTime.toFixed(2)}s`;
            
            // Update details
            elements.detailBrightness.textContent = `${Math.round(analysis.brightness)}%`;
            elements.detailContrast.textContent = `${Math.round(analysis.contrast)}%`;
            elements.detailNoise.textContent = `${analysis.noise.toFixed(1)}%`;
            elements.detailEndings.textContent = Math.round(analysis.features * 0.6);
            elements.detailBifurcations.textContent = Math.round(analysis.features * 0.3);
            elements.detailSpecial.textContent = Math.round(analysis.features * 0.1);
            elements.detailScanTime.textContent = `${(totalTime * 0.6).toFixed(2)}s`;
            elements.detailProcessTime.textContent = `${(totalTime * 0.25).toFixed(2)}s`;
            elements.detailExtractTime.textContent = `${(totalTime * 0.15).toFixed(2)}s`;
            
            // Update parameters
            elements.qualityParam.textContent = `${analysis.quality}%`;
        }

        // ========== HISTORY MANAGEMENT ==========
        function addToHistory(fingerprintData, analysis) {
            // Create thumbnail canvas
            const thumbCanvas = document.createElement('canvas');
            thumbCanvas.width = 80;
            thumbCanvas.height = 80;
            const thumbCtx = thumbCanvas.getContext('2d');
            
            // Draw scaled fingerprint
            const imageData = thumbCtx.createImageData(80, 80);
            const scale = 80 / SCANNER_CONFIG.width;
            
            for (let y = 0; y < 80; y++) {
                for (let x = 0; x < 80; x++) {
                    const srcX = Math.floor(x / scale);
                    const srcY = Math.floor(y / scale);
                    const srcIdx = srcY * SCANNER_CONFIG.width + srcX;
                    const dstIdx = (y * 80 + x) * 4;
                    
                    const value = fingerprintData[srcIdx];
                    imageData.data[dstIdx] = value;
                    imageData.data[dstIdx + 1] = value;
                    imageData.data[dstIdx + 2] = value;
                    imageData.data[dstIdx + 3] = 255;
                }
            }
            
            thumbCtx.putImageData(imageData, 0, 0);
            
            // Create history item
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.innerHTML = `
                <canvas width="80" height="80"></canvas>
                <div class="history-index">${state.captures.length + 1}</div>
            `;
            
            // Draw on item's canvas
            const itemCanvas = historyItem.querySelector('canvas');
            const itemCtx = itemCanvas.getContext('2d');
            itemCtx.drawImage(thumbCanvas, 0, 0);
            
            // Add click handler
            historyItem.addEventListener('click', () => {
                // Remove active class from all items
                document.querySelectorAll('.history-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Set this item as active
                historyItem.classList.add('active');
                
                // Display this fingerprint
                drawFingerprint(fingerprintData);
                updateResults(analysis, parseFloat(elements.timeValue.textContent));
                
                log(`Đã tải ảnh vân tay #${state.captures.length + 1}`, 'info');
            });
            
            // Add to grid
            elements.historyGrid.prepend(historyItem);
            
            // Store in state
            state.captures.unshift({
                data: fingerprintData,
                analysis: analysis,
                timestamp: new Date(),
                thumbnail: thumbCanvas.toDataURL()
            });
            
            // Limit history size
            if (state.captures.length > SCANNER_CONFIG.maxCaptures) {
                state.captures.pop();
                if (elements.historyGrid.lastChild) {
                    elements.historyGrid.removeChild(elements.historyGrid.lastChild);
                }
            }
        }

        // ========== HARDWARE TESTING ==========
        async function testLED() {
            log('Kiểm tra đèn máy quét...', 'info');
            
            // Visual feedback
            const canvas = elements.scannerCanvas;
            const originalBorder = canvas.style.borderColor;
            
            canvas.style.borderColor = '#f4a261';
            canvas.style.boxShadow = '0 0 20px #f4a261';
            
            await delay(1000);
            
            canvas.style.borderColor = originalBorder;
            canvas.style.boxShadow = '';
            
            log('Đèn máy quét hoạt động bình thường.', 'success');
        }

        async function testBuzzer() {
            log('Kiểm tra còi báo hiệu...', 'info');
            
            try {
                // Try to play beep sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 1000;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.1;
                
                oscillator.start();
                
                await delay(300);
                oscillator.stop();
                
                log('Còi báo hiệu hoạt động bình thường.', 'success');
            } catch (error) {
                log('Còi báo hiệu (mô phỏng)', 'warning');
            }
        }

        async function getDeviceInfo() {
            log('Đang lấy thông tin thiết bị...', 'info');
            
            const deviceInfo = {
                model: 'ZK4500',
                serial: 'ZK' + Date.now().toString().slice(-6),
                firmware: 'V2.1.4',
                resolution: '500 DPI',
                scanningArea: '14.5×16.3 mm',
                interface: 'USB 2.0',
                templateSize: '256 bytes',
                maxTemplates: '3000',
                securityLevel: '5'
            };
            
            await simulateProcess([
                { message: 'Đang đọc thông số kỹ thuật...', duration: 400 },
                { message: 'Đang kiểm tra phiên bản firmware...', duration: 300 },
                { message: 'Đang xác nhận cấu hình...', duration: 400 }
            ]);
            
            log(`Model: ${deviceInfo.model}`, 'info');
            log(`Serial: ${deviceInfo.serial}`, 'info');
            log(`Firmware: ${deviceInfo.firmware}`, 'info');
            log(`Độ phân giải: ${deviceInfo.resolution}`, 'info');
            log(`Vùng quét: ${deviceInfo.scanningArea}`, 'info');
            log(`Dung lượng: ${deviceInfo.maxTemplates} mẫu`, 'info');
            
            log('Đã nhận thông tin thiết bị đầy đủ.', 'success');
        }

        // ========== UI MANAGEMENT ==========
        function updateStatus(text, status) {
            elements.statusText.textContent = text;
            elements.statusLed.className = 'status-led';
            
            switch (status) {
                case 'ready':
                    elements.statusLed.classList.add('ready');
                    break;
                case 'scanning':
                    elements.statusLed.classList.add('scanning');
                    break;
                case 'disconnected':
                    // Default red state
                    break;
            }
        }

        function updateUI() {
            const connected = state.connected;
            
            // Connection buttons
            elements.connectBtn.disabled = connected;
            elements.disconnectBtn.disabled = !connected;
            elements.testConnectionBtn.disabled = !connected;
            
            // Scanner buttons
            elements.startScanBtn.disabled = !connected || state.scanning;
            elements.stopScanBtn.disabled = !connected || !state.scanning;
            elements.singleCaptureBtn.disabled = !connected || state.capturing;
            
            // Hardware test buttons
            elements.testLedBtn.disabled = !connected;
            elements.testBuzzerBtn.disabled = !connected;
            elements.getInfoBtn.disabled = !connected;
        }

        function clearDisplay() {
            const canvas = elements.scannerCanvas;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#0b131e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Redraw scanner outline
            ctx.strokeStyle = 'rgba(65, 90, 119, 0.5)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 3]);
            ctx.strokeRect(10, 10, canvas.width - 20, canvas.height - 20);
            ctx.setLineDash([]);
            
            // Reset results
            elements.qualityValue.textContent = '0%';
            elements.qualityValue.className = 'result-value quality-poor';
            elements.featureValue.textContent = '0';
            elements.timeValue.textContent = '0.00s';
            
            // Reset details
            elements.detailBrightness.textContent = '0%';
            elements.detailContrast.textContent = '0%';
            elements.detailNoise.textContent = '0%';
            elements.detailEndings.textContent = '0';
            elements.detailBifurcations.textContent = '0';
            elements.detailSpecial.textContent = '0';
            elements.detailScanTime.textContent = '0.00s';
            elements.detailProcessTime.textContent = '0.00s';
            elements.detailExtractTime.textContent = '0.00s';
            
            // Show guide
            elements.scannerGuide.classList.remove('hidden');
            elements.scanProgress.classList.add('hidden');
            
            log('Đã xóa màn hình hiển thị.', 'info');
        }

        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            logEntry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="log-message log-${type}">${message}</span>
            `;
            
            elements.logConsole.appendChild(logEntry);
            elements.logConsole.scrollTop = elements.logConsole.scrollHeight;
            
            // Limit log size
            const entries = elements.logConsole.querySelectorAll('.log-entry');
            if (entries.length > 50) {
                elements.logConsole.removeChild(entries[0]);
            }
            
            // Store in state
            state.logEntries.push({ time, message, type });
        }

        // ========== UTILITY FUNCTIONS ==========
        async function simulateProcess(steps) {
            for (const step of steps) {
                log(step.message, 'info');
                await delay(step.duration);
            }
        }

        async function simulateCaptureAndAnalyze() {
            // This is called from scanning mode
            await simulateCaptureProcess();
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
