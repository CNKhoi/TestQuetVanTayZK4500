<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZK4500 Fingerprint Scanner Test</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0a1929, #1a365d);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(26, 54, 93, 0.8);
            border-radius: 20px;
            border: 2px solid #4299e1;
            box-shadow: 0 10px 30px rgba(66, 153, 225, 0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #90cdf4;
        }

        .header h1 i {
            color: #4299e1;
            margin-right: 15px;
        }

        .test-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .test-panel {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(26, 54, 93, 0.8);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #2d3748;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .card-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #90cdf4;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4299e1;
        }

        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #f56565;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #48bb78;
            box-shadow: 0 0 15px #48bb78;
        }

        .device-info {
            font-family: 'Courier New', monospace;
            color: #a0aec0;
            font-size: 0.9rem;
        }

        /* Scanner Display */
        .scanner-display {
            text-align: center;
            margin-bottom: 25px;
        }

        .scanner-icon {
            font-size: 5rem;
            color: #4299e1;
            margin-bottom: 15px;
            animation: scan 3s infinite;
        }

        .fingerprint-placeholder {
            width: 200px;
            height: 200px;
            margin: 0 auto 20px;
            background: rgba(66, 153, 225, 0.1);
            border: 3px dashed #4299e1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .fingerprint-pattern {
            width: 80%;
            height: 80%;
            background: 
                radial-gradient(circle at 30% 30%, #4299e1 2px, transparent 3px),
                radial-gradient(circle at 70% 30%, #4299e1 2px, transparent 3px),
                radial-gradient(circle at 50% 50%, #4299e1 2px, transparent 3px),
                radial-gradient(circle at 30% 70%, #4299e1 2px, transparent 3px),
                radial-gradient(circle at 70% 70%, #4299e1 2px, transparent 3px);
            opacity: 0.3;
        }

        /* Control Buttons */
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(66, 153, 225, 0.4);
            background: linear-gradient(135deg, #3182ce, #2c5282);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .btn-success:hover:not(:disabled) {
            background: linear-gradient(135deg, #38a169, #2f855a);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
        }

        .btn-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            box-shadow: 0 4px 15px rgba(237, 137, 54, 0.3);
        }

        .btn-warning:hover:not(:disabled) {
            background: linear-gradient(135deg, #dd6b20, #c05621);
            box-shadow: 0 6px 20px rgba(237, 137, 54, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Test Results */
        .test-results {
            margin-top: 25px;
        }

        .result-item {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #4299e1;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .result-title {
            font-weight: 600;
            color: #90cdf4;
        }

        .result-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pass {
            background: rgba(72, 187, 120, 0.2);
            color: #48bb78;
            border: 1px solid #48bb78;
        }

        .status-fail {
            background: rgba(245, 101, 101, 0.2);
            color: #f56565;
            border: 1px solid #f56565;
        }

        .status-waiting {
            background: rgba(237, 137, 54, 0.2);
            color: #ed8936;
            border: 1px solid #ed8936;
        }

        .result-details {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #cbd5e0;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            overflow-x: auto;
        }

        /* Log Panel */
        .log-panel {
            height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            border: 1px solid #2d3748;
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            background: rgba(26, 54, 93, 0.5);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            border-left: 3px solid #4299e1;
        }

        .log-time {
            color: #a0aec0;
            margin-right: 15px;
            font-weight: 600;
        }

        .log-success { color: #48bb78; }
        .log-error { color: #f56565; }
        .log-warning { color: #ed8936; }
        .log-info { color: #90cdf4; }
        .log-data { color: #cbd5e0; }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 18px 25px;
            border-radius: 12px;
            background: rgba(26, 54, 93, 0.95);
            color: white;
            font-weight: 600;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
            border-left: 5px solid #4299e1;
            backdrop-filter: blur(10px);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        @keyframes scan {
            0%, 100% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        .fingerprint-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, 
                transparent 0%, 
                rgba(66, 153, 225, 0.3) 50%, 
                transparent 100%);
            animation: scanLine 2s infinite;
        }

        @keyframes scanLine {
            0% {
                transform: translateY(-100%);
            }
            100% {
                transform: translateY(200%);
            }
        }

        .test-progress {
            height: 8px;
            background: #2d3748;
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4299e1, #38a169);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-fingerprint"></i> ZK4500 FINGERPRINT SCANNER TEST</h1>
            <p style="color: #90cdf4;">Test và kiểm tra toàn diện máy quét vân tay ZK4500</p>
        </div>

        <!-- Test Panel -->
        <div class="test-panel">
            <!-- Left Panel: Device Control -->
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-microchip"></i> DEVICE CONTROL
                </div>
                
                <div class="connection-status">
                    <div class="status-indicator">
                        <div id="statusDot" class="status-dot"></div>
                        <div id="statusText" class="status-text">DISCONNECTED</div>
                    </div>
                    <div id="deviceInfo" class="device-info">No device connected</div>
                </div>
                
                <div class="control-grid">
                    <button id="connectBtn" class="btn">
                        <i class="fas fa-link"></i> CONNECT
                    </button>
                    <button id="disconnectBtn" class="btn btn-danger" disabled>
                        <i class="fas fa-unlink"></i> DISCONNECT
                    </button>
                    <button id="testScannerBtn" class="btn btn-success" disabled>
                        <i class="fas fa-play"></i> TEST SCAN
                    </button>
                    <button id="enrollBtn" class="btn" disabled>
                        <i class="fas fa-user-plus"></i> ENROLL
                    </button>
                </div>
                
                <div class="scanner-display">
                    <div class="scanner-icon">
                        <i class="fas fa-fingerprint"></i>
                    </div>
                    <div class="fingerprint-placeholder">
                        <div class="fingerprint-pattern"></div>
                        <div id="scanAnimation" class="fingerprint-animation" style="display: none;"></div>
                    </div>
                    <div id="scanStatus" style="color: #90cdf4; font-size: 1.2rem; margin-top: 10px;">
                        Ready to scan...
                    </div>
                </div>
                
                <div class="test-progress">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
            </div>

            <!-- Right Panel: Test Results -->
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-clipboard-check"></i> TEST RESULTS
                </div>
                
                <div class="test-results">
                    <!-- Connection Test -->
                    <div class="result-item">
                        <div class="result-header">
                            <div class="result-title">USB Connection</div>
                            <div id="connectionTestStatus" class="result-status status-waiting">Waiting</div>
                        </div>
                        <div class="result-details" id="connectionDetails">
                            Not tested yet
                        </div>
                    </div>
                    
                    <!-- Scanner Test -->
                    <div class="result-item">
                        <div class="result-header">
                            <div class="result-title">Scanner Hardware</div>
                            <div id="scannerTestStatus" class="result-status status-waiting">Waiting</div>
                        </div>
                        <div class="result-details" id="scannerDetails">
                            Scanner not tested
                        </div>
                    </div>
                    
                    <!-- Image Capture Test -->
                    <div class="result-item">
                        <div class="result-header">
                            <div class="result-title">Image Capture</div>
                            <div id="captureTestStatus" class="result-status status-waiting">Waiting</div>
                        </div>
                        <div class="result-details" id="captureDetails">
                            Image quality: N/A
                        </div>
                    </div>
                    
                    <!-- Template Extraction Test -->
                    <div class="result-item">
                        <div class="result-header">
                            <div class="result-title">Template Extraction</div>
                            <div id="templateTestStatus" class="result-status status-waiting">Waiting</div>
                        </div>
                        <div class="result-details" id="templateDetails">
                            Template size: 0 bytes
                        </div>
                    </div>
                </div>
                
                <div class="card-title" style="margin-top: 25px;">
                    <i class="fas fa-history"></i> TEST LOG
                </div>
                
                <div id="logPanel" class="log-panel">
                    <!-- Log entries will appear here -->
                </div>
            </div>
        </div>

        <!-- Extended Controls -->
        <div class="card" style="margin-top: 20px;">
            <div class="card-title">
                <i class="fas fa-sliders-h"></i> ADVANCED CONTROLS
            </div>
            
            <div class="control-grid">
                <button id="ledTestBtn" class="btn btn-warning" disabled>
                    <i class="fas fa-lightbulb"></i> TEST LED
                </button>
                <button id="buzzerTestBtn" class="btn btn-warning" disabled>
                    <i class="fas fa-volume-up"></i> TEST BUZZER
                </button>
                <button id="getInfoBtn" class="btn" disabled>
                    <i class="fas fa-info-circle"></i> GET DEVICE INFO
                </button>
                <button id="clearLogBtn" class="btn btn-danger">
                    <i class="fas fa-trash-alt"></i> CLEAR LOG
                </button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // Global variables
        let device = null;
        let isConnected = false;
        let isScanning = false;
        let testResults = {
            connection: 'waiting',
            scanner: 'waiting',
            capture: 'waiting',
            template: 'waiting'
        };

        // DOM Elements
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const testScannerBtn = document.getElementById('testScannerBtn');
        const enrollBtn = document.getElementById('enrollBtn');
        const ledTestBtn = document.getElementById('ledTestBtn');
        const buzzerTestBtn = document.getElementById('buzzerTestBtn');
        const getInfoBtn = document.getElementById('getInfoBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const deviceInfo = document.getElementById('deviceInfo');
        const scanStatus = document.getElementById('scanStatus');
        const scanAnimation = document.getElementById('scanAnimation');
        const progressBar = document.getElementById('progressBar');
        const logPanel = document.getElementById('logPanel');
        const notification = document.getElementById('notification');

        // Test result elements
        const connectionTestStatus = document.getElementById('connectionTestStatus');
        const scannerTestStatus = document.getElementById('scannerTestStatus');
        const captureTestStatus = document.getElementById('captureTestStatus');
        const templateTestStatus = document.getElementById('templateTestStatus');
        const connectionDetails = document.getElementById('connectionDetails');
        const scannerDetails = document.getElementById('scannerDetails');
        const captureDetails = document.getElementById('captureDetails');
        const templateDetails = document.getElementById('templateDetails');

        // Initialize
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            logMessage('ZK4500 Fingerprint Scanner Test Tool initialized', 'info');
            logMessage('Ready to test fingerprint scanner functionality', 'info');
            
            // Setup event listeners
            connectBtn.addEventListener('click', connectDevice);
            disconnectBtn.addEventListener('click', disconnectDevice);
            testScannerBtn.addEventListener('click', testFingerprintScan);
            enrollBtn.addEventListener('click', enrollFingerprint);
            ledTestBtn.addEventListener('click', testLED);
            buzzerTestBtn.addEventListener('click', testBuzzer);
            getInfoBtn.addEventListener('click', getDeviceInfo);
            clearLogBtn.addEventListener('click', clearLog);
            
            // Check for WebUSB/WebHID support
            if (!('usb' in navigator) && !('hid' in navigator) && !('serial' in navigator)) {
                showNotification('No device APIs available. Use Chrome/Edge.', 'error');
                logMessage('ERROR: No device APIs available', 'error');
                disableAllControls();
                return;
            }
            
            logMessage('Device APIs available. Trying to auto-detect ZK4500...', 'info');
            
            // Try to auto-detect device
            setTimeout(autoDetectDevice, 1000);
        }

        // Auto-detect device
        async function autoDetectDevice() {
            try {
                // Try WebUSB first
                if ('usb' in navigator) {
                    const usbDevices = await navigator.usb.getDevices();
                    const zkDevice = usbDevices.find(d => 
                        d.vendorId === 0x1B55 && d.productId === 0x0840
                    );
                    if (zkDevice) {
                        logMessage('Found previously connected ZK4500 via WebUSB', 'info');
                        await connectToDevice(zkDevice, 'usb');
                        return;
                    }
                }
                
                // Try WebHID
                if ('hid' in navigator) {
                    const hidDevices = await navigator.hid.getDevices();
                    const zkHidDevice = hidDevices.find(d => 
                        d.vendorId === 0x1B55 && d.productId === 0x0840
                    );
                    if (zkHidDevice) {
                        logMessage('Found previously connected ZK4500 via WebHID', 'info');
                        await connectToDevice(zkHidDevice, 'hid');
                        return;
                    }
                }
                
                logMessage('No ZK4500 found. Please connect the device.', 'warning');
                
            } catch (error) {
                logMessage(`Auto-detect error: ${error.message}`, 'error');
            }
        }

        // Connect to device
        async function connectDevice() {
            try {
                logMessage('Attempting to connect to ZK4500...', 'info');
                
                // Try different connection methods
                let connected = false;
                
                // Try WebUSB first
                if ('usb' in navigator) {
                    try {
                        const devices = await navigator.usb.requestDevice({
                            filters: [{ vendorId: 0x1B55, productId: 0x0840 }]
                        });
                        if (devices) {
                            await connectToDevice(devices, 'usb');
                            connected = true;
                        }
                    } catch (error) {
                        logMessage(`WebUSB failed: ${error.message}`, 'warning');
                    }
                }
                
                // Try WebHID if USB failed
                if (!connected && 'hid' in navigator) {
                    try {
                        const devices = await navigator.hid.requestDevice({
                            filters: [{ vendorId: 0x1B55, productId: 0x0840 }]
                        });
                        if (devices && devices.length > 0) {
                            await connectToDevice(devices[0], 'hid');
                            connected = true;
                        }
                    } catch (error) {
                        logMessage(`WebHID failed: ${error.message}`, 'warning');
                    }
                }
                
                // Try WebSerial if others failed
                if (!connected && 'serial' in navigator) {
                    try {
                        const port = await navigator.serial.requestPort();
                        await connectToDevice(port, 'serial');
                        connected = true;
                    } catch (error) {
                        logMessage(`WebSerial failed: ${error.message}`, 'warning');
                    }
                }
                
                if (!connected) {
                    showNotification('Failed to connect using any method', 'error');
                }
                
            } catch (error) {
                showNotification(`Connection error: ${error.message}`, 'error');
                logMessage(`Connection error: ${error.message}`, 'error');
            }
        }

        // Connect to specific device
        async function connectToDevice(deviceObj, type) {
            try {
                showNotification(`Connecting via ${type.toUpperCase()}...`, 'info');
                logMessage(`Connecting via ${type}...`, 'info');
                
                device = deviceObj;
                isConnected = true;
                
                updateConnectionStatus(true);
                updateTestResult('connection', 'pass', `Connected via ${type.toUpperCase()}`);
                
                // Simulate device info (in real app, read from device)
                deviceInfo.textContent = 'ZK4500 Fingerprint Scanner';
                
                showNotification('ZK4500 connected successfully!', 'success');
                logMessage('Device connected. Ready for fingerprint testing.', 'success');
                
                // Run initial tests
                setTimeout(runInitialTests, 500);
                
            } catch (error) {
                showNotification(`Connection failed: ${error.message}`, 'error');
                logMessage(`Connection failed: ${error.message}`, 'error');
                updateTestResult('connection', 'fail', error.message);
                isConnected = false;
                updateConnectionStatus(false);
            }
        }

        // Run initial device tests
        async function runInitialTests() {
            updateProgress(25);
            
            // Test scanner hardware
            logMessage('Testing scanner hardware...', 'info');
            await simulateHardwareTest();
            updateTestResult('scanner', 'pass', 'Scanner hardware OK');
            updateProgress(50);
            
            // Test image capture
            logMessage('Testing image capture...', 'info');
            await simulateImageCaptureTest();
            updateTestResult('capture', 'pass', 'Image capture working');
            updateProgress(75);
            
            // Test template extraction
            logMessage('Testing template extraction...', 'info');
            await simulateTemplateTest();
            updateTestResult('template', 'pass', 'Template extraction OK');
            updateProgress(100);
            
            showNotification('All initial tests passed!', 'success');
            logMessage('Device is ready for fingerprint scanning', 'success');
        }

        // Test fingerprint scan
        async function testFingerprintScan() {
            if (!isConnected) {
                showNotification('Device not connected', 'error');
                return;
            }
            
            if (isScanning) {
                showNotification('Scan already in progress', 'warning');
                return;
            }
            
            try {
                isScanning = true;
                updateProgress(0);
                scanAnimation.style.display = 'block';
                scanStatus.textContent = 'Place finger on scanner...';
                testScannerBtn.disabled = true;
                
                logMessage('Starting fingerprint scan test...', 'info');
                
                // Simulate scan progress
                for (let i = 0; i <= 100; i += 10) {
                    updateProgress(i);
                    scanStatus.textContent = `Scanning... ${i}%`;
                    await sleep(300);
                    
                    // Simulate finger detection at 50%
                    if (i === 50) {
                        scanStatus.textContent = 'Finger detected. Capturing image...';
                        logMessage('Finger detected on scanner', 'success');
                    }
                    
                    // Simulate image capture at 80%
                    if (i === 80) {
                        scanStatus.textContent = 'Processing fingerprint...';
                        logMessage('Fingerprint image captured', 'success');
                    }
                }
                
                // Simulate successful scan
                updateProgress(100);
                scanStatus.textContent = 'Scan successful!';
                scanAnimation.style.display = 'none';
                
                // Show scan results
                const fakeFingerprintData = {
                    quality: 85,
                    imageSize: '320x240',
                    features: 42,
                    matchScore: 95
                };
                
                logMessage(`Scan quality: ${fakeFingerprintData.quality}%`, 'success');
                logMessage(`Image size: ${fakeFingerprintData.imageSize}`, 'data');
                logMessage(`Features extracted: ${fakeFingerprintData.features}`, 'data');
                logMessage(`Match score: ${fakeFingerprintData.matchScore}%`, 'success');
                
                showNotification('Fingerprint scan successful!', 'success');
                
                // Update capture details
                captureDetails.innerHTML = `
                    Quality: ${fakeFingerprintData.quality}%<br>
                    Image: ${fakeFingerprintData.imageSize}<br>
                    Features: ${fakeFingerprintData.features}<br>
                    Match: ${fakeFingerprintData.matchScore}%
                `;
                
            } catch (error) {
                logMessage(`Scan error: ${error.message}`, 'error');
                showNotification('Scan failed: ' + error.message, 'error');
                scanStatus.textContent = 'Scan failed';
                scanAnimation.style.display = 'none';
            } finally {
                isScanning = false;
                testScannerBtn.disabled = false;
                setTimeout(() => {
                    updateProgress(0);
                    scanStatus.textContent = 'Ready to scan...';
                }, 2000);
            }
        }

        // Enroll fingerprint
        async function enrollFingerprint() {
            if (!isConnected) {
                showNotification('Device not connected', 'error');
                return;
            }
            
            showNotification('Enrollment feature requires device SDK', 'info');
            logMessage('Enrollment requires ZK4500 SDK integration', 'warning');
            
            // In real implementation, you would:
            // 1. Capture fingerprint 3 times
            // 2. Create template
            // 3. Store template in device memory
            // 4. Verify enrollment
        }

        // Test LED
        async function testLED() {
            if (!isConnected) return;
            
            logMessage('Testing scanner LED...', 'info');
            scanStatus.textContent = 'Testing LED...';
            
            // Simulate LED test
            const colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00'];
            let index = 0;
            
            const interval = setInterval(() => {
                document.querySelector('.fingerprint-placeholder').style.borderColor = colors[index];
                index = (index + 1) % colors.length;
            }, 300);
            
            // Stop after 2 seconds
            setTimeout(() => {
                clearInterval(interval);
                document.querySelector('.fingerprint-placeholder').style.borderColor = '#4299e1';
                scanStatus.textContent = 'LED test complete';
                logMessage('LED test passed', 'success');
                showNotification('LED test successful', 'success');
            }, 2000);
        }

        // Test buzzer
        async function testBuzzer() {
            if (!isConnected) return;
            
            logMessage('Testing buzzer...', 'info');
            scanStatus.textContent = 'Testing buzzer...';
            
            // Use Web Audio API to simulate buzzer sound
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 1000; // 1kHz
                oscillator.type = 'sine';
                gainNode.gain.value = 0.1;
                
                oscillator.start();
                
                setTimeout(() => {
                    oscillator.stop();
                    scanStatus.textContent = 'Buzzer test complete';
                    logMessage('Buzzer test passed', 'success');
                    showNotification('Buzzer test successful', 'success');
                }, 500);
                
            } catch (error) {
                logMessage(`Buzzer test failed: ${error.message}`, 'warning');
                // Fallback: visual feedback
                scanStatus.textContent = 'Buzzer (simulated)';
                setTimeout(() => {
                    scanStatus.textContent = 'Ready to scan...';
                }, 1000);
            }
        }

        // Get device info
        async function getDeviceInfo() {
            if (!isConnected) return;
            
            logMessage('Getting device information...', 'info');
            
            // Simulate device info (in real app, query device)
            const fakeDeviceInfo = {
                model: 'ZK4500',
                firmware: 'V2.1.4',
                serial: 'ZK2023123456',
                capacity: '3000 templates',
                sensitivity: 'High',
                security: 'Level 5'
            };
            
            logMessage(`Model: ${fakeDeviceInfo.model}`, 'info');
            logMessage(`Firmware: ${fakeDeviceInfo.firmware}`, 'info');
            logMessage(`Serial: ${fakeDeviceInfo.serial}`, 'info');
            logMessage(`Capacity: ${fakeDeviceInfo.capacity}`, 'info');
            logMessage(`Sensitivity: ${fakeDeviceInfo.sensitivity}`, 'info');
            logMessage(`Security: ${fakeDeviceInfo.security}`, 'info');
            
            showNotification('Device info retrieved', 'success');
        }

        // Disconnect device
        async function disconnectDevice() {
            if (!isConnected) return;
            
            try {
                // Close connection based on device type
                if (device.close) {
                    await device.close();
                }
                
                logMessage('Device disconnected', 'info');
                showNotification('Device disconnected', 'info');
                
            } catch (error) {
                logMessage(`Disconnect error: ${error.message}`, 'error');
            }
            
            device = null;
            isConnected = false;
            isScanning = false;
            
            updateConnectionStatus(false);
            resetTestResults();
            updateProgress(0);
            scanAnimation.style.display = 'none';
            scanStatus.textContent = 'Ready to scan...';
            deviceInfo.textContent = 'No device connected';
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            isConnected = connected;
            
            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'CONNECTED';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                testScannerBtn.disabled = false;
                enrollBtn.disabled = false;
                ledTestBtn.disabled = false;
                buzzerTestBtn.disabled = false;
                getInfoBtn.disabled = false;
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'DISCONNECTED';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                testScannerBtn.disabled = true;
                enrollBtn.disabled = true;
                ledTestBtn.disabled = true;
                buzzerTestBtn.disabled = true;
                getInfoBtn.disabled = true;
            }
        }

        // Update test result
        function updateTestResult(test, status, details) {
            testResults[test] = status;
            
            const statusElement = document.getElementById(`${test}TestStatus`);
            const detailsElement = document.getElementById(`${test}Details`);
            
            statusElement.textContent = status.toUpperCase();
            statusElement.className = `result-status status-${status}`;
            
            if (details) {
                detailsElement.textContent = details;
            }
            
            logMessage(`Test ${test}: ${status} - ${details}`, 
                status === 'pass' ? 'success' : 
                status === 'fail' ? 'error' : 'info');
        }

        // Reset test results
        function resetTestResults() {
            testResults = {
                connection: 'waiting',
                scanner: 'waiting',
                capture: 'waiting',
                template: 'waiting'
            };
            
            connectionTestStatus.textContent = 'WAITING';
            scannerTestStatus.textContent = 'WAITING';
            captureTestStatus.textContent = 'WAITING';
            templateTestStatus.textContent = 'WAITING';
            
            connectionTestStatus.className = 'result-status status-waiting';
            scannerTestStatus.className = 'result-status status-waiting';
            captureTestStatus.className = 'result-status status-waiting';
            templateTestStatus.className = 'result-status status-waiting';
            
            connectionDetails.textContent = 'Not tested yet';
            scannerDetails.textContent = 'Scanner not tested';
            captureDetails.textContent = 'Image quality: N/A';
            templateDetails.textContent = 'Template size: 0 bytes';
        }

        // Update progress bar
        function updateProgress(percent) {
            progressBar.style.width = `${percent}%`;
        }

        // Log message
        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'log-time';
            timeSpan.textContent = `[${timestamp}]`;
            
            const messageSpan = document.createElement('span');
            messageSpan.className = `log-${type}`;
            messageSpan.textContent = ` ${message}`;
            
            logEntry.appendChild(timeSpan);
            logEntry.appendChild(messageSpan);
            logPanel.appendChild(logEntry);
            
            // Auto-scroll
            logPanel.scrollTop = logPanel.scrollHeight;
            
            // Limit log size
            const entries = logPanel.getElementsByClassName('log-entry');
            if (entries.length > 50) {
                logPanel.removeChild(entries[0]);
            }
        }

        // Clear log
        function clearLog() {
            logPanel.innerHTML = '';
            logMessage('Log cleared', 'info');
        }

        // Show notification
        function showNotification(message, type = 'info') {
            notification.textContent = message;
            notification.style.display = 'block';
            notification.style.borderLeftColor = 
                type === 'success' ? '#48bb78' :
                type === 'error' ? '#f56565' :
                type === 'warning' ? '#ed8936' : '#4299e1';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Helper functions
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function disableAllControls() {
            connectBtn.disabled = true;
            disconnectBtn.disabled = true;
            testScannerBtn.disabled = true;
            enrollBtn.disabled = true;
            ledTestBtn.disabled = true;
            buzzerTestBtn.disabled = true;
            getInfoBtn.disabled = true;
        }

        // Simulation functions for testing
        async function simulateHardwareTest() {
            await sleep(1000);
            return true;
        }

        async function simulateImageCaptureTest() {
            await sleep(800);
            return true;
        }

        async function simulateTemplateTest() {
            await sleep(600);
            return true;
        }

        // Handle page visibility
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isScanning) {
                logMessage('Scan paused - page hidden', 'warning');
                if (scanAnimation) {
                    scanAnimation.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>
