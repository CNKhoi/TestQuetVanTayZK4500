<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZK4500 Fingerprint Scanner Test Tool</title>
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #2ec4b6;
            --danger: #e71d36;
            --warning: #ff9f1c;
            --info: #4cc9f0;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border: #dee2e6;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Inter', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.8;
        }

        .alert-box {
            background: rgba(255, 159, 28, 0.15);
            border: 2px solid var(--warning);
            border-radius: 12px;
            padding: 20px;
            margin: 25px auto;
            max-width: 900px;
            color: white;
            backdrop-filter: blur(10px);
        }

        .alert-box h3 {
            color: var(--warning);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3rem;
        }

        .alert-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
        }

        .alert-item i {
            color: var(--warning);
            margin-top: 3px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 35px;
        }

        @media (max-width: 992px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 18px;
            padding: 30px;
            box-shadow: var(--shadow);
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid var(--border);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary);
        }

        .card-title {
            color: var(--primary);
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .badge {
            background: var(--primary);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            color: var(--dark);
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
            background: white;
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.15);
        }

        .form-control:disabled {
            background: #f8f9fa;
            cursor: not-allowed;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-family: inherit;
            letter-spacing: 0.5px;
        }

        .btn-block {
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary) 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(67, 97, 238, 0.3);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e9ecef;
            border-color: var(--gray);
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #20a997 100%);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: linear-gradient(135deg, #20a997 0%, #1b9586 100%);
            transform: translateY(-3px);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c71f37 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #c71f37 0%, #b21e35 100%);
            transform: translateY(-3px);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #e68a00 100%);
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: linear-gradient(135deg, #e68a00 0%, #cc7a00 100%);
            transform: translateY(-3px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }

        .status-indicator {
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-weight: 600;
            font-size: 1.1rem;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .status-connected {
            background: rgba(46, 196, 182, 0.15);
            color: #0d7a6b;
            border-color: var(--success);
            animation: pulse-green 2s infinite;
        }

        .status-disconnected {
            background: rgba(231, 29, 54, 0.1);
            color: #a71d2a;
            border-color: var(--danger);
        }

        .status-scanning {
            background: rgba(255, 159, 28, 0.15);
            color: #b36b00;
            border-color: var(--warning);
            animation: pulse-orange 1s infinite;
        }

        @keyframes pulse-green {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        @keyframes pulse-orange {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(255, 159, 28, 0.4);
            }
            70% { 
                box-shadow: 0 0 0 10px rgba(255, 159, 28, 0);
            }
            100% { 
                box-shadow: 0 0 0 0 rgba(255, 159, 28, 0);
            }
        }

        .fingerprint-display {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border: 2px dashed var(--border);
            transition: all 0.3s;
        }

        .fingerprint-display.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        }

        .fingerprint-svg-container {
            width: 220px;
            height: 220px;
            margin: 0 auto 25px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid var(--border);
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }

        .fingerprint-svg-container.active {
            border-color: var(--primary);
            animation: rotate-border 3s linear infinite;
        }

        .fingerprint-svg-container.scanning {
            border-color: var(--warning);
            animation: rotate-border 1s linear infinite, glow 2s ease-in-out infinite;
        }

        @keyframes rotate-border {
            0% { border-width: 4px; }
            50% { border-width: 8px; }
            100% { border-width: 4px; }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(67, 97, 238, 0.3); }
            50% { box-shadow: 0 0 40px rgba(67, 97, 238, 0.6); }
        }

        .fingerprint-svg {
            width: 140px;
            height: 140px;
            color: var(--primary);
            transition: all 0.3s;
        }

        .fingerprint-svg.scanning {
            color: var(--warning);
            animation: bounce 0.5s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .fingerprint-info {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }

        .data-log-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            border: 2px solid var(--border);
            font-family: 'Courier New', 'Consolas', monospace;
            font-size: 0.95rem;
        }

        .log-entry {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            word-break: break-word;
            display: flex;
            gap: 15px;
            align-items: flex-start;
            transition: background 0.2s;
        }

        .log-entry:hover {
            background: rgba(0,0,0,0.02);
        }

        .log-entry.command {
            border-left: 4px solid var(--primary);
        }

        .log-entry.response {
            border-left: 4px solid var(--success);
        }

        .log-entry.error {
            border-left: 4px solid var(--danger);
        }

        .log-entry.info {
            border-left: 4px solid var(--info);
        }

        .log-timestamp {
            color: var(--gray);
            font-size: 0.85rem;
            min-width: 85px;
            font-weight: 600;
        }

        .log-content {
            flex: 1;
            color: var(--dark);
        }

        .log-content.hex {
            color: var(--secondary);
            font-weight: 600;
        }

        .commands-panel {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .command-btn {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .command-btn:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .command-btn .cmd-name {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .command-btn .cmd-desc {
            font-size: 0.85rem;
            color: var(--gray);
        }

        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 20px 30px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            transform: translateX(150%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 10000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 400px;
            backdrop-filter: blur(10px);
        }

        .notification.success {
            background: linear-gradient(135deg, rgba(46, 196, 182, 0.95) 0%, rgba(32, 169, 151, 0.95) 100%);
            border-left: 5px solid #1b9586;
        }

        .notification.error {
            background: linear-gradient(135deg, rgba(231, 29, 54, 0.95) 0%, rgba(199, 31, 55, 0.95) 100%);
            border-left: 5px solid #b21e35;
        }

        .notification.warning {
            background: linear-gradient(135deg, rgba(255, 159, 28, 0.95) 0%, rgba(230, 138, 0, 0.95) 100%);
            border-left: 5px solid #cc7a00;
        }

        .notification.info {
            background: linear-gradient(135deg, rgba(76, 201, 240, 0.95) 0%, rgba(41, 171, 226, 0.95) 100%);
            border-left: 5px solid #29abe2;
        }

        .notification.show {
            transform: translateX(0);
        }

        .device-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid var(--border);
        }

        .info-card h4 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--gray);
            font-weight: 500;
        }

        .info-value {
            color: var(--dark);
            font-weight: 600;
            text-align: right;
            max-width: 200px;
            word-break: break-all;
        }

        .info-value.connected {
            color: var(--success);
        }

        .info-value.disconnected {
            color: var(--danger);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: modal-appear 0.3s ease-out;
        }

        @keyframes modal-appear {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        footer {
            text-align: center;
            color: white;
            margin-top: 50px;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            opacity: 0.9;
        }

        .github-link {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            color: white;
            text-decoration: none;
            margin-top: 15px;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .github-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 4px;
            transition: width 0.3s;
            width: 0%;
        }

        .auto-test-results {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .test-result.success {
            background: rgba(46, 196, 182, 0.1);
            border-left: 3px solid var(--success);
        }

        .test-result.error {
            background: rgba(231, 29, 54, 0.1);
            border-left: 3px solid var(--danger);
        }

        .test-result.skipped {
            background: rgba(108, 117, 125, 0.1);
            border-left: 3px solid var(--gray);
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-fingerprint fa-beat"></i> ZK4500 Fingerprint Scanner Test Tool</h1>
            <p>Ứng dụng test máy quét vân tay ZK4500 hoạt động trực tiếp trên trình duyệt - Không cần cài đặt phần mềm</p>
        </div>

        <!-- System Requirements Alert -->
        <div class="alert-box">
            <h3><i class="fas fa-exclamation-triangle"></i> Yêu cầu hệ thống & Hướng dẫn nhanh</h3>
            <div class="alert-content">
                <div class="alert-item">
                    <i class="fas fa-check-circle"></i>
                    <span><strong>Trình duyệt:</strong> Chrome/Edge 89+ (bật Web Serial API)</span>
                </div>
                <div class="alert-item">
                    <i class="fas fa-plug"></i>
                    <span><strong>Kết nối:</strong> Cắm ZK4500 vào USB, đợi Windows nhận driver</span>
                </div>
                <div class="alert-item">
                    <i class="fas fa-user-shield"></i>
                    <span><strong>Quyền truy cập:</strong> Cho phép truy cập cổng serial khi trình duyệt hỏi</span>
                </div>
                <div class="alert-item">
                    <i class="fas fa-cogs"></i>
                    <span><strong>Baud Rate:</strong> Thử 9600, 115200, 57600 (tự động test có sẵn)</span>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="dashboard">
            <!-- Connection Panel -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-plug"></i>
                        <span>Kết nối & Cấu hình</span>
                    </div>
                    <span class="badge" id="connectionBadge">OFFLINE</span>
                </div>

                <div id="connectionStatus" class="status-indicator status-disconnected">
                    <i class="fas fa-times-circle"></i>
                    <span>CHƯA KẾT NỐI</span>
                </div>

                <div class="form-group">
                    <label class="form-label" for="baudRate">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Baud Rate:</span>
                    </label>
                    <select id="baudRate" class="form-control">
                        <option value="9600">9600 (Mặc định)</option>
                        <option value="19200">19200</option>
                        <option value="38400">38400</option>
                        <option value="57600">57600</option>
                        <option value="115200">115200 (Khuyến nghị)</option>
                        <option value="230400">230400</option>
                        <option value="460800">460800</option>
                        <option value="921600">921600</option>
                    </select>
                </div>

                <div class="btn-group">
                    <button id="connectBtn" class="btn btn-primary">
                        <i class="fas fa-link"></i>
                        <span>Kết nối thiết bị</span>
                    </button>
                    <button id="autoTestBtn" class="btn btn-warning">
                        <i class="fas fa-bolt"></i>
                        <span>Auto Test</span>
                    </button>
                    <button id="disconnectBtn" class="btn btn-danger" disabled>
                        <i class="fas fa-unlink"></i>
                        <span>Ngắt kết nối</span>
                    </button>
                </div>

                <div class="form-group" style="margin-top: 30px;">
                    <h4 style="color: var(--primary); margin-bottom: 15px;">
                        <i class="fas fa-tools"></i> Công cụ nâng cao
                    </h4>
                    <div class="btn-group">
                        <button id="testDeviceBtn" class="btn btn-secondary">
                            <i class="fas fa-search"></i>
                            <span>Kiểm tra thiết bị</span>
                        </button>
                        <button id="checkDriverBtn" class="btn btn-secondary">
                            <i class="fas fa-microchip"></i>
                            <span>Kiểm tra Driver</span>
                        </button>
                        <button id="testAllBaudBtn" class="btn btn-secondary">
                            <i class="fas fa-sync-alt"></i>
                            <span>Test tất cả Baud Rate</span>
                        </button>
                    </div>
                </div>

                <!-- Auto Test Progress (Hidden by default) -->
                <div id="autoTestProgress" style="display: none; margin-top: 20px;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="testProgressFill"></div>
                    </div>
                    <div id="testStatusText" style="text-align: center; color: var(--gray); font-size: 0.9rem;">
                        Đang chuẩn bị...
                    </div>
                    <div class="auto-test-results" id="autoTestResults">
                        <!-- Test results will appear here -->
                    </div>
                </div>
            </div>

            <!-- Fingerprint Display Panel -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-fingerprint"></i>
                        <span>Hiển thị & Quét vân tay</span>
                    </div>
                    <span class="badge" id="scanBadge">CHỜ</span>
                </div>

                <div class="fingerprint-display" id="fingerprintDisplay">
                    <div class="fingerprint-svg-container" id="fingerprintSvgContainer">
                        <svg class="fingerprint-svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 15c1.66 0 3-1.34 3-3V6c0-1.66-1.34-3-3-3S9 4.34 9 6v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V6zm6 0c0-2.76-2.24-5-5-5S7 3.24 7 6v6c0 2.21 1.79 4 4 4s4-1.79 4-4v-2h2v2c0 2.76-2.24 5-5 5s-5-2.24-5-5V6c0-3.87 3.13-7 7-7s7 3.13 7 7v1h-2V6z"/>
                        </svg>
                    </div>
                    
                    <h3 id="fingerprintStatus" style="color: var(--dark); margin-bottom: 10px;">
                        Đang chờ kết nối thiết bị...
                    </h3>
                    
                    <div class="fingerprint-info">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--gray);">Trạng thái:</span>
                            <span id="fpState" style="color: var(--danger); font-weight: 600;">Không hoạt động</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--gray);">Lần quét cuối:</span>
                            <span id="lastScanTime" style="color: var(--gray); font-size: 0.9rem;">Chưa có</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--gray);">Tổng số lần quét:</span>
                            <span id="totalScans" style="color: var(--primary); font-weight: 600;">0</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Commands -->
                <div style="margin-top: 25px;">
                    <h4 style="color: var(--primary); margin-bottom: 15px;">
                        <i class="fas fa-bolt"></i> Lệnh nhanh
                    </h4>
                    <div class="commands-panel" id="quickCommands">
                        <!-- Quick commands will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Log Panel -->
        <div class="card" style="margin-bottom: 30px;">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-terminal"></i>
                    <span>Dữ liệu & Log nhận được</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="clearLogBtn" class="btn btn-secondary" style="padding: 8px 16px;">
                        <i class="fas fa-trash"></i>
                        <span>Xóa Log</span>
                    </button>
                    <button id="exportLogBtn" class="btn btn-success" style="padding: 8px 16px;">
                        <i class="fas fa-download"></i>
                        <span>Xuất Log</span>
                    </button>
                </div>
            </div>
            
            <div class="data-log-container" id="dataLog">
                <!-- Log entries will appear here -->
                <div class="log-entry info">
                    <div class="log-timestamp">[System]</div>
                    <div class="log-content">Chào mừng đến với ZK4500 Test Tool. Nhấn "Kết nối thiết bị" để bắt đầu.</div>
                </div>
            </div>

            <!-- Manual Command Input -->
            <div style="margin-top: 20px;">
                <div class="form-group">
                    <label class="form-label" for="manualCommand">
                        <i class="fas fa-keyboard"></i>
                        <span>Gửi lệnh thủ công:</span>
                    </label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" 
                               id="manualCommand" 
                               class="form-control" 
                               placeholder="Nhập lệnh (VD: VER, ENROLL, IDENTIFY) hoặc mã HEX (VD: 7E 56 45 52 0D)"
                               disabled>
                        <button id="sendCommandBtn" class="btn btn-primary" style="min-width: 120px;" disabled>
                            <i class="fas fa-paper-plane"></i>
                            <span>Gửi</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Device Information -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-info-circle"></i>
                    <span>Thông tin thiết bị & Hệ thống</span>
                </div>
            </div>
            
            <div class="device-info-grid">
                <div class="info-card">
                    <h4><i class="fas fa-microchip"></i> Thông tin kết nối</h4>
                    <div class="info-item">
                        <span class="info-label">Trạng thái:</span>
                        <span id="infoStatus" class="info-value disconnected">Không kết nối</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Baud Rate:</span>
                        <span id="infoBaudRate" class="info-value">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Vendor ID:</span>
                        <span id="infoVendorId" class="info-value">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Product ID:</span>
                        <span id="infoProductId" class="info-value">-</span>
                    </div>
                </div>
                
                <div class="info-card">
                    <h4><i class="fas fa-chart-bar"></i> Thống kê</h4>
                    <div class="info-item">
                        <span class="info-label">Lệnh đã gửi:</span>
                        <span id="infoCommandsSent" class="info-value">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Phản hồi nhận:</span>
                        <span id="infoResponses" class="info-value">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Lần quét vân tay:</span>
                        <span id="infoScans" class="info-value">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Lỗi:</span>
                        <span id="infoErrors" class="info-value">0</span>
                    </div>
                </div>
                
                <div class="info-card">
                    <h4><i class="fas fa-cogs"></i> Thông số ZK4500</h4>
                    <div class="info-item">
                        <span class="info-label">Độ phân giải:</span>
                        <span class="info-value">500 DPI</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Tốc độ quét:</span>
                        <span class="info-value">&lt; 1 giây</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Dung lượng:</span>
                        <span class="info-value">1000 templates</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Giao tiếp:</span>
                        <span class="info-value">USB/RS232</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification"></div>

    <!-- Auto Test Modal -->
    <div class="modal" id="autoTestModal">
        <div class="modal-content">
            <h2 style="color: var(--primary); margin-bottom: 20px;">
                <i class="fas fa-vial"></i> Auto Test Baud Rate
            </h2>
            <p style="margin-bottom: 20px; color: var(--gray);">
                Chương trình sẽ tự động test tất cả các Baud Rate phổ biến để tìm ra cấu hình phù hợp với ZK4500 của bạn.
            </p>
            
            <div class="progress-bar">
                <div class="progress-fill" id="modalProgressFill"></div>
            </div>
            
            <div id="modalStatusText" style="text-align: center; margin: 15px 0; color: var(--dark); font-weight: 600;">
                Đang chuẩn bị test...
            </div>
            
            <div id="modalTestResults" style="max-height: 300px; overflow-y: auto; margin: 20px 0;">
                <!-- Test results will appear here -->
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px;">
                <button id="cancelTestBtn" class="btn btn-secondary">
                    <i class="fas fa-times"></i>
                    <span>Hủy bỏ</span>
                </button>
                <button id="applyBestBaudBtn" class="btn btn-primary" disabled>
                    <i class="fas fa-check"></i>
                    <span>Dùng Baud tốt nhất</span>
                </button>
            </div>
        </div>
    </div>

    <footer>
        <p>ZK4500 Fingerprint Scanner Test Tool v2.0</p>
        <p>Hoạt động hoàn toàn trên trình duyệt với Web Serial API | Không cần cài đặt phần mềm</p>
        <a href="https://github.com/yourusername/zk4500-test" class="github-link" target="_blank">
            <i class="fab fa-github"></i>
            <span>GitHub Repository</span>
            <i class="fas fa-external-link-alt"></i>
        </a>
    </footer>

    <script>
        // Main Application Class
        class ZK4500Tester {
            constructor() {
                // Hardware properties
                this.port = null;
                this.reader = null;
                this.writer = null;
                this.isConnected = false;
                this.isScanning = false;
                this.isTesting = false;
                
                // Statistics
                this.stats = {
                    commandsSent: 0,
                    responsesReceived: 0,
                    fingerprintScans: 0,
                    errors: 0,
                    connectedTime: null
                };
                
                // ZK4500 Protocol constants
                this.ZK_PROTOCOL = {
                    START_BYTE: 0x7E,
                    ACK: [0x7E, 0x41, 0x43, 0x4B, 0x0D],  // ~ACK
                    NAK: [0x7E, 0x4E, 0x41, 0x4B, 0x0D],  // ~NAK
                    VER: [0x7E, 0x56, 0x45, 0x52, 0x0D],  // ~VER
                    ENROLL: [0x7E, 0x45, 0x4E, 0x52, 0x0D], // ~ENR
                    IDENTIFY: [0x7E, 0x49, 0x44, 0x4E, 0x0D] // ~IDN
                };
                
                // Common ZK4500 commands
                this.commands = [
                    { cmd: 'VER', desc: 'Kiểm tra phiên bản firmware', hex: '7E 56 45 52 0D', type: 'system' },
                    { cmd: 'ENROLL', desc: 'Đăng ký vân tay mới', hex: '7E 45 4E 52 0D', type: 'enroll' },
                    { cmd: 'IDENTIFY', desc: 'Nhận dạng vân tay', hex: '7E 49 44 4E 0D', type: 'identify' },
                    { cmd: 'DELETE', desc: 'Xóa vân tay theo ID', hex: '7E 44 45 4C 0D', type: 'manage' },
                    { cmd: 'CLEAR', desc: 'Xóa tất cả vân tay', hex: '7E 43 4C 52 0D', type: 'manage' },
                    { cmd: 'GETTEMP', desc: 'Lấy template vân tay', hex: '7E 47 54 50 0D', type: 'template' },
                    { cmd: 'SETTEMP', desc: 'Gửi template vân tay', hex: '7E 53 54 50 0D', type: 'template' },
                    { cmd: 'LED_ON', desc: 'Bật đèn LED', hex: '7E 4C 45 44 31 0D', type: 'control' },
                    { cmd: 'LED_OFF', desc: 'Tắt đèn LED', hex: '7E 4C 45 44 30 0D', type: 'control' },
                    { cmd: 'BEEP', desc: 'Phát tiếng bíp', hex: '7E 42 45 50 0D', type: 'control' },
                    { cmd: 'GET_IMG', desc: 'Lấy hình ảnh vân tay', hex: '7E 47 49 4D 0D', type: 'image' },
                    { cmd: 'GET_CFG', desc: 'Lấy cấu hình thiết bị', hex: '7E 47 43 46 0D', type: 'system' }
                ];
                
                // Baud rates to test
                this.baudRates = [9600, 19200, 38400, 57600, 115200, 230400, 460800, 921600];
                
                // Initialize the application
                this.init();
            }

            init() {
                this.bindEvents();
                this.renderQuickCommands();
                this.checkBrowserCompatibility();
                this.logSystemMessage('ZK4500 Test Tool đã sẵn sàng.');
            }

            bindEvents() {
                // Connection buttons
                document.getElementById('connectBtn').addEventListener('click', () => this.connect());
                document.getElementById('disconnectBtn').addEventListener('click', () => this.disconnect());
                document.getElementById('autoTestBtn').addEventListener('click', () => this.startAutoTest());
                
                // Manual command
                document.getElementById('sendCommandBtn').addEventListener('click', () => this.sendManualCommand());
                document.getElementById('manualCommand').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendManualCommand();
                });
                
                // Log management
                document.getElementById('clearLogBtn').addEventListener('click', () => this.clearLog());
                document.getElementById('exportLogBtn').addEventListener('click', () => this.exportLog());
                
                // Advanced tools
                document.getElementById('testDeviceBtn').addEventListener('click', () => this.testDeviceDetection());
                document.getElementById('checkDriverBtn').addEventListener('click', () => this.checkDriverSupport());
                document.getElementById('testAllBaudBtn').addEventListener('click', () => this.showAutoTestModal());
                
                // Modal controls
                document.getElementById('cancelTestBtn').addEventListener('click', () => this.hideAutoTestModal());
                document.getElementById('applyBestBaudBtn').addEventListener('click', () => this.applyBestBaudRate());
            }

            // ========== BROWSER COMPATIBILITY ==========
            checkBrowserCompatibility() {
                if (!navigator.serial) {
                    this.showNotification(
                        'Trình duyệt không hỗ trợ Web Serial API. Vui lòng sử dụng:<br>' +
                        '• Chrome 89+<br>• Edge 89+<br>• Opera 76+',
                        'error'
                    );
                    
                    // Disable all connection buttons
                    ['connectBtn', 'autoTestBtn', 'testDeviceBtn', 'checkDriverBtn', 'testAllBaudBtn']
                        .forEach(id => document.getElementById(id).disabled = true);
                    
                    this.logSystemMessage('LỖI: Trình duyệt không hỗ trợ Web Serial API.');
                    return false;
                }
                
                this.logSystemMessage('Trình duyệt hỗ trợ Web Serial API.');
                return true;
            }

            // ========== CONNECTION MANAGEMENT ==========
            async connect() {
                try {
                    this.showNotification('Đang tìm kiếm thiết bị...', 'info');
                    
                    // Request port with ZK4500 vendor filters
                    const filters = [
                        { usbVendorId: 0x1A86 }, // CH340/CH341 (common for ZK4500)
                        { usbVendorId: 0x067B }, // Prolific
                        { usbVendorId: 0x0403 }, // FTDI
                        { usbVendorId: 0x10C4 }, // Silicon Labs
                        { usbVendorId: 0x2341 }  // Arduino
                    ];
                    
                    this.port = await navigator.serial.requestPort({ filters });
                    
                    const portInfo = this.port.getInfo();
                    const baudRate = parseInt(document.getElementById('baudRate').value);
                    
                    this.showNotification(`Đang kết nối với Baud Rate: ${baudRate}...`, 'info');
                    
                    // Open port with timeout
                    await Promise.race([
                        this.port.open({ 
                            baudRate: baudRate,
                            dataBits: 8,
                            stopBits: 1,
                            parity: 'none',
                            flowControl: 'none'
                        }),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Timeout khi mở cổng serial')), 5000)
                        )
                    ]);
                    
                    this.writer = this.port.writable.getWriter();
                    this.isConnected = true;
                    this.stats.connectedTime = new Date();
                    
                    // Update UI
                    this.updateConnectionStatus(true);
                    this.updateDeviceInfo(portInfo);
                    this.logSystemMessage(`Đã kết nối với thiết bị (Baud: ${baudRate})`);
                    
                    // Show success notification with device info
                    const vendorHex = portInfo.usbVendorId?.toString(16).padStart(4, '0').toUpperCase() || 'N/A';
                    const productHex = portInfo.usbProductId?.toString(16).padStart(4, '0').toUpperCase() || 'N/A';
                    
                    this.showNotification(
                        `✅ Kết nối thành công!<br>
                         Baud Rate: <strong>${baudRate}</strong><br>
                         Vendor ID: <code>0x${vendorHex}</code><br>
                         Product ID: <code>0x${productHex}</code>`,
                        'success'
                    );
                    
                    // Start reading data
                    this.readData();
                    
                    // Send initial command to verify connection
                    setTimeout(() => this.sendCommand('VER', true), 500);
                    
                } catch (error) {
                    let errorMsg = this.getErrorMessage(error);
                    this.showNotification(`❌ ${errorMsg}`, 'error');
                    this.logSystemMessage(`Lỗi kết nối: ${errorMsg}`);
                    
                    // Clean up on error
                    if (this.port) {
                        try { await this.port.close(); } catch {}
                        this.port = null;
                    }
                }
            }

            async disconnect() {
                try {
                    this.showNotification('Đang ngắt kết nối...', 'info');
                    
                    // Cancel reader
                    if (this.reader) {
                        this.reader.cancel();
                        this.reader = null;
                    }
                    
                    // Release writer
                    if (this.writer) {
                        this.writer.releaseLock();
                        this.writer = null;
                    }
                    
                    // Close port
                    if (this.port) {
                        await this.port.close();
                        this.port = null;
                    }
                    
                    this.isConnected = false;
                    this.updateConnectionStatus(false);
                    this.showNotification('Đã ngắt kết nối thành công', 'success');
                    this.logSystemMessage('Đã ngắt kết nối thiết bị.');
                    
                } catch (error) {
                    this.showNotification(`Lỗi khi ngắt kết nối: ${error.message}`, 'error');
                }
            }

            // ========== DATA COMMUNICATION ==========
            async readData() {
                try {
                    while (this.port.readable && this.isConnected) {
                        this.reader = this.port.readable.getReader();
                        
                        try {
                            while (true) {
                                const { value, done } = await this.reader.read();
                                
                                if (done) {
                                    break;
                                }
                                
                                if (value && value.length > 0) {
                                    this.processReceivedData(value);
                                }
                            }
                        } catch (error) {
                            if (error.name !== 'InterruptedError') {
                                console.error('Read error:', error);
                                this.logSystemMessage(`Lỗi đọc dữ liệu: ${error.message}`);
                            }
                        } finally {
                            this.reader.releaseLock();
                        }
                    }
                } catch (error) {
                    this.logSystemMessage(`Lỗi trong quá trình đọc: ${error.message}`);
                }
            }

            processReceivedData(data) {
                this.stats.responsesReceived++;
                
                // Convert to multiple formats for analysis
                const hexString = Array.from(data)
                    .map(b => b.toString(16).padStart(2, '0').toUpperCase())
                    .join(' ');
                
                const asciiString = Array.from(data)
                    .map(b => (b >= 32 && b <= 126) ? String.fromCharCode(b) : '.')
                    .join('');
                
                // Check for ZK4500 protocol patterns
                const isZKProtocol = data[0] === this.ZK_PROTOCOL.START_BYTE;
                
                if (isZKProtocol) {
                    this.processZK4500Protocol(data, hexString);
                } else if (asciiString.includes('VER') || asciiString.includes('ACK') || asciiString.includes('NAK')) {
                    this.logData('response', `ASCII: ${asciiString}`);
                } else {
                    this.logData('response', `HEX: ${hexString}`);
                }
                
                // Check for fingerprint scan
                if (hexString.includes('50') && hexString.includes('46') || // PF pattern
                    asciiString.includes('FP') || 
                    asciiString.includes('Fingerprint')) {
                    this.handleFingerprintScan();
                }
                
                // Update statistics
                this.updateStatistics();
            }

            processZK4500Protocol(data, hexString) {
                // Parse ZK4500 command response
                const cmdChar1 = String.fromCharCode(data[1] || 0);
                const cmdChar2 = String.fromCharCode(data[2] || 0);
                const cmdChar3 = String.fromCharCode(data[3] || 0);
                const command = `${cmdChar1}${cmdChar2}${cmdChar3}`;
                
                this.logData('response', `ZK4500 [${command}]: ${hexString}`);
                
                // Handle specific responses
                switch(command) {
                    case 'ACK':
                        this.logSystemMessage('Thiết bị phản hồi: ACK (Thành công)');
                        this.showNotification('Thiết bị phản hồi: ACK ✅', 'success');
                        break;
                        
                    case 'NAK':
                        this.logSystemMessage('Thiết bị phản hồi: NAK (Thất bại)');
                        this.showNotification('Thiết bị phản hồi: NAK ❌', 'error');
                        break;
                        
                    case 'VER':
                        if (data.length > 4) {
                            const version = Array.from(data.slice(4, -1))
                                .map(b => String.fromCharCode(b))
                                .join('');
                            this.logSystemMessage(`Phiên bản firmware: ${version}`);
                        }
                        break;
                }
            }

            async sendCommand(command, isHex = false) {
                if (!this.isConnected || !this.writer) {
                    this.showNotification('Chưa kết nối với thiết bị', 'error');
                    return false;
                }

                try {
                    let data;
                    
                    if (isHex) {
                        // Convert hex string to Uint8Array
                        const hexArray = command.trim().split(/\s+/);
                        data = new Uint8Array(hexArray.map(h => parseInt(h, 16)));
                    } else {
                        // Convert ASCII command to Uint8Array
                        const encoder = new TextEncoder();
                        data = encoder.encode(command.endsWith('\r\n') ? command : command + '\r\n');
                    }
                    
                    // Log the command
                    this.logData('command', isHex ? `Gửi HEX: ${command}` : `Gửi: ${command.trim()}`);
                    
                    // Send the command
                    await this.writer.write(data);
                    
                    this.stats.commandsSent++;
                    this.updateStatistics();
                    
                    return true;
                    
                } catch (error) {
                    this.stats.errors++;
                    this.logData('error', `Lỗi gửi lệnh: ${error.message}`);
                    this.showNotification('Lỗi gửi lệnh đến thiết bị', 'error');
                    return false;
                }
            }

            sendManualCommand() {
                const input = document.getElementById('manualCommand');
                const command = input.value.trim();
                
                if (!command) {
                    this.showNotification('Vui lòng nhập lệnh', 'warning');
                    input.focus();
                    return;
                }
                
                // Determine if command is HEX or ASCII
                const isHex = /^[0-9A-F\s]+$/i.test(command.replace(/\s+/g, ''));
                this.sendCommand(command, isHex);
                input.value = '';
                input.focus();
            }

            // ========== FINGERPRINT SCAN HANDLING ==========
            handleFingerprintScan() {
                this.stats.fingerprintScans++;
                this.isScanning = true;
                
                // Update UI
                const container = document.getElementById('fingerprintSvgContainer');
                const status = document.getElementById('fingerprintStatus');
                const fpState = document.getElementById('fpState');
                const scanBadge = document.getElementById('scanBadge');
                const now = new Date();
                
                // Start scanning animation
                container.classList.add('scanning');
                status.textContent = 'ĐANG QUÉT VÂN TAY...';
                status.style.color = 'var(--warning)';
                fpState.textContent = 'Đang quét';
                fpState.style.color = 'var(--warning)';
                scanBadge.textContent = 'QUÉT';
                scanBadge.style.background = 'var(--warning)';
                
                // Update last scan time
                document.getElementById('lastScanTime').textContent = 
                    now.toLocaleTimeString('vi-VN');
                document.getElementById('totalScans').textContent = 
                    this.stats.fingerprintScans;
                
                // Show notification
                this.showNotification('📱 Đã phát hiện dữ liệu vân tay!', 'success');
                
                // Stop animation after 2 seconds
                setTimeout(() => {
                    this.isScanning = false;
                    container.classList.remove('scanning');
                    status.textContent = 'SẴN SÀNG QUÉT';
                    status.style.color = 'var(--success)';
                    fpState.textContent = 'Sẵn sàng';
                    fpState.style.color = 'var(--success)';
                    scanBadge.textContent = 'SẴN SÀNG';
                    scanBadge.style.background = 'var(--success)';
                }, 2000);
            }

            // ========== AUTO TEST FUNCTIONS ==========
            async startAutoTest() {
                if (this.isTesting) return;
                
                this.isTesting = true;
                this.showNotification('Bắt đầu Auto Test...', 'info');
                
                const testResults = [];
                const currentBaud = parseInt(document.getElementById('baudRate').value);
                
                // Show progress
                const progressDiv = document.getElementById('autoTestProgress');
                const progressFill = document.getElementById('testProgressFill');
                const statusText = document.getElementById('testStatusText');
                const resultsDiv = document.getElementById('autoTestResults');
                
                progressDiv.style.display = 'block';
                resultsDiv.innerHTML = '';
                
                // Test each baud rate
                for (let i = 0; i < this.baudRates.length; i++) {
                    const baud = this.baudRates[i];
                    
                    // Update progress
                    const progress = ((i + 1) / this.baudRates.length) * 100;
                    progressFill.style.width = `${progress}%`;
                    statusText.textContent = `Đang test Baud Rate: ${baud}`;
                    
                    try {
                        // Test connection with this baud rate
                        const result = await this.testBaudRate(baud);
                        testResults.push(result);
                        
                        // Display result
                        const resultDiv = document.createElement('div');
                        resultDiv.className = `test-result ${result.success ? 'success' : 'error'}`;
                        resultDiv.innerHTML = `
                            <strong>${baud} baud:</strong> 
                            ${result.success ? '✅ Thành công' : '❌ Thất bại'}
                            ${result.message ? `<br><small>${result.message}</small>` : ''}
                        `;
                        resultsDiv.appendChild(resultDiv);
                        
                    } catch (error) {
                        testResults.push({ baud, success: false, message: error.message });
                    }
                    
                    // Small delay between tests
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // Find best baud rate
                const successfulTests = testResults.filter(r => r.success);
                if (successfulTests.length > 0) {
                    // Sort by baud rate (prefer higher)
                    successfulTests.sort((a, b) => b.baud - a.baud);
                    const bestBaud = successfulTests[0].baud;
                    
                    statusText.innerHTML = `<strong>✅ Test hoàn thành!</strong><br>
                                          Tìm thấy ${successfulTests.length} Baud Rate hoạt động.<br>
                                          Tốt nhất: <strong>${bestBaud}</strong>`;
                    
                    // Suggest using best baud
                    this.showNotification(
                        `Auto Test hoàn thành!<br>
                         Baud Rate tốt nhất: <strong>${bestBaud}</strong><br>
                         Nhấn để áp dụng...`,
                        'success'
                    );
                    
                    // Update baud rate selector
                    document.getElementById('baudRate').value = bestBaud;
                    
                } else {
                    statusText.innerHTML = `<strong>❌ Test thất bại!</strong><br>
                                          Không tìm thấy Baud Rate nào hoạt động.`;
                    this.showNotification('Không tìm thấy Baud Rate nào hoạt động', 'error');
                }
                
                this.isTesting = false;
            }

            async testBaudRate(baudRate) {
                let testPort = null;
                let testWriter = null;
                
                try {
                    // Try to get port (user might need to select)
                    const ports = await navigator.serial.getPorts();
                    if (ports.length === 0) {
                        throw new Error('Không tìm thấy thiết bị');
                    }
                    
                    testPort = ports[0];
                    
                    // Try to open with this baud rate
                    await testPort.open({
                        baudRate: baudRate,
                        dataBits: 8,
                        stopBits: 1,
                        parity: 'none'
                    });
                    
                    testWriter = testPort.writable.getWriter();
                    
                    // Try to send VER command
                    const verCommand = new Uint8Array(this.ZK_PROTOCOL.VER);
                    await testWriter.write(verCommand);
                    
                    // Wait a bit for response
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    return {
                        baud: baudRate,
                        success: true,
                        message: 'Kết nối thành công'
                    };
                    
                } catch (error) {
                    return {
                        baud: baudRate,
                        success: false,
                        message: error.message
                    };
                } finally {
                    // Clean up
                    if (testWriter) {
                        testWriter.releaseLock();
                    }
                    if (testPort) {
                        try { await testPort.close(); } catch {}
                    }
                }
            }

            showAutoTestModal() {
                document.getElementById('autoTestModal').classList.add('active');
                this.runModalAutoTest();
            }

            hideAutoTestModal() {
                document.getElementById('autoTestModal').classList.remove('active');
            }

            async runModalAutoTest() {
                const progressFill = document.getElementById('modalProgressFill');
                const statusText = document.getElementById('modalStatusText');
                const resultsDiv = document.getElementById('modalTestResults');
                const applyBtn = document.getElementById('applyBestBaudBtn');
                
                resultsDiv.innerHTML = '';
                applyBtn.disabled = true;
                
                const testResults = [];
                
                for (let i = 0; i < this.baudRates.length; i++) {
                    const baud = this.baudRates[i];
                    
                    // Update progress
                    const progress = ((i + 1) / this.baudRates.length) * 100;
                    progressFill.style.width = `${progress}%`;
                    statusText.textContent = `Đang test: ${baud} baud`;
                    
                    const result = await this.testBaudRate(baud);
                    testResults.push(result);
                    
                    // Display result
                    const resultDiv = document.createElement('div');
                    resultDiv.className = `test-result ${result.success ? 'success' : 'error'}`;
                    resultDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between;">
                            <span><strong>${baud} baud</strong></span>
                            <span>${result.success ? '✅ Thành công' : '❌ Thất bại'}</span>
                        </div>
                        ${result.message ? `<div style="font-size: 0.8em; margin-top: 5px;">${result.message}</div>` : ''}
                    `;
                    resultsDiv.appendChild(resultDiv);
                    
                    // Scroll to bottom
                    resultsDiv.scrollTop = resultsDiv.scrollHeight;
                    
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
                
                // Find best baud rate
                const successfulTests = testResults.filter(r => r.success);
                if (successfulTests.length > 0) {
                    successfulTests.sort((a, b) => b.baud - a.baud);
                    const bestBaud = successfulTests[0].baud;
                    
                    statusText.innerHTML = `
                        <div style="color: var(--success);">
                            <strong>✅ Test hoàn thành!</strong><br>
                            Tìm thấy ${successfulTests.length} Baud Rate hoạt động<br>
                            Tốt nhất: <strong>${bestBaud} baud</strong>
                        </div>
                    `;
                    
                    applyBtn.disabled = false;
                    applyBtn.dataset.bestBaud = bestBaud;
                    
                } else {
                    statusText.innerHTML = `
                        <div style="color: var(--danger);">
                            <strong>❌ Không tìm thấy Baud Rate nào hoạt động!</strong><br>
                            Kiểm tra kết nối USB và driver.
                        </div>
                    `;
                }
            }

            applyBestBaudRate() {
                const bestBaud = document.getElementById('applyBestBaudBtn').dataset.bestBaud;
                if (bestBaud) {
                    document.getElementById('baudRate').value = bestBaud;
                    this.showNotification(`Đã áp dụng Baud Rate: ${bestBaud}`, 'success');
                    this.hideAutoTestModal();
                    
                    // Auto connect if disconnected
                    if (!this.isConnected) {
                        setTimeout(() => {
                            this.showNotification('Đang thử kết nối với Baud Rate mới...', 'info');
                            this.connect();
                        }, 1000);
                    }
                }
            }

            // ========== DEVICE DETECTION & DRIVER CHECK ==========
            async testDeviceDetection() {
                try {
                    this.showNotification('Đang kiểm tra thiết bị...', 'info');
                    
                    // Get already granted ports
                    const ports = await navigator.serial.getPorts();
                    
                    if (ports.length > 0) {
                        let message = `Tìm thấy ${ports.length} thiết bị:<br><br>`;
                        
                        ports.forEach((port, index) => {
                            const info = port.getInfo();
                            const vendorHex = info.usbVendorId?.toString(16).padStart(4, '0').toUpperCase() || '????';
                            const productHex = info.usbProductId?.toString(16).padStart(4, '0').toUpperCase() || '????';
                            
                            message += `<strong>Thiết bị ${index + 1}:</strong><br>
                                       Vendor ID: <code>0x${vendorHex}</code><br>
                                       Product ID: <code>0x${productHex}</code><br><br>`;
                        });
                        
                        this.showNotification(message, 'success');
                        this.logSystemMessage(`Đã tìm thấy ${ports.length} thiết bị serial.`);
                        
                    } else {
                        this.showNotification(
                            'Không tìm thấy thiết bị nào.<br>' +
                            'Hãy cắm ZK4500 vào USB và thử lại.',
                            'warning'
                        );
                    }
                    
                } catch (error) {
                    this.showNotification(`Lỗi kiểm tra: ${error.message}`, 'error');
                }
            }

            async checkDriverSupport() {
                try {
                    this.showNotification('Đang kiểm tra driver...', 'info');
                    
                    // Common ZK4500 USB IDs
                    const commonDrivers = [
                        { name: 'CH340/CH341', vid: 0x1A86, pids: [0x7523, 0x7522, 0x5523] },
                        { name: 'Prolific', vid: 0x067B, pids: [0x2303, 0x2304, 0x23A3] },
                        { name: 'FTDI', vid: 0x0403, pids: [0x6001, 0x6010, 0x6011, 0x6014] },
                        { name: 'Silicon Labs', vid: 0x10C4, pids: [0xEA60, 0xEA61, 0xEA70] },
                        { name: 'Arduino', vid: 0x2341, pids: [0x0043, 0x0001, 0x0010] }
                    ];
                    
                    const ports = await navigator.serial.getPorts();
                    let foundDrivers = [];
                    
                    ports.forEach(port => {
                        const info = port.getInfo();
                        const vid = info.usbVendorId;
                        const pid = info.usbProductId;
                        
                        if (vid && pid) {
                            const driver = commonDrivers.find(d => d.vid === vid && d.pids.includes(pid));
                            if (driver) {
                                foundDrivers.push(`${driver.name} (0x${vid.toString(16)}:0x${pid.toString(16)})`);
                            } else {
                                foundDrivers.push(`Unknown (0x${vid.toString(16)}:0x${pid.toString(16)})`);
                            }
                        }
                    });
                    
                    if (foundDrivers.length > 0) {
                        this.showNotification(
                            `✅ Driver được nhận diện:<br>${foundDrivers.join('<br>')}`,
                            'success'
                        );
                    } else {
                        this.showNotification(
                            '❌ Không nhận diện được driver.<br>' +
                            'Có thể cần cài driver CH340/CH341.',
                            'error'
                        );
                    }
                    
                } catch (error) {
                    this.showNotification(`Lỗi kiểm tra driver: ${error.message}`, 'error');
                }
            }

            // ========== UI UPDATES ==========
            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('connectionStatus');
                const badge = document.getElementById('connectionBadge');
                const connectBtn = document.getElementById('connectBtn');
                const disconnectBtn = document.getElementById('disconnectBtn');
                const sendBtn = document.getElementById('sendCommandBtn');
                const commandInput = document.getElementById('manualCommand');
                
                if (connected) {
                    statusEl.className = 'status-indicator status-connected';
                    statusEl.innerHTML = '<i class="fas fa-check-circle"></i><span>ĐÃ KẾT NỐI</span>';
                    badge.textContent = 'ONLINE';
                    badge.style.background = 'var(--success)';
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    sendBtn.disabled = false;
                    commandInput.disabled = false;
                    
                    // Activate fingerprint display
                    document.getElementById('fingerprintDisplay').classList.add('active');
                    document.getElementById('fingerprintStatus').textContent = 'SẴN SÀNG QUÉT';
                    
                } else {
                    statusEl.className = 'status-indicator status-disconnected';
                    statusEl.innerHTML = '<i class="fas fa-times-circle"></i><span>CHƯA KẾT NỐI</span>';
                    badge.textContent = 'OFFLINE';
                    badge.style.background = 'var(--danger)';
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    sendBtn.disabled = true;
                    commandInput.disabled = true;
                    
                    // Deactivate fingerprint display
                    document.getElementById('fingerprintDisplay').classList.remove('active');
                    document.getElementById('fingerprintStatus').textContent = 'Đang chờ kết nối thiết bị...';
                }
            }

            updateDeviceInfo(portInfo = null) {
                if (portInfo) {
                    const vendorHex = portInfo.usbVendorId?.toString(16).padStart(4, '0').toUpperCase() || 'N/A';
                    const productHex = portInfo.usbProductId?.toString(16).padStart(4, '0').toUpperCase() || 'N/A';
                    
                    document.getElementById('infoVendorId').textContent = `0x${vendorHex}`;
                    document.getElementById('infoProductId').textContent = `0x${productHex}`;
                }
                
                document.getElementById('infoBaudRate').textContent = 
                    document.getElementById('baudRate').value;
                document.getElementById('infoStatus').textContent = 
                    this.isConnected ? 'Đã kết nối' : 'Không kết nối';
                document.getElementById('infoStatus').className = 
                    `info-value ${this.isConnected ? 'connected' : 'disconnected'}`;
            }

            updateStatistics() {
                document.getElementById('infoCommandsSent').textContent = this.stats.commandsSent;
                document.getElementById('infoResponses').textContent = this.stats.responsesReceived;
                document.getElementById('infoScans').textContent = this.stats.fingerprintScans;
                document.getElementById('infoErrors').textContent = this.stats.errors;
                document.getElementById('totalScans').textContent = this.stats.fingerprintScans;
            }

            // ========== LOG MANAGEMENT ==========
            logSystemMessage(message) {
                this.logData('info', `[SYSTEM] ${message}`);
            }

            logData(type, data) {
                const logContainer = document.getElementById('dataLog');
                const timestamp = new Date().toLocaleTimeString('vi-VN', { 
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                
                const timeSpan = document.createElement('div');
                timeSpan.className = 'log-timestamp';
                timeSpan.textContent = `[${timestamp}]`;
                
                const contentSpan = document.createElement('div');
                contentSpan.className = 'log-content';
                contentSpan.innerHTML = data.replace(/\n/g, '<br>');
                
                // Add hex formatting
                if (data.includes('HEX:')) {
                    contentSpan.classList.add('hex');
                }
                
                entry.appendChild(timeSpan);
                entry.appendChild(contentSpan);
                logContainer.appendChild(entry);
                
                // Auto scroll to bottom
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            clearLog() {
                const logContainer = document.getElementById('dataLog');
                logContainer.innerHTML = `
                    <div class="log-entry info">
                        <div class="log-timestamp">[System]</div>
                        <div class="log-content">Log đã được xóa.</div>
                    </div>
                `;
                this.showNotification('Đã xóa toàn bộ log', 'success');
            }

            exportLog() {
                try {
                    const logEntries = document.querySelectorAll('.log-entry');
                    let logText = '='.repeat(60) + '\n';
                    logText += 'ZK4500 FINGERPRINT SCANNER TEST LOG\n';
                    logText += 'Generated: ' + new Date().toLocaleString('vi-VN') + '\n';
                    logText += '='.repeat(60) + '\n\n';
                    
                    logEntries.forEach(entry => {
                        const timestamp = entry.querySelector('.log-timestamp').textContent;
                        const content = entry.querySelector('.log-content').textContent;
                        logText += `${timestamp} ${content}\n`;
                    });
                    
                    const blob = new Blob([logText], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `zk4500-log-${new Date().toISOString().slice(0, 10)}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(url);
                    this.showNotification('Đã xuất log thành công', 'success');
                    
                } catch (error) {
                    this.showNotification('Lỗi khi xuất log: ' + error.message, 'error');
                }
            }

            // ========== QUICK COMMANDS ==========
            renderQuickCommands() {
                const container = document.getElementById('quickCommands');
                container.innerHTML = '';
                
                this.commands.forEach(cmd => {
                    const btn = document.createElement('div');
                    btn.className = 'command-btn';
                    btn.dataset.command = cmd.hex;
                    btn.dataset.type = cmd.type;
                    
                    btn.innerHTML = `
                        <div class="cmd-name">${cmd.cmd}</div>
                        <div class="cmd-desc">${cmd.desc}</div>
                    `;
                    
                    btn.addEventListener('click', () => {
                        this.sendCommand(cmd.hex, true);
                    });
                    
                    container.appendChild(btn);
                });
            }

            // ========== NOTIFICATION SYSTEM ==========
            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                notification.innerHTML = message;
                notification.className = `notification ${type}`;
                
                // Show with animation
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);
                
                // Auto hide after 5 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000);
            }

            // ========== UTILITY FUNCTIONS ==========
            getErrorMessage(error) {
                switch(error.name) {
                    case 'NotFoundError':
                        return 'Không tìm thấy thiết bị. Kiểm tra kết nối USB.';
                    case 'SecurityError':
                        return 'Lỗi bảo mật: Trang web không được cấp quyền truy cập.';
                    case 'NetworkError':
                        return 'Lỗi mạng. Kiểm tra kết nối Internet.';
                    case 'InvalidStateError':
                        return 'Thiết bị đã bị ngắt kết nối.';
                    case 'TimeoutError':
                        return 'Thiết bị không phản hồi. Kiểm tra Baud Rate và kết nối.';
                    default:
                        return error.message || 'Lỗi không xác định';
                }
            }
        }

        // Initialize application when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.zk4500Tester = new ZK4500Tester();
        });
    </script>
</body>
</html>
