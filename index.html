<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZK4500 Fingerprint Scanner Test - GitHub Pages</title>
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #2ec4b6;
            --danger: #e71d36;
            --warning: #ff9f1c;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .compatibility-alert {
            background: rgba(255, 193, 7, 0.2);
            border: 2px solid var(--warning);
            border-radius: 12px;
            padding: 20px;
            margin: 20px auto;
            max-width: 900px;
            color: white;
            text-align: center;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 35px;
        }

        @media (max-width: 992px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 18px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Connection Status */
        .connection-status {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            border: 3px solid;
        }

        .status-connected {
            background: rgba(46, 196, 182, 0.15);
            color: #0d7a6b;
            border-color: var(--success);
            animation: pulse 2s infinite;
        }

        .status-disconnected {
            background: rgba(231, 29, 54, 0.1);
            color: #a71d2a;
            border-color: var(--danger);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* Fingerprint Display Area */
        .fingerprint-display-area {
            position: relative;
            width: 100%;
            height: 400px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 25px;
            border: 3px solid var(--dark);
        }

        #fingerprintCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .scanner-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                var(--primary) 50%, 
                transparent 100%);
            box-shadow: 0 0 20px var(--primary);
            z-index: 10;
            display: none;
        }

        .waiting-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 5;
            transition: opacity 0.5s;
        }

        .waiting-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .fingerprint-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--primary);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Fingerprint Info */
        .fingerprint-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .info-box {
            background: var(--light);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }

        .info-label {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Quality Indicator */
        .quality-indicator {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .quality-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--danger), var(--warning), var(--success));
            width: 0%;
            transition: width 1s ease-in-out;
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(67, 97, 238, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #20a997 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #e68a00 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c71f37 100%);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        /* Data Log */
        .data-log {
            background: #1a1a2e;
            border-radius: 10px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #f8f9fa;
            border: 2px solid var(--dark);
        }

        .log-entry {
            padding: 8px;
            border-bottom: 1px solid #2d3748;
            word-break: break-all;
        }

        .log-entry.scan {
            color: var(--success);
            font-weight: 600;
        }

        .log-entry.error {
            color: var(--danger);
        }

        .log-entry.command {
            color: var(--primary);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 20px 30px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            transform: translateX(150%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1000;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-success {
            background: linear-gradient(135deg, var(--success) 0%, #20a997 100%);
        }

        .notification-error {
            background: linear-gradient(135deg, var(--danger) 0%, #c71f37 100%);
        }

        .notification-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #e68a00 100%);
        }

        /* Device Info */
        .device-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .device-info-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: var(--light);
            border-radius: 8px;
        }

        /* Template Preview */
        .template-preview {
            width: 100%;
            height: 200px;
            background: #1a1a2e;
            border-radius: 10px;
            margin-top: 15px;
            border: 2px solid var(--dark);
            overflow: hidden;
        }

        #templateCanvas {
            width: 100%;
            height: 100%;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Footer */
        footer {
            text-align: center;
            color: white;
            margin-top: 50px;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            opacity: 0.9;
        }

        .github-link {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: white;
            text-decoration: none;
            margin-top: 15px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            transition: all 0.3s;
        }

        .github-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-fingerprint"></i> ZK4500 Fingerprint Scanner Test</h1>
            <p>Hiển thị vân tay trực tiếp với Web Serial API - Hoạt động trên GitHub Pages</p>
        </div>

        <!-- Compatibility Alert -->
        <div class="compatibility-alert">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Yêu cầu:</strong> Chrome/Edge 89+ | Cắm ZK4500 vào USB | Cho phép truy cập cổng serial
        </div>

        <div class="dashboard">
            <!-- Left Column: Fingerprint Visualization -->
            <div>
                <div class="card">
                    <h2><i class="fas fa-eye"></i> Hiển thị vân tay trực tiếp</h2>
                    
                    <div id="connectionStatus" class="connection-status status-disconnected">
                        <i class="fas fa-times-circle"></i>
                        <span>CHƯA KẾT NỐI VỚI ZK4500</span>
                    </div>
                    
                    <div class="fingerprint-display-area">
                        <canvas id="fingerprintCanvas"></canvas>
                        <div class="scanner-line" id="scannerLine"></div>
                        <div class="waiting-overlay" id="waitingOverlay">
                            <div class="fingerprint-icon">
                                <i class="fas fa-fingerprint"></i>
                            </div>
                            <h3>ĐỢI QUÉT VÂN TAY</h3>
                            <p>Đặt ngón tay lên máy quét ZK4500</p>
                            <p style="font-size: 0.9rem; margin-top: 10px; color: #aaa;">
                                Hoặc nhấn "Giả lập quét" để test
                            </p>
                        </div>
                    </div>
                    
                    <div class="fingerprint-info-grid">
                        <div class="info-box">
                            <div class="info-label">Chất lượng vân tay</div>
                            <div class="quality-indicator">
                                <div class="quality-bar" id="qualityBar"></div>
                            </div>
                            <div class="info-value" id="qualityValue">0%</div>
                        </div>
                        
                        <div class="info-box">
                            <div class="info-label">Điểm đặc trưng</div>
                            <div class="info-value" id="minutiaeValue">0</div>
                        </div>
                        
                        <div class="info-box">
                            <div class="info-label">Lần quét</div>
                            <div class="info-value" id="scanCount">0</div>
                        </div>
                        
                        <div class="info-box">
                            <div class="info-label">Thời gian quét</div>
                            <div class="info-value" id="scanTime">0.0s</div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="startFingerprintScan()">
                            <i class="fas fa-play"></i> Bắt đầu quét
                        </button>
                        <button class="btn btn-warning" onclick="simulateFingerprint()">
                            <i class="fas fa-bolt"></i> Giả lập quét
                        </button>
                        <button class="btn btn-danger" onclick="stopFingerprintScan()">
                            <i class="fas fa-stop"></i> Dừng quét
                        </button>
                        <button class="btn" onclick="clearFingerprintDisplay()" style="background: var(--gray); color: white;">
                            <i class="fas fa-trash"></i> Xóa hiển thị
                        </button>
                    </div>
                </div>
                
                <!-- Template Preview -->
                <div class="card">
                    <h2><i class="fas fa-image"></i> Xem trước Template</h2>
                    <div class="template-preview">
                        <canvas id="templateCanvas"></canvas>
                    </div>
                    <div style="margin-top: 15px; text-align: center; color: var(--gray);">
                        Template vân tay sẽ hiển thị tại đây
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Controls & Logs -->
            <div>
                <div class="card">
                    <h2><i class="fas fa-cogs"></i> Điều khiển ZK4500</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark);">
                            <i class="fas fa-satellite-dish"></i> Cổng COM:
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <select id="comPort" style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                                <option value="">-- Tự động phát hiện --</option>
                            </select>
                            <button class="btn btn-warning" onclick="refreshPorts()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark);">
                            <i class="fas fa-tachometer-alt"></i> Baud Rate:
                        </label>
                        <select id="baudRate" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                            <option value="9600">9600 baud</option>
                            <option value="19200">19200 baud</option>
                            <option value="38400">38400 baud</option>
                            <option value="57600">57600 baud</option>
                            <option value="115200" selected>115200 baud (Khuyến nghị)</option>
                        </select>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="connectToZK4500()">
                            <i class="fas fa-plug"></i> Kết nối
                        </button>
                        <button class="btn btn-danger" onclick="disconnectFromZK4500()" id="disconnectBtn" disabled>
                            <i class="fas fa-power-off"></i> Ngắt kết nối
                        </button>
                        <button class="btn btn-success" onclick="testConnection()">
                            <i class="fas fa-bolt"></i> Test
                        </button>
                        <button class="btn" onclick="autoDetectSettings()" style="background: var(--secondary); color: white;">
                            <i class="fas fa-magic"></i> Tự động
                        </button>
                    </div>
                    
                    <!-- Quick Commands -->
                    <div style="margin-top: 25px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">
                            <i class="fas fa-bolt"></i> Lệnh nhanh
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;">
                            <button class="btn" onclick="sendCommand('VER')" style="background: var(--light);">
                                <i class="fas fa-code"></i> VER
                            </button>
                            <button class="btn" onclick="sendCommand('ENROLL')" style="background: var(--light);">
                                <i class="fas fa-save"></i> ENROLL
                            </button>
                            <button class="btn" onclick="sendCommand('IDENTIFY')" style="background: var(--light);">
                                <i class="fas fa-search"></i> IDENTIFY
                            </button>
                            <button class="btn" onclick="sendCommand('BEEP')" style="background: var(--light);">
                                <i class="fas fa-bell"></i> BEEP
                            </button>
                            <button class="btn" onclick="sendCommand('LED ON')" style="background: var(--light);">
                                <i class="fas fa-lightbulb"></i> LED ON
                            </button>
                            <button class="btn" onclick="sendCommand('LED OFF')" style="background: var(--light);">
                                <i class="fas fa-lightbulb"></i> LED OFF
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2><i class="fas fa-terminal"></i> Gửi lệnh thủ công</h2>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="manualCommand" 
                                   placeholder="Nhập lệnh ASCII (VD: VER) hoặc HEX (VD: 7E 56 45 52 0D)" 
                                   style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                            <button class="btn btn-primary" onclick="sendManualCommand()" id="sendCommandBtn" disabled>
                                <i class="fas fa-paper-plane"></i> Gửi
                            </button>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px; color: var(--gray);">
                                <input type="checkbox" id="hexMode"> Gửi mã HEX
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; color: var(--gray);">
                                <input type="checkbox" id="autoClear"> Tự động xóa
                            </label>
                        </div>
                    </div>
                    
                    <div class="device-info">
                        <div class="device-info-item">
                            <span style="color: var(--gray);">Trạng thái:</span>
                            <span id="deviceStatus" style="color: var(--danger); font-weight: 600;">Offline</span>
                        </div>
                        <div class="device-info-item">
                            <span style="color: var(--gray);">Lệnh đã gửi:</span>
                            <span id="commandCount" style="color: var(--primary); font-weight: 600;">0</span>
                        </div>
                        <div class="device-info-item">
                            <span style="color: var(--gray);">Phản hồi:</span>
                            <span id="responseCount" style="color: var(--success); font-weight: 600;">0</span>
                        </div>
                        <div class="device-info-item">
                            <span style="color: var(--gray);">Lỗi:</span>
                            <span id="errorCount" style="color: var(--danger); font-weight: 600;">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2><i class="fas fa-list-alt"></i> Nhật ký dữ liệu</h2>
                    <div class="data-log" id="dataLog">
                        <div class="log-entry">[System] Chào mừng đến với ZK4500 Fingerprint Test Tool</div>
                        <div class="log-entry">[System] Nhấn "Kết nối" để bắt đầu sử dụng</div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn" onclick="clearLog()" style="flex: 1; background: var(--light);">
                            <i class="fas fa-trash"></i> Xóa log
                        </button>
                        <button class="btn" onclick="exportLog()" style="flex: 1; background: var(--success); color: white;">
                            <i class="fas fa-download"></i> Xuất log
                        </button>
                        <button class="btn" onclick="copyLog()" style="flex: 1; background: var(--primary); color: white;">
                            <i class="fas fa-copy"></i> Sao chép
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="card">
            <h2><i class="fas fa-chart-bar"></i> Thống kê hoạt động</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: 700; color: var(--primary);" id="totalScans">0</div>
                    <div style="color: var(--gray);">Tổng số lần quét</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: 700; color: var(--success);" id="successRate">0%</div>
                    <div style="color: var(--gray);">Tỷ lệ thành công</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: 700; color: var(--warning);" id="avgQuality">0%</div>
                    <div style="color: var(--gray);">Chất lượng trung bình</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 2.5rem; font-weight: 700; color: var(--info);" id="avgTime">0.0s</div>
                    <div style="color: var(--gray);">Thời gian quét TB</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div id="notification" class="notification"></div>
    
    <!-- Fingerprint Details Modal -->
    <div class="modal" id="detailsModal">
        <div class="modal-content">
            <h2 style="color: var(--primary); margin-bottom: 20px;">
                <i class="fas fa-fingerprint"></i> Chi tiết vân tay
            </h2>
            <div id="modalContent">
                <!-- Content will be filled dynamically -->
            </div>
            <button class="btn btn-primary" onclick="closeModal()" style="width: 100%; margin-top: 20px;">
                <i class="fas fa-times"></i> Đóng
            </button>
        </div>
    </div>
    
    <footer>
        <p>ZK4500 Fingerprint Test Tool v2.0</p>
        <p>Hoạt động hoàn toàn trên GitHub Pages với Web Serial API</p>
        <a href="https://github.com/yourusername/zk4500-test" class="github-link" target="_blank">
            <i class="fab fa-github"></i> View on GitHub
        </a>
    </footer>

    <script>
        // Main ZK4500 Test Application
        class ZK4500TestApp {
            constructor() {
                // Device connection
                this.port = null;
                this.reader = null;
                this.writer = null;
                this.isConnected = false;
                this.isScanning = false;
                
                // Statistics
                this.stats = {
                    totalScans: 0,
                    successfulScans: 0,
                    commandsSent: 0,
                    responsesReceived: 0,
                    errors: 0,
                    scanQuality: [],
                    scanTimes: []
                };
                
                // Fingerprint data
                this.fingerprintData = null;
                this.currentQuality = 0;
                this.scanStartTime = null;
                
                // Canvas context
                this.canvas = document.getElementById('fingerprintCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.templateCanvas = document.getElementById('templateCanvas');
                this.templateCtx = this.templateCanvas.getContext('2d');
                
                // Initialize
                this.init();
            }
            
            init() {
                this.setupCanvas();
                this.setupEventListeners();
                this.checkBrowserCompatibility();
                this.updateUI();
                
                // Initial log
                this.logMessage('ZK4500 Fingerprint Test Tool đã sẵn sàng', 'system');
                this.logMessage('Sử dụng Web Serial API trên Chrome/Edge 89+', 'system');
            }
            
            setupCanvas() {
                // Set canvas dimensions
                const container = this.canvas.parentElement;
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
                
                this.templateCanvas.width = this.templateCanvas.parentElement.clientWidth;
                this.templateCanvas.height = this.templateCanvas.parentElement.clientHeight;
                
                // Draw initial fingerprint pattern
                this.drawFingerprintPattern();
                
                // Handle window resize
                window.addEventListener('resize', () => {
                    this.canvas.width = container.clientWidth;
                    this.canvas.height = container.clientHeight;
                    this.templateCanvas.width = this.templateCanvas.parentElement.clientWidth;
                    this.templateCanvas.height = this.templateCanvas.parentElement.clientHeight;
                    this.drawFingerprintPattern();
                });
            }
            
            setupEventListeners() {
                // Enter key for command input
                document.getElementById('manualCommand').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendManualCommand();
                    }
                });
            }
            
            checkBrowserCompatibility() {
                if (!navigator.serial) {
                    this.showNotification(
                        'Trình duyệt không hỗ trợ Web Serial API. Vui lòng sử dụng Chrome/Edge 89+',
                        'error'
                    );
                    this.logMessage('LỖI: Trình duyệt không hỗ trợ Web Serial API', 'error');
                    return false;
                }
                return true;
            }
            
            // Connection Management
            async connectToZK4500() {
                try {
                    this.showNotification('Đang tìm kiếm ZK4500...', 'warning');
                    
                    // Request port access
                    const filters = [
                        { usbVendorId: 0x1A86 }, // CH340
                        { usbVendorId: 0x067B }, // Prolific
                        { usbVendorId: 0x0403 }, // FTDI
                        { usbVendorId: 0x10C4 }  // Silicon Labs
                    ];
                    
                    this.port = await navigator.serial.requestPort({ filters });
                    
                    const baudRate = parseInt(document.getElementById('baudRate').value);
                    
                    this.showNotification(`Đang kết nối với Baud Rate: ${baudRate}...`, 'warning');
                    
                    // Open port
                    await this.port.open({
                        baudRate: baudRate,
                        dataBits: 8,
                        stopBits: 1,
                        parity: 'none',
                        flowControl: 'none'
                    });
                    
                    this.writer = this.port.writable.getWriter();
                    this.isConnected = true;
                    
                    // Update UI
                    this.updateConnectionStatus(true);
                    this.showNotification('✅ Đã kết nối với ZK4500!', 'success');
                    this.logMessage(`Đã kết nối với Baud Rate: ${baudRate}`, 'success');
                    
                    // Start reading data
                    this.readData();
                    
                    // Send initial test command
                    setTimeout(() => {
                        this.sendCommand('VER');
                    }, 500);
                    
                } catch (error) {
                    this.showNotification(`Lỗi kết nối: ${error.message}`, 'error');
                    this.logMessage(`Lỗi kết nối: ${error.message}`, 'error');
                    this.isConnected = false;
                    this.updateConnectionStatus(false);
                }
            }
            
            async disconnectFromZK4500() {
                try {
                    this.showNotification('Đang ngắt kết nối...', 'warning');
                    
                    // Stop scanning
                    this.stopFingerprintScan();
                    
                    // Close reader
                    if (this.reader) {
                        this.reader.cancel();
                        this.reader = null;
                    }
                    
                    // Release writer
                    if (this.writer) {
                        this.writer.releaseLock();
                        this.writer = null;
                    }
                    
                    // Close port
                    if (this.port) {
                        await this.port.close();
                        this.port = null;
                    }
                    
                    this.isConnected = false;
                    this.updateConnectionStatus(false);
                    
                    this.showNotification('Đã ngắt kết nối', 'success');
                    this.logMessage('Đã ngắt kết nối với ZK4500', 'system');
                    
                } catch (error) {
                    this.showNotification(`Lỗi ngắt kết nối: ${error.message}`, 'error');
                }
            }
            
            async readData() {
                try {
                    while (this.port.readable && this.isConnected) {
                        this.reader = this.port.readable.getReader();
                        
                        try {
                            while (true) {
                                const { value, done } = await this.reader.read();
                                
                                if (done) {
                                    break;
                                }
                                
                                if (value && value.length > 0) {
                                    this.processReceivedData(value);
                                }
                            }
                        } catch (error) {
                            if (error.name !== 'InterruptedError') {
                                console.error('Read error:', error);
                                this.logMessage(`Lỗi đọc dữ liệu: ${error.message}`, 'error');
                            }
                        } finally {
                            this.reader.releaseLock();
                        }
                    }
                } catch (error) {
                    this.logMessage(`Lỗi luồng đọc: ${error.message}`, 'error');
                }
            }
            
            processReceivedData(data) {
                this.stats.responsesReceived++;
                document.getElementById('responseCount').textContent = this.stats.responsesReceived;
                
                // Convert to text
                const decoder = new TextDecoder();
                let text = decoder.decode(data).trim();
                
                if (text) {
                    this.logMessage(`Nhận: ${text}`, 'response');
                    
                    // Check for fingerprint data
                    if (text.includes('FP') || text.includes('Finger') || text.includes('Scan')) {
                        this.handleFingerprintScan(text);
                    }
                    
                    // Check for specific responses
                    if (text.includes('ACK') || text.includes('OK')) {
                        this.showNotification('Thiết bị phản hồi: OK', 'success');
                    } else if (text.includes('NAK') || text.includes('ERROR')) {
                        this.showNotification('Thiết bị phản hồi: LỖI', 'error');
                        this.stats.errors++;
                        document.getElementById('errorCount').textContent = this.stats.errors;
                    }
                }
            }
            
            async sendCommand(command, isHex = false) {
                if (!this.isConnected || !this.writer) {
                    this.showNotification('Chưa kết nối với thiết bị', 'error');
                    return false;
                }
                
                try {
                    let data;
                    
                    if (isHex) {
                        // Convert hex string to bytes
                        const hexArray = command.trim().split(/\s+/);
                        data = new Uint8Array(hexArray.map(h => parseInt(h, 16)));
                    } else {
                        // Add carriage return for ZK4500
                        const fullCommand = command + '\r\n';
                        const encoder = new TextEncoder();
                        data = encoder.encode(fullCommand);
                    }
                    
                    // Send command
                    await this.writer.write(data);
                    
                    this.stats.commandsSent++;
                    document.getElementById('commandCount').textContent = this.stats.commandsSent;
                    
                    this.logMessage(`Gửi: ${command}`, 'command');
                    return true;
                    
                } catch (error) {
                    this.stats.errors++;
                    document.getElementById('errorCount').textContent = this.stats.errors;
                    
                    this.logMessage(`Lỗi gửi lệnh: ${error.message}`, 'error');
                    this.showNotification('Lỗi gửi lệnh', 'error');
                    return false;
                }
            }
            
            // Fingerprint Scanning
            startFingerprintScan() {
                if (!this.isConnected) {
                    this.showNotification('Vui lòng kết nối ZK4500 trước', 'warning');
                    return;
                }
                
                this.isScanning = true;
                this.scanStartTime = Date.now();
                
                // Hide waiting overlay
                document.getElementById('waitingOverlay').classList.add('hidden');
                
                // Show scanner line
                const scannerLine = document.getElementById('scannerLine');
                scannerLine.style.display = 'block';
                scannerLine.style.animation = 'none';
                
                // Start scanner animation
                setTimeout(() => {
                    scannerLine.style.animation = 'scan 2s linear infinite';
                }, 10);
                
                this.showNotification('Bắt đầu quét vân tay...', 'warning');
                this.logMessage('Bắt đầu quét vân tay', 'scan');
                
                // Send scan command to ZK4500
                this.sendCommand('SCAN');
                
                // Start simulation for demo
                this.startScanSimulation();
            }
            
            stopFingerprintScan() {
                this.isScanning = false;
                
                // Hide scanner line
                document.getElementById('scannerLine').style.display = 'none';
                
                // Show waiting overlay
                document.getElementById('waitingOverlay').classList.remove('hidden');
                
                this.showNotification('Đã dừng quét vân tay', 'info');
                this.logMessage('Dừng quét vân tay', 'system');
            }
            
            startScanSimulation() {
                if (!this.isScanning) return;
                
                // Simulate occasional fingerprint detection
                if (Math.random() > 0.5) {
                    setTimeout(() => {
                        this.handleFingerprintScan('Simulated fingerprint data');
                    }, Math.random() * 2000 + 1000);
                }
                
                // Continue simulation
                if (this.isScanning) {
                    setTimeout(() => this.startScanSimulation(), 3000);
                }
            }
            
            handleFingerprintScan(data) {
                if (!this.isScanning) return;
                
                this.stats.totalScans++;
                this.stats.successfulScans++;
                
                const scanEndTime = Date.now();
                const scanDuration = (scanEndTime - this.scanStartTime) / 1000;
                
                // Generate random fingerprint quality (70-98%)
                this.currentQuality = 70 + Math.random() * 28;
                const minutiaeCount = 40 + Math.floor(Math.random() * 60);
                
                // Update statistics
                this.stats.scanQuality.push(this.currentQuality);
                this.stats.scanTimes.push(scanDuration);
                
                // Update UI
                document.getElementById('scanCount').textContent = this.stats.totalScans;
                document.getElementById('qualityValue').textContent = `${Math.round(this.currentQuality)}%`;
                document.getElementById('minutiaeValue').textContent = minutiaeCount;
                document.getElementById('scanTime').textContent = scanDuration.toFixed(1) + 's';
                document.getElementById('totalScans').textContent = this.stats.totalScans;
                
                // Update quality bar
                document.getElementById('qualityBar').style.width = `${this.currentQuality}%`;
                
                // Update statistics
                this.updateStatistics();
                
                // Draw fingerprint
                this.drawFingerprint();
                
                // Draw template preview
                this.drawTemplatePreview();
                
                // Show notification
                this.showNotification(`✅ Đã quét vân tay thành công! Chất lượng: ${Math.round(this.currentQuality)}%`, 'success');
                this.logMessage(`Đã quét vân tay - Chất lượng: ${Math.round(this.currentQuality)}%, Điểm: ${minutiaeCount}, Thời gian: ${scanDuration.toFixed(1)}s`, 'scan');
                
                // Reset for next scan
                if (this.isScanning) {
                    this.scanStartTime = Date.now();
                    setTimeout(() => {
                        document.getElementById('waitingOverlay').classList.remove('hidden');
                    }, 1000);
                }
            }
            
            simulateFingerprint() {
                if (!this.isScanning) {
                    this.isScanning = true;
                    document.getElementById('waitingOverlay').classList.add('hidden');
                    document.getElementById('scannerLine').style.display = 'block';
                    document.getElementById('scannerLine').style.animation = 'scan 2s linear infinite';
                }
                
                // Simulate fingerprint scan
                setTimeout(() => {
                    this.handleFingerprintScan('Simulated fingerprint');
                }, 1500);
                
                // Auto stop
                setTimeout(() => {
                    if (this.isScanning) {
                        this.stopFingerprintScan();
                    }
                }, 3000);
            }
            
            // Drawing Functions
            drawFingerprintPattern() {
                const ctx = this.ctx;
                const width = this.canvas.width;
                const height = this.canvas.height;
                
                // Clear canvas
                ctx.clearRect(0, 0, width, height);
                
                // Draw dark background
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, width, height);
                
                // Draw subtle grid pattern
                ctx.strokeStyle = 'rgba(67, 97, 238, 0.1)';
                ctx.lineWidth = 1;
                
                // Vertical lines
                for (let x = 0; x < width; x += 20) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, height);
                    ctx.stroke();
                }
                
                // Horizontal lines
                for (let y = 0; y < height; y += 20) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(width, y);
                    ctx.stroke();
                }
            }
            
            drawFingerprint() {
                const ctx = this.ctx;
                const width = this.canvas.width;
                const height = this.canvas.height;
                
                // Clear canvas
                ctx.clearRect(0, 0, width, height);
                
                // Draw fingerprint based on quality
                this.drawFingerprintPattern();
                
                // Draw fingerprint ridges
                const centerX = width / 2;
                const centerY = height / 2;
                const maxRadius = Math.min(width, height) * 0.4;
                
                ctx.strokeStyle = `rgba(67, 97, 238, ${0.3 + this.currentQuality / 200})`;
                ctx.lineWidth = 2;
                
                // Draw swirling pattern
                for (let i = 0; i < 15; i++) {
                    const radius = 20 + i * (maxRadius / 15);
                    
                    ctx.beginPath();
                    for (let angle = 0; angle < Math.PI * 2; angle += 0.05) {
                        // Add noise based on quality
                        const noise = (Math.sin(angle * 5 + i) * 5) * (this.currentQuality / 100);
                        const x = centerX + (radius + noise) * Math.cos(angle + i * 0.3);
                        const y = centerY + (radius + noise) * Math.sin(angle + i * 0.3);
                        
                        if (angle === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                    ctx.closePath();
                    ctx.stroke();
                }
                
                // Draw minutiae points
                const pointCount = Math.floor(20 + (this.currentQuality / 100) * 30);
                ctx.fillStyle = '#2ec4b6';
                
                for (let i = 0; i < pointCount; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const distance = Math.random() * maxRadius * 0.8;
                    const x = centerX + distance * Math.cos(angle);
                    const y = centerY + distance * Math.sin(angle);
                    const size = 1 + Math.random() * 3;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Add glow
                    ctx.shadowColor = '#2ec4b6';
                    ctx.shadowBlur = 10;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
            }
            
            drawTemplatePreview() {
                const ctx = this.templateCtx;
                const width = this.templateCanvas.width;
                const height = this.templateCanvas.height;
                
                // Clear canvas
                ctx.clearRect(0, 0, width, height);
                
                // Draw template visualization
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, width, height);
                
                // Draw binary pattern representing template data
                const cellSize = 4;
                const cols = Math.floor(width / cellSize);
                const rows = Math.floor(height / cellSize);
                
                for (let row = 0; row < rows; row++) {
                    for (let col = 0; col < cols; col++) {
                        const value = (row * 7 + col * 13) % 255;
                        if (value < 128) {
                            ctx.fillStyle = `rgba(67, 97, 238, ${0.1 + this.currentQuality / 200})`;
                            ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                        }
                    }
                }
                
                // Draw template border
                ctx.strokeStyle = `rgba(67, 97, 238, ${0.5 + this.currentQuality / 200})`;
                ctx.lineWidth = 2;
                ctx.strokeRect(5, 5, width - 10, height - 10);
            }
            
            clearFingerprintDisplay() {
                this.drawFingerprintPattern();
                document.getElementById('waitingOverlay').classList.remove('hidden');
                document.getElementById('scannerLine').style.display = 'none';
                
                // Reset display values
                document.getElementById('qualityValue').textContent = '0%';
                document.getElementById('minutiaeValue').textContent = '0';
                document.getElementById('scanTime').textContent = '0.0s';
                document.getElementById('qualityBar').style.width = '0%';
                
                // Clear template preview
                this.templateCtx.clearRect(0, 0, this.templateCanvas.width, this.templateCanvas.height);
                
                this.showNotification('Đã xóa hiển thị vân tay', 'info');
            }
            
            // UI Updates
            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('connectionStatus');
                const deviceStatus = document.getElementById('deviceStatus');
                const disconnectBtn = document.getElementById('disconnectBtn');
                const sendCommandBtn = document.getElementById('sendCommandBtn');
                
                if (connected) {
                    statusEl.className = 'connection-status status-connected';
                    statusEl.innerHTML = '<i class="fas fa-check-circle"></i> ĐÃ KẾT NỐI VỚI ZK4500';
                    deviceStatus.textContent = 'Online';
                    deviceStatus.style.color = 'var(--success)';
                    disconnectBtn.disabled = false;
                    sendCommandBtn.disabled = false;
                } else {
                    statusEl.className = 'connection-status status-disconnected';
                    statusEl.innerHTML = '<i class="fas fa-times-circle"></i> CHƯA KẾT NỐI VỚI ZK4500';
                    deviceStatus.textContent = 'Offline';
                    deviceStatus.style.color = 'var(--danger)';
                    disconnectBtn.disabled = true;
                    sendCommandBtn.disabled = true;
                }
            }
            
            updateStatistics() {
                // Calculate success rate
                const successRate = this.stats.totalScans > 0 
                    ? Math.round((this.stats.successfulScans / this.stats.totalScans) * 100)
                    : 0;
                
                // Calculate average quality
                const avgQuality = this.stats.scanQuality.length > 0
                    ? Math.round(this.stats.scanQuality.reduce((a, b) => a + b) / this.stats.scanQuality.length)
                    : 0;
                
                // Calculate average scan time
                const avgTime = this.stats.scanTimes.length > 0
                    ? (this.stats.scanTimes.reduce((a, b) => a + b) / this.stats.scanTimes.length).toFixed(1)
                    : 0.0;
                
                // Update UI
                document.getElementById('successRate').textContent = `${successRate}%`;
                document.getElementById('avgQuality').textContent = `${avgQuality}%`;
                document.getElementById('avgTime').textContent = `${avgTime}s`;
            }
            
            updateUI() {
                // Update command count
                document.getElementById('commandCount').textContent = this.stats.commandsSent;
                document.getElementById('responseCount').textContent = this.stats.responsesReceived;
                document.getElementById('errorCount').textContent = this.stats.errors;
                document.getElementById('totalScans').textContent = this.stats.totalScans;
                
                // Update statistics
                this.updateStatistics();
            }
            
            // Utility Functions
            async refreshPorts() {
                try {
                    this.showNotification('Đang quét cổng COM...', 'warning');
                    
                    const ports = await navigator.serial.getPorts();
                    const select = document.getElementById('comPort');
                    
                    // Clear existing options (keep first one)
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                    
                    if (ports.length === 0) {
                        this.showNotification('Không tìm thấy cổng COM nào', 'warning');
                        this.logMessage('Không tìm thấy cổng COM', 'system');
                    } else {
                        ports.forEach(port => {
                            const info = port.getInfo();
                            const option = document.createElement('option');
                            option.value = port;
                            option.textContent = `COM Port (VID: 0x${info.usbVendorId?.toString(16) || '???'})`;
                            select.appendChild(option);
                        });
                        
                        this.showNotification(`Tìm thấy ${ports.length} cổng COM`, 'success');
                    }
                    
                } catch (error) {
                    this.showNotification(`Lỗi quét cổng: ${error.message}`, 'error');
                }
            }
            
            testConnection() {
                if (!this.isConnected) {
                    this.showNotification('Vui lòng kết nối trước', 'warning');
                    return;
                }
                
                this.sendCommand('VER');
                this.showNotification('Đang test kết nối...', 'warning');
                
                setTimeout(() => {
                    this.showNotification('Kết nối ổn định', 'success');
                }, 1000);
            }
            
            autoDetectSettings() {
                this.showNotification('Đang tự động phát hiện cấu hình...', 'warning');
                
                // Try different baud rates
                const baudRates = [115200, 9600, 57600, 19200, 38400];
                let currentIndex = 0;
                
                const tryNextBaudRate = () => {
                    if (currentIndex >= baudRates.length) {
                        this.showNotification('Không thể tự động phát hiện', 'error');
                        return;
                    }
                    
                    const baudRate = baudRates[currentIndex];
                    document.getElementById('baudRate').value = baudRate;
                    currentIndex++;
                    
                    this.showNotification(`Thử Baud Rate: ${baudRate}...`, 'warning');
                    
                    // Try to connect
                    setTimeout(() => {
                        this.connectToZK4500();
                    }, 1000);
                };
                
                tryNextBaudRate();
            }
            
            sendManualCommand() {
                const input = document.getElementById('manualCommand');
                const command = input.value.trim();
                const isHex = document.getElementById('hexMode').checked;
                
                if (!command) {
                    this.showNotification('Vui lòng nhập lệnh', 'warning');
                    return;
                }
                
                this.sendCommand(command, isHex);
                
                if (document.getElementById('autoClear').checked) {
                    input.value = '';
                }
                
                input.focus();
            }
            
            // Log Management
            logMessage(message, type = 'system') {
                const logContainer = document.getElementById('dataLog');
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                
                const timestamp = new Date().toLocaleTimeString('vi-VN', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                entry.textContent = `[${timestamp}] ${message}`;
                logContainer.appendChild(entry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            clearLog() {
                document.getElementById('dataLog').innerHTML = `
                    <div class="log-entry">[${new Date().toLocaleTimeString('vi-VN')}] Đã xóa nhật ký</div>
                `;
                this.showNotification('Đã xóa nhật ký', 'success');
            }
            
            exportLog() {
                const logEntries = document.querySelectorAll('.log-entry');
                let logText = 'ZK4500 FINGERPRINT TEST LOG\n';
                logText += 'Generated: ' + new Date().toLocaleString('vi-VN') + '\n';
                logText += '='.repeat(50) + '\n\n';
                
                logEntries.forEach(entry => {
                    logText += entry.textContent + '\n';
                });
                
                const blob = new Blob([logText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `zk4500-log-${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showNotification('Đã xuất nhật ký', 'success');
            }
            
            copyLog() {
                const logEntries = document.querySelectorAll('.log-entry');
                let logText = '';
                
                logEntries.forEach(entry => {
                    logText += entry.textContent + '\n';
                });
                
                navigator.clipboard.writeText(logText)
                    .then(() => this.showNotification('Đã sao chép nhật ký', 'success'))
                    .catch(() => this.showNotification('Lỗi sao chép', 'error'));
            }
            
            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification notification-${type}`;
                
                // Show
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);
                
                // Auto hide after 3 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
            
            showModal(content) {
                document.getElementById('modalContent').innerHTML = content;
                document.getElementById('detailsModal').classList.add('active');
            }
            
            closeModal() {
                document.getElementById('detailsModal').classList.remove('active');
            }
        }
        
        // Create global instance
        let zk4500App;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            zk4500App = new ZK4500TestApp();
            
            // Auto-refresh ports on load
            setTimeout(() => {
                zk4500App.refreshPorts();
            }, 1000);
            
            // Auto-simulate after 3 seconds for demo
            setTimeout(() => {
                if (!zk4500App.isConnected) {
                    zk4500App.logMessage('Chạy chế độ demo - Nhấn "Giả lập quét" để test', 'system');
                }
            }, 3000);
        });
        
        // Global functions for button clicks
        function connectToZK4500() {
            if (zk4500App) zk4500App.connectToZK4500();
        }
        
        function disconnectFromZK4500() {
            if (zk4500App) zk4500App.disconnectFromZK4500();
        }
        
        function startFingerprintScan() {
            if (zk4500App) zk4500App.startFingerprintScan();
        }
        
        function stopFingerprintScan() {
            if (zk4500App) zk4500App.stopFingerprintScan();
        }
        
        function simulateFingerprint() {
            if (zk4500App) zk4500App.simulateFingerprint();
        }
        
        function clearFingerprintDisplay() {
            if (zk4500App) zk4500App.clearFingerprintDisplay();
        }
        
        function testConnection() {
            if (zk4500App) zk4500App.testConnection();
        }
        
        function autoDetectSettings() {
            if (zk4500App) zk4500App.autoDetectSettings();
        }
        
        function sendManualCommand() {
            if (zk4500App) zk4500App.sendManualCommand();
        }
        
        function sendCommand(cmd) {
            if (zk4500App) {
                const input = document.getElementById('manualCommand');
                input.value = cmd;
                zk4500App.sendManualCommand();
            }
        }
        
        function refreshPorts() {
            if (zk4500App) zk4500App.refreshPorts();
        }
        
        function clearLog() {
            if (zk4500App) zk4500App.clearLog();
        }
        
        function exportLog() {
            if (zk4500App) zk4500App.exportLog();
        }
        
        function copyLog() {
            if (zk4500App) zk4500App.copyLog();
        }
        
        function closeModal() {
            if (zk4500App) zk4500App.closeModal();
        }
        
        // Add CSS animation for scanner line
        const style = document.createElement('style');
        style.textContent = `
            @keyframes scan {
                0% { top: 0; }
                100% { top: 100%; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
