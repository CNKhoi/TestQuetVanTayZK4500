<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZK4500 Fingerprint Test - Windows USB Composite Device</title>
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #2ec4b6;
            --danger: #e71d36;
            --warning: #ff9f1c;
            --info: #4cc9f0;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        /* FIXED: Alert Box for USB Composite Device */
        .usb-composite-alert {
            background: rgba(255, 193, 7, 0.2);
            border: 3px solid #ffc107;
            border-radius: 12px;
            padding: 25px;
            margin: 20px auto;
            max-width: 900px;
            color: #856404;
        }

        .usb-composite-alert h3 {
            color: #856404;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .solution-steps {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            border-left: 4px solid var(--primary);
        }

        .solution-step {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .solution-step:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .step-number {
            background: var(--primary);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-box {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            border: 2px solid;
        }

        .status-disconnected {
            background: rgba(231, 29, 54, 0.1);
            color: #721c24;
            border-color: var(--danger);
        }

        .status-connected {
            background: rgba(46, 196, 182, 0.1);
            color: #155724;
            border-color: var(--success);
        }

        .device-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .info-label {
            color: var(--gray);
        }

        .info-value {
            color: var(--dark);
            font-weight: 600;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #e68a00;
            transform: translateY(-2px);
        }

        .data-log {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .log-entry {
            padding: 8px;
            border-bottom: 1px solid #eee;
            word-break: break-all;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            transform: translateX(150%);
            transition: transform 0.3s;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--danger);
        }

        .notification.warning {
            background: var(--warning);
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-fingerprint"></i> ZK4500 USB Composite Device Test</h1>
            <p>Giải pháp kết nối ZK4500 khi Windows nhận diện là USB Composite Device</p>
        </div>

        <!-- FIXED: USB Composite Device Alert -->
        <div class="usb-composite-alert">
            <h3><i class="fas fa-exclamation-triangle"></i> PHÁT HIỆN: ZK4500 ĐANG Ở CHẾ ĐỘ USB COMPOSITE</h3>
            <p><strong>Windows đã nhận ZK4500 nhưng chưa tạo cổng COM.</strong> Đây là nguyên nhân không kết nối được.</p>
            
            <div class="solution-steps">
                <div class="solution-step">
                    <div class="step-number">1</div>
                    <div>
                        <strong>Mở Device Manager</strong>
                        <p>Nhấn Win + X → Device Manager</p>
                    </div>
                </div>
                <div class="solution-step">
                    <div class="step-number">2</div>
                    <div>
                        <strong>Tìm ZK4500 trong "Universal Serial Bus controllers"</strong>
                        <p>Nó đang hiển thị là "USB Composite Device" hoặc "ZK4500"</p>
                    </div>
                </div>
                <div class="solution-step">
                    <div class="step-number">3</div>
                    <div>
                        <strong>Chuyển sang chế độ Serial Mode</strong>
                        <p>Nhấn nút trên thiết bị hoặc gửi lệnh chuyển đổi (xem bên dưới)</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><i class="fas fa-cogs"></i> Giải pháp kết nối ZK4500 USB Composite</h2>
            
            <div id="connectionStatus" class="status-box status-disconnected">
                <i class="fas fa-times-circle"></i> 
                <span>THIẾT BỊ ĐÃ NHẬN NHƯNG CHƯA CÓ CỔNG COM</span>
            </div>

            <!-- Mode Switch Commands -->
            <div style="margin-bottom: 25px;">
                <h3><i class="fas fa-exchange-alt"></i> Chuyển đổi chế độ ZK4500</h3>
                <p style="color: var(--gray); margin-bottom: 15px;">
                    ZK4500 có thể hoạt động ở 2 chế độ: <strong>USB Composite</strong> (HID) và <strong>USB Serial</strong> (COM).
                    Cần chuyển sang Serial Mode để web app kết nối.
                </p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <button id="switchToSerialBtn" class="btn btn-primary">
                        <i class="fas fa-plug"></i>
                        <span>Gửi lệnh chuyển sang Serial Mode</span>
                    </button>
                    <button id="forceCreateComBtn" class="btn btn-warning">
                        <i class="fas fa-microchip"></i>
                        <span>Thử tạo cổng COM thủ công</span>
                    </button>
                </div>
            </div>

            <!-- Direct VID/PID Connection -->
            <div style="margin-bottom: 25px;">
                <h3><i class="fas fa-bolt"></i> Kết nối trực tiếp qua VID/PID</h3>
                <p style="color: var(--gray); margin-bottom: 15px;">
                    Thử kết nối trực tiếp với ZK4500 bằng Vendor ID/Product ID thay vì cổng COM
                </p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <button id="connectByVidPidBtn" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                        <span>Tìm và kết nối ZK4500 (VID: 1A86)</span>
                    </button>
                    <button id="tryAllModesBtn" class="btn btn-warning">
                        <i class="fas fa-sync-alt"></i>
                        <span>Thử tất cả chế độ ZK4500</span>
                    </button>
                </div>
            </div>

            <!-- Device Information -->
            <div class="device-info-grid">
                <div>
                    <h3><i class="fas fa-info-circle"></i> Thông tin từ hình ảnh</h3>
                    <div class="info-item">
                        <span class="info-label">Device Type:</span>
                        <span class="info-value">Universal Serial Bus Device</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Manufacturer:</span>
                        <span class="info-value">ZKTeco</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status:</span>
                        <span class="info-value" style="color: var(--success);">Working properly ✓</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Location:</span>
                        <span class="info-value">Port_#1000</span>
                    </div>
                </div>
                
                <div>
                    <h3><i class="fas fa-tools"></i> Hành động cần thiết</h3>
                    <div class="info-item">
                        <span class="info-label">Chế độ hiện tại:</span>
                        <span class="info-value" style="color: var(--warning);">USB Composite (HID)</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Chế độ cần:</span>
                        <span class="info-value" style="color: var(--success);">USB Serial (COM)</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Vendor ID:</span>
                        <span class="info-value">1A86 (QinHeng)</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Cách chuyển:</span>
                        <span class="info-value">Lệnh đặc biệt hoặc nút vật lý</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Special Commands for ZK4500 -->
        <div class="card">
            <h2><i class="fas fa-terminal"></i> Lệnh đặc biệt cho ZK4500</h2>
            <p style="color: var(--gray); margin-bottom: 20px;">
                Các lệnh này giúp chuyển đổi chế độ ZK4500 từ USB Composite sang USB Serial
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                <button class="btn btn-primary" onclick="sendSpecialCommand('mode_serial')">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Chuyển sang Serial</span>
                </button>
                <button class="btn btn-primary" onclick="sendSpecialCommand('mode_hid')">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Chuyển sang HID</span>
                </button>
                <button class="btn btn-warning" onclick="sendSpecialCommand('reset_device')">
                    <i class="fas fa-redo"></i>
                    <span>Reset thiết bị</span>
                </button>
                <button class="btn btn-warning" onclick="sendSpecialCommand('force_com')">
                    <i class="fas fa-cog"></i>
                    <span>Force COM Mode</span>
                </button>
            </div>
            
            <!-- Data Log -->
            <h3><i class="fas fa-list-alt"></i> Dữ liệu gửi/nhận</h3>
            <div class="data-log" id="dataLog">
                <div class="log-entry">[System] ZK4500 đang ở chế độ USB Composite. Cần chuyển sang Serial Mode.</div>
                <div class="log-entry">[System] Thử gửi lệnh chuyển đổi chế độ...</div>
            </div>
            
            <!-- Manual Command -->
            <div style="margin-top: 20px;">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="manualCommand" 
                           placeholder="Nhập lệnh HEX (VD: 55 AA 02 01 00 00 FD)..." 
                           style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                    <button id="sendCommandBtn" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i>
                        <span>Gửi</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Alternative Solutions -->
        <div class="card">
            <h2><i class="fas fa-life-ring"></i> Giải pháp thay thế</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                <div>
                    <h3><i class="fab fa-windows"></i> Tạo cổng COM thủ công</h3>
                    <p style="color: var(--gray); margin-bottom: 15px;">Tạo cổng COM ảo cho ZK4500:</p>
                    <ol style="color: var(--dark); padding-left: 20px; line-height: 1.8;">
                        <li>Device Manager → Action → Add legacy hardware</li>
                        <li>Chọn "Install hardware manually"</li>
                        <li>Chọn Ports (COM & LPT)</li>
                        <li>Chọn Standard → Communications Port</li>
                        <li>Chọn cổng COM chưa sử dụng</li>
                    </ol>
                </div>
                
                <div>
                    <h3><i class="fas fa-download"></i> Cài driver CH340 thủ công</h3>
                    <p style="color: var(--gray); margin-bottom: 15px;">Bắt Windows dùng driver CH340:</p>
                    <ol style="color: var(--dark); padding-left: 20px; line-height: 1.8;">
                        <li>Device Manager → ZK4500 → Update Driver</li>
                        <li>Browse my computer for drivers</li>
                        <li>Let me pick from a list</li>
                        <li>Chọn "USB Serial Converter"</li>
                        <li>Chọn "USB Serial" hoặc "CH340"</li>
                    </ol>
                </div>
                
                <div>
                    <h3><i class="fas fa-power-off"></i> Reset thiết bị vật lý</h3>
                    <p style="color: var(--gray); margin-bottom: 15px;">Cách reset ZK4500 sang Serial Mode:</p>
                    <ol style="color: var(--dark); padding-left: 20px; line-height: 1.8;">
                        <li>Rút USB khỏi máy tính</li>
                        <li>Nhấn giữ nút trên ZK4500 (nếu có)</li>
                        <li>Cắm USB vào trong khi giữ nút</li>
                        <li>Giữ thêm 5 giây rồi thả</li>
                        <li>Chờ Windows nhận driver mới</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // ZK4500 USB Composite Device Handler
        class ZK4500CompositeHandler {
            constructor() {
                this.port = null;
                this.isConnected = false;
                
                // ZK4500 Vendor IDs
                this.ZK_VENDOR_IDS = [
                    0x1A86,  // QinHeng Electronics (CH340)
                    0x0C40,  // ZKTeco VID
                    0x04E8,  // Samsung (sometimes used)
                    0x0483   // STMicroelectronics
                ];
                
                // Special commands for ZK4500 mode switching
                this.SPECIAL_COMMANDS = {
                    // Command to switch to Serial Mode
                    'mode_serial': new Uint8Array([0x55, 0xAA, 0x02, 0x01, 0x00, 0x00, 0xFD]),
                    
                    // Command to switch to HID Mode
                    'mode_hid': new Uint8Array([0x55, 0xAA, 0x02, 0x02, 0x00, 0x00, 0xFC]),
                    
                    // Reset device command
                    'reset_device': new Uint8Array([0x55, 0xAA, 0x01, 0x00, 0x00, 0x00, 0xFE]),
                    
                    // Force COM mode command
                    'force_com': new Uint8Array([0x7E, 0x4D, 0x4F, 0x44, 0x45, 0x31, 0x0D])
                };
                
                this.init();
            }

            init() {
                this.bindEvents();
                this.logMessage('ZK4500 USB Composite Handler đã sẵn sàng.');
                this.logMessage('Thiết bị đã được Windows nhận diện nhưng cần chuyển sang Serial Mode.');
            }

            bindEvents() {
                document.getElementById('switchToSerialBtn').addEventListener('click', () => this.switchToSerialMode());
                document.getElementById('forceCreateComBtn').addEventListener('click', () => this.forceCreateComPort());
                document.getElementById('connectByVidPidBtn').addEventListener('click', () => this.connectByVidPid());
                document.getElementById('tryAllModesBtn').addEventListener('click', () => this.tryAllConnectionModes());
                document.getElementById('sendCommandBtn').addEventListener('click', () => this.sendManualCommand());
                document.getElementById('manualCommand').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendManualCommand();
                });
            }

            // Try to send special command to switch to Serial Mode
            async switchToSerialMode() {
                try {
                    this.showNotification('Đang thử chuyển ZK4500 sang Serial Mode...', 'warning');
                    
                    // First, try to find the ZK4500 as a HID device
                    const devices = await navigator.hid.requestDevice({
                        filters: this.ZK_VENDOR_IDS.map(vid => ({ vendorId: vid }))
                    });
                    
                    if (devices.length === 0) {
                        this.showNotification('Không tìm thấy ZK4500 dưới dạng HID device.', 'error');
                        return;
                    }
                    
                    const device = devices[0];
                    this.logMessage(`Tìm thấy ZK4500 HID: ${device.productName || 'Unknown'}`);
                    
                    // Try to open the HID device
                    await device.open();
                    
                    // Try to send the mode switch command
                    const command = this.SPECIAL_COMMANDS.mode_serial;
                    
                    // For HID devices, we need to send a feature report or output report
                    // ZK4500 typically uses output report ID 0
                    try {
                        await device.sendReport(0, command);
                        this.logMessage('Đã gửi lệnh chuyển sang Serial Mode');
                        this.showNotification('Đã gửi lệnh chuyển mode. Thử cắm lại USB.', 'success');
                        
                        // Close HID connection
                        await device.close();
                        
                        // Ask user to reconnect
                        setTimeout(() => {
                            this.showNotification('Vui lòng rút và cắm lại ZK4500 để áp dụng thay đổi.', 'warning');
                        }, 2000);
                        
                    } catch (hidError) {
                        this.logMessage(`Không thể gửi lệnh qua HID: ${hidError.message}`);
                        
                        // Try alternative: Use WebUSB API if available
                        if (navigator.usb) {
                            await this.tryWebUsbModeSwitch();
                        }
                    }
                    
                } catch (error) {
                    this.logMessage(`Lỗi chuyển mode: ${error.message}`);
                    this.showNotification(`Lỗi: ${error.message}`, 'error');
                }
            }

            // Try using WebUSB API
            async tryWebUsbModeSwitch() {
                try {
                    this.showNotification('Đang thử dùng WebUSB API...', 'info');
                    
                    const device = await navigator.usb.requestDevice({
                        filters: this.ZK_VENDOR_IDS.map(vid => ({ vendorId: vid }))
                    });
                    
                    await device.open();
                    this.logMessage(`Đã kết nối WebUSB với: ${device.productName}`);
                    
                    // Try to send control transfer for mode switch
                    // ZK4500 often uses control transfer for mode switching
                    try {
                        await device.controlTransferOut({
                            requestType: 'vendor',
                            recipient: 'device',
                            request: 0x00,  // Vendor-specific request
                            value: 0x0001,  // Switch to serial mode
                            index: 0x0000
                        });
                        
                        this.logMessage('Đã gửi lệnh chuyển mode qua WebUSB');
                        this.showNotification('Thành công! Thử cắm lại USB.', 'success');
                        
                    } catch (usbError) {
                        this.logMessage(`Lỗi control transfer: ${usbError.message}`);
                    }
                    
                    await device.close();
                    
                } catch (error) {
                    this.logMessage(`Lỗi WebUSB: ${error.message}`);
                }
            }

            // Try to force create a COM port
            async forceCreateComPort() {
                try {
                    this.showNotification('Đang thử tạo cổng COM thủ công...', 'warning');
                    
                    // Try to connect with specific baud rates and settings
                    // that might trigger COM port creation
                    const baudRates = [115200, 9600, 57600, 19200];
                    
                    for (const baudRate of baudRates) {
                        this.logMessage(`Thử kết nối với baud rate ${baudRate}...`);
                        
                        try {
                            // Request port with ZK4500 filters
                            const port = await navigator.serial.requestPort({
                                filters: this.ZK_VENDOR_IDS.map(vid => ({ vendorId: vid }))
                            });
                            
                            // Try to open with specific settings
                            await port.open({
                                baudRate: baudRate,
                                dataBits: 8,
                                stopBits: 1,
                                parity: 'none',
                                flowControl: 'hardware'
                            });
                            
                            this.port = port;
                            this.isConnected = true;
                            
                            this.logMessage(`✅ Thành công với baud rate ${baudRate}!`);
                            this.showNotification(`Đã kết nối với ${baudRate} baud`, 'success');
                            this.updateConnectionStatus(true);
                            
                            // Try to send a test command
                            await this.sendTestCommand();
                            return;
                            
                        } catch (rateError) {
                            this.logMessage(`Baud ${baudRate} thất bại: ${rateError.message}`);
                            continue;
                        }
                    }
                    
                    this.showNotification('Không thể tạo cổng COM tự động.', 'error');
                    
                } catch (error) {
                    this.logMessage(`Lỗi tạo COM port: ${error.message}`);
                    this.showNotification(`Lỗi: ${error.message}`, 'error');
                }
            }

            // Connect by VID/PID directly
            async connectByVidPid() {
                try {
                    this.showNotification('Đang tìm ZK4500 bằng Vendor ID...', 'info');
                    
                    // Get all serial ports
                    const ports = await navigator.serial.getPorts();
                    this.logMessage(`Tìm thấy ${ports.length} cổng serial`);
                    
                    let zkPortFound = false;
                    
                    for (const port of ports) {
                        const info = port.getInfo();
                        const vid = info.usbVendorId;
                        
                        if (vid && this.ZK_VENDOR_IDS.includes(vid)) {
                            this.logMessage(`Tìm thấy ZK4500: VID=0x${vid.toString(16)}`);
                            zkPortFound = true;
                            
                            // Try to open this port
                            try {
                                await port.open({
                                    baudRate: 115200,
                                    dataBits: 8,
                                    stopBits: 1,
                                    parity: 'none'
                                });
                                
                                this.port = port;
                                this.isConnected = true;
                                this.updateConnectionStatus(true);
                                
                                this.logMessage('✅ Đã kết nối với ZK4500!');
                                this.showNotification('Đã kết nối thành công với ZK4500!', 'success');
                                
                                // Start reading
                                this.readData();
                                return;
                                
                            } catch (openError) {
                                this.logMessage(`Không thể mở port: ${openError.message}`);
                            }
                        }
                    }
                    
                    if (!zkPortFound) {
                        this.showNotification('Không tìm thấy ZK4500 trong danh sách cổng.', 'warning');
                        this.logMessage('Thử quét lại cổng COM...');
                        
                        // Request user to select a port
                        const port = await navigator.serial.requestPort({
                            filters: this.ZK_VENDOR_IDS.map(vid => ({ vendorId: vid }))
                        });
                        
                        const info = port.getInfo();
                        this.logMessage(`Người dùng chọn port: VID=0x${info.usbVendorId?.toString(16)}`);
                        
                        // Try to open
                        await port.open({ baudRate: 115200 });
                        this.port = port;
                        this.isConnected = true;
                        this.updateConnectionStatus(true);
                        this.readData();
                    }
                    
                } catch (error) {
                    this.logMessage(`Lỗi kết nối VID/PID: ${error.message}`);
                    this.showNotification(`Lỗi: ${error.message}`, 'error');
                }
            }

            // Try all possible connection modes
            async tryAllConnectionModes() {
                this.showNotification('Đang thử tất cả phương thức kết nối...', 'warning');
                
                const methods = [
                    this.tryStandardSerial.bind(this),
                    this.tryLowBaudRate.bind(this),
                    this.tryDifferentParity.bind(this),
                    this.tryWithFlowControl.bind(this)
                ];
                
                for (const method of methods) {
                    this.logMessage(`Thử phương thức: ${method.name}`);
                    try {
                        const success = await method();
                        if (success) {
                            this.showNotification('Tìm thấy phương thức kết nối phù hợp!', 'success');
                            return;
                        }
                    } catch (error) {
                        continue;
                    }
                }
                
                this.showNotification('Không tìm thấy phương thức kết nối phù hợp.', 'error');
            }

            async tryStandardSerial() {
                try {
                    const port = await navigator.serial.requestPort({
                        filters: this.ZK_VENDOR_IDS.map(vid => ({ vendorId: vid }))
                    });
                    
                    await port.open({
                        baudRate: 115200,
                        dataBits: 8,
                        stopBits: 1,
                        parity: 'none',
                        flowControl: 'none'
                    });
                    
                    this.port = port;
                    this.isConnected = true;
                    this.updateConnectionStatus(true);
                    this.readData();
                    return true;
                    
                } catch (error) {
                    return false;
                }
            }

            async tryLowBaudRate() {
                try {
                    const port = await navigator.serial.getPorts()[0];
                    if (!port) return false;
                    
                    await port.open({ baudRate: 9600 });
                    this.port = port;
                    this.isConnected = true;
                    this.updateConnectionStatus(true);
                    this.readData();
                    return true;
                    
                } catch (error) {
                    return false;
                }
            }

            // Send a test command
            async sendTestCommand() {
                if (!this.port || !this.isConnected) return;
                
                try {
                    const writer = this.port.writable.getWriter();
                    const encoder = new TextEncoder();
                    
                    // Send VER command
                    const data = encoder.encode('VER\r\n');
                    await writer.write(data);
                    writer.releaseLock();
                    
                    this.logMessage('Đã gửi lệnh VER');
                    
                } catch (error) {
                    this.logMessage(`Lỗi gửi test command: ${error.message}`);
                }
            }

            // Read data from port
            async readData() {
                try {
                    while (this.port.readable && this.isConnected) {
                        const reader = this.port.readable.getReader();
                        
                        try {
                            while (true) {
                                const { value, done } = await reader.read();
                                if (done) break;
                                if (value) {
                                    this.processData(value);
                                }
                            }
                        } finally {
                            reader.releaseLock();
                        }
                    }
                } catch (error) {
                    this.logMessage(`Lỗi đọc dữ liệu: ${error.message}`);
                }
            }

            processData(data) {
                const decoder = new TextDecoder();
                const text = decoder.decode(data);
                this.logMessage(`Nhận: ${text.trim()}`);
            }

            // Send manual command
            sendManualCommand() {
                const input = document.getElementById('manualCommand');
                const commandText = input.value.trim();
                
                if (!commandText) {
                    this.showNotification('Vui lòng nhập lệnh', 'warning');
                    return;
                }
                
                // Parse hex or text command
                let commandData;
                
                if (/^[0-9A-F\s]+$/i.test(commandText.replace(/\s+/g, ''))) {
                    // Hex command
                    const hexArray = commandText.trim().split(/\s+/);
                    commandData = new Uint8Array(hexArray.map(h => parseInt(h, 16)));
                    this.logMessage(`Gửi HEX: ${commandText}`);
                } else {
                    // Text command
                    const encoder = new TextEncoder();
                    commandData = encoder.encode(commandText + '\r\n');
                    this.logMessage(`Gửi: ${commandText}`);
                }
                
                // Send the command
                this.sendRawCommand(commandData);
                input.value = '';
                input.focus();
            }

            async sendRawCommand(data) {
                if (!this.port || !this.isConnected) {
                    this.showNotification('Chưa kết nối với thiết bị', 'error');
                    return;
                }
                
                try {
                    const writer = this.port.writable.getWriter();
                    await writer.write(data);
                    writer.releaseLock();
                } catch (error) {
                    this.logMessage(`Lỗi gửi lệnh: ${error.message}`);
                }
            }

            // Update connection status UI
            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('connectionStatus');
                
                if (connected) {
                    statusEl.className = 'status-box status-connected';
                    statusEl.innerHTML = '<i class="fas fa-check-circle"></i> <span>ĐÃ KẾT NỐI THÀNH CÔNG!</span>';
                } else {
                    statusEl.className = 'status-box status-disconnected';
                    statusEl.innerHTML = '<i class="fas fa-times-circle"></i> <span>THIẾT BỊ ĐÃ NHẬN NHƯNG CHƯA CÓ CỔNG COM</span>';
                }
            }

            // Log message to data log
            logMessage(message) {
                const logContainer = document.getElementById('dataLog');
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logContainer.appendChild(entry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            // Show notification
            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type}`;
                
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 4000);
            }
        }

        // Global function for special commands
        window.sendSpecialCommand = function(commandType) {
            if (window.zkHandler && window.zkHandler.SPECIAL_COMMANDS[commandType]) {
                const command = window.zkHandler.SPECIAL_COMMANDS[commandType];
                window.zkHandler.sendRawCommand(command);
                window.zkHandler.logMessage(`Đã gửi lệnh ${commandType}`);
            }
        };

        // Initialize the handler
        document.addEventListener('DOMContentLoaded', () => {
            window.zkHandler = new ZK4500CompositeHandler();
        });
    </script>
</body>
</html>
