<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZK4500 - Trình Giả Lập Quét Vân Tay</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        :root {
            --primary: #3a86ff;
            --success: #4cc9f0;
            --warning: #ffbe0b;
            --danger: #ff006e;
            --dark: #1a1a2e;
            --darker: #0d0d1a;
            --light: #f8f9fa;
            --gray: #6c757d;
        }

        body {
            background: linear-gradient(135deg, var(--darker), var(--dark));
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: rgba(26, 26, 46, 0.9);
            border-radius: 20px;
            padding: 25px 40px;
            margin-bottom: 30px;
            border: 2px solid var(--primary);
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .title-section h1 {
            font-size: 2.2rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-section {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--danger);
            animation: pulse 2s infinite;
        }

        .status-dot.active {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Panel Styling */
        .panel {
            background: rgba(26, 26, 46, 0.9);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(58, 134, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }

        .panel-header i {
            color: var(--primary);
            font-size: 1.2rem;
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--light);
        }

        /* Control Panel */
        .control-group {
            margin-bottom: 25px;
        }

        .btn {
            width: 100%;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--primary), #2962ff);
            color: white;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(58, 134, 255, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #2ab7f0);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #e6ac00);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #e60063);
        }

        /* Scanner Canvas */
        .scanner-container {
            position: relative;
            overflow: hidden;
            border-radius: 15px;
            background: #000;
            border: 3px solid var(--primary);
            min-height: 500px;
        }

        #scannerCanvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: pointer;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                var(--success) 50%, 
                transparent 100%);
            box-shadow: 0 0 10px var(--success);
            opacity: 0;
        }

        .finger-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--primary);
            z-index: 1;
            background: rgba(0, 0, 0, 0.7);
            padding: 30px;
            border-radius: 15px;
            border: 2px dashed var(--primary);
        }

        .finger-guide i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        /* Quality Indicators */
        .quality-meter {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
        }

        .quality-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .quality-poor { background: var(--danger); }
        .quality-fair { background: var(--warning); }
        .quality-good { background: var(--success); }
        .quality-excellent { background: var(--primary); }

        /* Minutiae Visualization */
        .minutiae-container {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            margin-top: 15px;
        }

        .minutiae-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--gray);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .minutiae-dot.active {
            background: var(--success);
            transform: scale(1.2);
            box-shadow: 0 0 10px var(--success);
        }

        /* Real-time Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .stat-unit {
            font-size: 0.9rem;
            color: var(--gray);
            margin-left: 5px;
        }

        /* Log Panel */
        .log-panel {
            height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            border-left: 3px solid var(--primary);
        }

        .log-time {
            color: var(--gray);
            margin-right: 10px;
        }

        /* Parameter Controls */
        .param-slider {
            margin: 15px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: var(--light);
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 2px solid white;
        }

        /* Capture History */
        .capture-history {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
            margin-top: 15px;
        }

        .capture-thumb {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            border: 2px solid var(--primary);
            cursor: pointer;
            flex-shrink: 0;
            overflow: hidden;
            position: relative;
        }

        .capture-thumb canvas {
            width: 100%;
            height: 100%;
        }

        .capture-index {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes scan {
            0% { top: 0; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .status-section {
                justify-content: center;
            }
            
            .main-grid {
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="title-section">
                    <h1><i class="fas fa-fingerprint"></i> ZK4500 - Trình Giả Lập Quét Vân Tay</h1>
                    <p style="color: var(--gray); margin-top: 5px;">Canvas-based Fingerprint Simulation</p>
                </div>
                <div class="status-section">
                    <div class="status-indicator">
                        <div id="statusDot" class="status-dot"></div>
                        <span id="statusText">Ngắt kết nối</span>
                    </div>
                    <div style="color: var(--primary); font-family: monospace;">
                        VID: 0x1B55 | PID: 0x0840
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Left Panel - Controls -->
            <div class="panel">
                <div class="panel-header">
                    <i class="fas fa-sliders-h"></i>
                    <div class="panel-title">Điều Khiển</div>
                </div>
                
                <div class="control-group">
                    <button id="connectBtn" class="btn">
                        <i class="fas fa-link"></i> Kết Nối Thiết Bị
                    </button>
                    <button id="disconnectBtn" class="btn btn-danger" disabled>
                        <i class="fas fa-unlink"></i> Ngắt Kết Nối
                    </button>
                </div>
                
                <div class="control-group">
                    <button id="startScanBtn" class="btn btn-success" disabled>
                        <i class="fas fa-play"></i> Bắt Đầu Quét
                    </button>
                    <button id="singleCaptureBtn" class="btn btn-warning" disabled>
                        <i class="fas fa-camera"></i> Chụp Ảnh Đơn
                    </button>
                    <button id="stopScanBtn" class="btn btn-danger" disabled>
                        <i class="fas fa-stop"></i> Dừng Quét
                    </button>
                </div>
                
                <div class="control-group">
                    <div class="panel-header" style="border: none; padding: 0; margin: 20px 0 15px;">
                        <i class="fas fa-cog"></i>
                        <div class="panel-title" style="font-size: 1.1rem;">Thông Số Quét</div>
                    </div>
                    
                    <div class="param-slider">
                        <div class="slider-label">
                            <span>Độ Sáng</span>
                            <span id="brightnessValue">50%</span>
                        </div>
                        <input type="range" id="brightnessSlider" min="0" max="100" value="50" step="1">
                    </div>
                    
                    <div class="param-slider">
                        <div class="slider-label">
                            <span>Độ Tương Phản</span>
                            <span id="contrastValue">70%</span>
                        </div>
                        <input type="range" id="contrastSlider" min="0" max="100" value="70" step="1">
                    </div>
                    
                    <div class="param-slider">
                        <div class="slider-label">
                            <span>Độ Nhiễu</span>
                            <span id="noiseValue">15%</span>
                        </div>
                        <input type="range" id="noiseSlider" min="0" max="100" value="15" step="1">
                    </div>
                    
                    <div class="param-slider">
                        <div class="slider-label">
                            <span>Độ Chi Tiết</span>
                            <span id="detailValue">80%</span>
                        </div>
                        <input type="range" id="detailSlider" min="0" max="100" value="80" step="1">
                    </div>
                </div>
                
                <button id="clearBtn" class="btn">
                    <i class="fas fa-eraser"></i> Xóa Màn Hình
                </button>
            </div>

            <!-- Center Panel - Scanner -->
            <div class="panel" style="padding: 0; overflow: hidden;">
                <div class="scanner-container">
                    <canvas id="scannerCanvas"></canvas>
                    
                    <div class="scanner-overlay">
                        <div id="scanLine" class="scan-line"></div>
                        <div id="fingerGuide" class="finger-guide">
                            <i class="fas fa-fingerprint"></i>
                            <div>Nhấn vào đây để mô phỏng</div>
                            <div style="font-size: 0.9rem; margin-top: 5px;">đặt ngón tay lên máy quét</div>
                        </div>
                    </div>
                </div>
                
                <div style="padding: 20px;">
                    <div class="panel-header" style="margin-bottom: 15px;">
                        <i class="fas fa-chart-line"></i>
                        <div class="panel-title">Chất Lượng Ảnh</div>
                    </div>
                    
                    <div class="quality-meter">
                        <div id="qualityBar" class="quality-fill" style="width: 0%"></div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                        <span style="color: var(--gray);">Kém</span>
                        <span id="qualityPercent" style="font-weight: bold; font-size: 1.2rem;">0%</span>
                        <span style="color: var(--gray);">Tuyệt vời</span>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Độ sáng TB</div>
                            <div class="stat-value">0<span class="stat-unit">%</span></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Độ tương phản</div>
                            <div class="stat-value">0<span class="stat-unit">%</span></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Điểm đặc trưng</div>
                            <div class="stat-value">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Thời gian quét</div>
                            <div class="stat-value">0<span class="stat-unit">s</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Analysis -->
            <div class="panel">
                <div class="panel-header">
                    <i class="fas fa-search"></i>
                    <div class="panel-title">Phân Tích Chi Tiết</div>
                </div>
                
                <div class="control-group">
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Điểm đặc trưng phát hiện:</span>
                            <span id="featureCount" style="font-weight: bold;">0</span>
                        </div>
                        
                        <div class="minutiae-container" id="minutiaeGrid">
                            <!-- Minutiae dots will be generated here -->
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="panel-header" style="border: none; padding: 0; margin: 20px 0 15px;">
                        <i class="fas fa-history"></i>
                        <div class="panel-title" style="font-size: 1.1rem;">Lịch Sử Quét</div>
                    </div>
                    
                    <div class="capture-history" id="captureHistory">
                        <!-- Capture thumbnails will be added here -->
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="panel-header" style="border: none; padding: 0; margin: 20px 0 15px;">
                        <i class="fas fa-terminal"></i>
                        <div class="panel-title" style="font-size: 1.1rem;">Nhật Ký Hệ Thống</div>
                    </div>
                    
                    <div class="log-panel" id="logPanel">
                        <!-- Log entries will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== CẤU HÌNH HỆ THỐNG ==========
        class FingerprintScanner {
            constructor() {
                this.canvas = document.getElementById('scannerCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.overlayCtx = null;
                
                // Scanner parameters
                this.width = 400;
                this.height = 500;
                this.dpi = 500;
                this.pixelSize = 1;
                
                // State
                this.isConnected = false;
                this.isScanning = false;
                this.isCapturing = false;
                this.currentImage = null;
                this.captures = [];
                this.scanLine = null;
                this.scanInterval = null;
                
                // Image parameters
                this.brightness = 50;
                this.contrast = 70;
                this.noise = 15;
                this.detail = 80;
                
                // Analysis data
                this.analysis = {
                    quality: 0,
                    avgBrightness: 0,
                    contrastValue: 0,
                    features: 0,
                    scanTime: 0
                };
                
                this.init();
            }
            
            init() {
                // Setup canvas
                this.setupCanvas();
                
                // Setup overlay canvas for scan line
                this.setupOverlay();
                
                // Generate initial fingerprint pattern
                this.generateBasePattern();
                
                // Setup minutiae grid
                this.setupMinutiaeGrid();
                
                // Draw initial state
                this.draw();
                
                console.log('Fingerprint Scanner initialized');
            }
            
            setupCanvas() {
                // Set canvas dimensions
                this.canvas.width = this.width;
                this.canvas.height = this.height;
                
                // Set display size
                this.canvas.style.width = '100%';
                this.canvas.style.height = '500px';
            }
            
            setupOverlay() {
                // Create overlay canvas for scan line
                const overlay = document.createElement('canvas');
                overlay.width = this.width;
                overlay.height = this.height;
                overlay.style.position = 'absolute';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.pointerEvents = 'none';
                overlay.style.zIndex = '2';
                
                const container = this.canvas.parentElement;
                container.appendChild(overlay);
                
                this.overlayCtx = overlay.getContext('2d');
                this.scanLine = document.getElementById('scanLine');
            }
            
            setupMinutiaeGrid() {
                const grid = document.getElementById('minutiaeGrid');
                grid.innerHTML = '';
                
                for (let i = 0; i < 64; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'minutiae-dot';
                    dot.title = `Điểm đặc trưng ${i + 1}`;
                    grid.appendChild(dot);
                }
            }
            
            // ========== VÂN TAY GENERATION ==========
            generateBasePattern() {
                const width = this.width;
                const height = this.height;
                const imageData = this.ctx.createImageData(width, height);
                const data = imageData.data;
                
                // Create Perlin-like noise for ridges
                const ridgeNoise = this.generateRidgeNoise(width, height);
                const swirlNoise = this.generateSwirlNoise(width, height);
                
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const idx = (y * width + x) * 4;
                        
                        // Base ridge pattern
                        let value = ridgeNoise[y][x];
                        
                        // Add swirl pattern (core of fingerprint)
                        const centerX = width / 2;
                        const centerY = height / 2;
                        const dx = x - centerX;
                        const dy = y - centerY;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        const angle = Math.atan2(dy, dx);
                        
                        // Swirl effect
                        const swirl = Math.sin(distance * 0.1 + angle) * swirlNoise[y][x];
                        value += swirl * 0.3;
                        
                        // Apply brightness and contrast
                        value = this.applyBrightnessContrast(value, this.brightness, this.contrast);
                        
                        // Add noise
                        value += (Math.random() - 0.5) * this.noise;
                        
                        // Clamp value
                        value = Math.max(0, Math.min(255, value));
                        
                        // Set pixel (grayscale)
                        data[idx] = data[idx + 1] = data[idx + 2] = value;
                        data[idx + 3] = 255; // Alpha
                    }
                }
                
                this.currentImage = imageData;
                return imageData;
            }
            
            generateRidgeNoise(width, height) {
                const noise = [];
                const frequency = 0.05 + (this.detail / 200); // Adjust frequency based on detail
                
                for (let y = 0; y < height; y++) {
                    noise[y] = [];
                    for (let x = 0; x < width; x++) {
                        // Multiple layers of sine waves for realistic ridges
                        let value = 0;
                        
                        // Layer 1: Horizontal ridges
                        value += Math.sin(y * frequency) * 80;
                        
                        // Layer 2: Vertical variations
                        value += Math.sin(x * frequency * 0.7) * 40;
                        
                        // Layer 3: Diagonal patterns
                        value += Math.sin((x + y) * frequency * 0.5) * 20;
                        
                        // Normalize to 0-255 range
                        value = (value + 150) / 300 * 255;
                        
                        noise[y][x] = value;
                    }
                }
                
                return noise;
            }
            
            generateSwirlNoise(width, height) {
                const noise = [];
                const centerX = width / 2;
                const centerY = height / 2;
                
                for (let y = 0; y < height; y++) {
                    noise[y] = [];
                    for (let x = 0; x < width; x++) {
                        const dx = x - centerX;
                        const dy = y - centerY;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        // Create swirl pattern that fades with distance
                        let value = Math.sin(distance * 0.1) * (1 - distance / Math.max(width, height));
                        
                        // Add some randomness
                        value += (Math.random() - 0.5) * 0.2;
                        
                        noise[y][x] = Math.max(0, value);
                    }
                }
                
                return noise;
            }
            
            applyBrightnessContrast(value, brightness, contrast) {
                // Normalize brightness (0-100 to -1 to 1)
                const b = (brightness - 50) / 50;
                
                // Normalize contrast (0-100 to 0 to 2)
                const c = contrast / 50;
                
                // Apply brightness
                let result = value + b * 128;
                
                // Apply contrast
                result = (result - 128) * c + 128;
                
                return result;
            }
            
            addMinutiaePoints(imageData) {
                const data = imageData.data;
                const width = imageData.width;
                const height = imageData.height;
                
                // Number of minutiae points based on detail level
                const numPoints = Math.floor(this.detail / 20);
                
                for (let i = 0; i < numPoints; i++) {
                    // Random position
                    const x = Math.floor(Math.random() * (width - 20)) + 10;
                    const y = Math.floor(Math.random() * (height - 20)) + 10;
                    
                    // Type: 0 = ridge ending, 1 = bifurcation
                    const type = Math.floor(Math.random() * 2);
                    
                    // Draw minutiae point
                    this.drawMinutiaePoint(data, width, x, y, type);
                }
                
                return numPoints;
            }
            
            drawMinutiaePoint(data, width, x, y, type) {
                const radius = 3;
                const color = type === 0 ? 0 : 255; // Black for ending, white for bifurcation
                
                for (let dy = -radius; dy <= radius; dy++) {
                    for (let dx = -radius; dx <= radius; dx++) {
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist <= radius) {
                            const px = x + dx;
                            const py = y + dy;
                            
                            if (px >= 0 && px < width && py >= 0 && py < this.height) {
                                const idx = (py * width + px) * 4;
                                data[idx] = data[idx + 1] = data[idx + 2] = color;
                            }
                        }
                    }
                }
            }
            
            // ========== DRAWING ==========
            draw() {
                if (!this.currentImage) return;
                
                // Clear canvas
                this.ctx.clearRect(0, 0, this.width, this.height);
                
                // Draw current image
                this.ctx.putImageData(this.currentImage, 0, 0);
                
                // Add real-time effects if scanning
                if (this.isScanning) {
                    this.drawScanningEffect();
                }
            }
            
            drawScanningEffect() {
                // Draw a moving scan line
                if (this.overlayCtx) {
                    this.overlayCtx.clearRect(0, 0, this.width, this.height);
                    
                    // Draw scan line
                    const scanY = Date.now() % this.height;
                    this.overlayCtx.fillStyle = 'rgba(76, 201, 240, 0.3)';
                    this.overlayCtx.fillRect(0, scanY, this.width, 3);
                    
                    // Draw glow effect
                    const gradient = this.overlayCtx.createLinearGradient(0, scanY, 0, scanY + 10);
                    gradient.addColorStop(0, 'rgba(76, 201, 240, 0)');
                    gradient.addColorStop(0.5, 'rgba(76, 201, 240, 0.5)');
                    gradient.addColorStop(1, 'rgba(76, 201, 240, 0)');
                    
                    this.overlayCtx.fillStyle = gradient;
                    this.overlayCtx.fillRect(0, scanY - 5, this.width, 20);
                }
            }
            
            // ========== SCANNING FUNCTIONS ==========
            startScanning() {
                if (this.isScanning || !this.isConnected) return;
                
                this.isScanning = true;
                this.showScanLine(true);
                
                // Start scanning animation
                this.scanInterval = setInterval(() => {
                    this.generateBasePattern();
                    this.draw();
                    
                    // Randomly capture during scanning
                    if (Math.random() < 0.1) {
                        this.captureFrame();
                    }
                }, 100);
                
                console.log('Started continuous scanning');
            }
            
            stopScanning() {
                if (!this.isScanning) return;
                
                this.isScanning = false;
                this.showScanLine(false);
                
                if (this.scanInterval) {
                    clearInterval(this.scanInterval);
                    this.scanInterval = null;
                }
                
                // Clear overlay
                if (this.overlayCtx) {
                    this.overlayCtx.clearRect(0, 0, this.width, this.height);
                }
                
                console.log('Stopped scanning');
            }
            
            captureFrame() {
                if (!this.isConnected || this.isCapturing) return;
                
                this.isCapturing = true;
                const startTime = Date.now();
                
                // Generate new fingerprint with current settings
                const imageData = this.generateBasePattern();
                
                // Add minutiae points
                const minutiaeCount = this.addMinutiaePoints(imageData);
                
                // Update current image
                this.currentImage = imageData;
                
                // Analyze the image
                this.analyzeImage(imageData);
                this.analysis.features = minutiaeCount;
                this.analysis.scanTime = (Date.now() - startTime) / 1000;
                
                // Update display
                this.draw();
                
                // Add to history
                this.addToHistory(imageData);
                
                // Update UI
                this.updateAnalysisDisplay();
                
                this.isCapturing = false;
                return imageData;
            }
            
            // ========== ANALYSIS ==========
            analyzeImage(imageData) {
                const data = imageData.data;
                const width = imageData.width;
                const height = imageData.height;
                const totalPixels = width * height;
                
                let sum = 0;
                let min = 255;
                let max = 0;
                
                // Calculate basic statistics
                for (let i = 0; i < data.length; i += 4) {
                    const value = data[i]; // R channel (grayscale)
                    sum += value;
                    min = Math.min(min, value);
                    max = Math.max(max, value);
                }
                
                const avg = sum / totalPixels;
                
                // Calculate variance for contrast
                let variance = 0;
                for (let i = 0; i < data.length; i += 4) {
                    const value = data[i];
                    variance += Math.pow(value - avg, 2);
                }
                variance /= totalPixels;
                const stdDev = Math.sqrt(variance);
                
                // Calculate quality score
                const brightnessScore = 100 - Math.abs(avg - 128) / 128 * 100;
                const contrastScore = Math.min(100, stdDev / 128 * 200);
                const noiseScore = 100 - this.noise;
                
                this.analysis.avgBrightness = Math.round((avg / 255) * 100);
                this.analysis.contrastValue = Math.round((stdDev / 128) * 100);
                this.analysis.quality = Math.round(
                    brightnessScore * 0.3 +
                    contrastScore * 0.4 +
                    noiseScore * 0.3
                );
            }
            
            // ========== HISTORY MANAGEMENT ==========
            addToHistory(imageData) {
                // Create thumbnail
                const thumbCanvas = document.createElement('canvas');
                thumbCanvas.width = 80;
                thumbCanvas.height = 80;
                const thumbCtx = thumbCanvas.getContext('2d');
                
                // Scale down the image
                thumbCtx.drawImage(this.canvas, 0, 0, 80, 80);
                
                // Create history item
                const historyItem = document.createElement('div');
                historyItem.className = 'capture-thumb';
                historyItem.innerHTML = `
                    <canvas width="80" height="80"></canvas>
                    <div class="capture-index">${this.captures.length + 1}</div>
                `;
                
                // Copy the thumbnail
                const itemCanvas = historyItem.querySelector('canvas');
                const itemCtx = itemCanvas.getContext('2d');
                itemCtx.drawImage(thumbCanvas, 0, 0);
                
                // Add click handler
                historyItem.addEventListener('click', () => {
                    this.displayCapture(imageData);
                });
                
                // Add to history container
                const historyContainer = document.getElementById('captureHistory');
                historyContainer.prepend(historyItem);
                
                // Store in array
                this.captures.unshift({
                    imageData: imageData,
                    thumbnail: thumbCanvas.toDataURL(),
                    timestamp: new Date(),
                    analysis: {...this.analysis}
                });
                
                // Limit history size
                if (this.captures.length > 10) {
                    this.captures.pop();
                    if (historyContainer.children.length > 10) {
                        historyContainer.removeChild(historyContainer.lastChild);
                    }
                }
            }
            
            displayCapture(imageData) {
                // Display selected capture
                this.currentImage = imageData;
                this.draw();
                this.updateAnalysisDisplay();
            }
            
            // ========== UI UPDATES ==========
            showScanLine(show) {
                const scanLine = this.scanLine;
                if (!scanLine) return;
                
                if (show) {
                    scanLine.style.opacity = '1';
                    scanLine.style.animation = 'scan 2s linear infinite';
                } else {
                    scanLine.style.opacity = '0';
                    scanLine.style.animation = 'none';
                }
            }
            
            updateAnalysisDisplay() {
                // Update quality bar
                const qualityBar = document.getElementById('qualityBar');
                const qualityPercent = document.getElementById('qualityPercent');
                
                qualityBar.style.width = `${this.analysis.quality}%`;
                qualityPercent.textContent = `${this.analysis.quality}%`;
                
                // Update quality bar color
                qualityBar.className = 'quality-fill ';
                if (this.analysis.quality >= 80) {
                    qualityBar.classList.add('quality-excellent');
                } else if (this.analysis.quality >= 60) {
                    qualityBar.classList.add('quality-good');
                } else if (this.analysis.quality >= 40) {
                    qualityBar.classList.add('quality-fair');
                } else {
                    qualityBar.classList.add('quality-poor');
                }
                
                // Update feature count
                document.getElementById('featureCount').textContent = this.analysis.features;
                
                // Update minutiae dots
                this.updateMinutiaeDots();
                
                // Update stats
                this.updateStatsDisplay();
            }
            
            updateMinutiaeDots() {
                const dots = document.querySelectorAll('.minutiae-dot');
                const activeCount = Math.min(this.analysis.features, dots.length);
                
                dots.forEach((dot, index) => {
                    if (index < activeCount) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
            }
            
            updateStatsDisplay() {
                // Update brightness
                const brightnessElements = document.querySelectorAll('.stat-value');
                if (brightnessElements[0]) {
                    brightnessElements[0].innerHTML = `${this.analysis.avgBrightness}<span class="stat-unit">%</span>`;
                }
                
                // Update contrast
                if (brightnessElements[1]) {
                    brightnessElements[1].innerHTML = `${this.analysis.contrastValue}<span class="stat-unit">%</span>`;
                }
                
                // Update features
                if (brightnessElements[2]) {
                    brightnessElements[2].textContent = this.analysis.features;
                }
                
                // Update scan time
                if (brightnessElements[3]) {
                    brightnessElements[3].innerHTML = `${this.analysis.scanTime.toFixed(2)}<span class="stat-unit">s</span>`;
                }
            }
            
            // ========== PARAMETER UPDATES ==========
            updateParameter(param, value) {
                this[param] = value;
                
                // Update display values
                document.getElementById(`${param}Value`).textContent = `${value}%`;
                
                // Regenerate image with new parameters
                if (this.isConnected) {
                    this.generateBasePattern();
                    this.draw();
                }
            }
            
            // ========== UTILITY FUNCTIONS ==========
            connect() {
                this.isConnected = true;
                console.log('Scanner connected');
            }
            
            disconnect() {
                this.isConnected = false;
                this.stopScanning();
                console.log('Scanner disconnected');
            }
            
            clear() {
                this.currentImage = null;
                this.ctx.clearRect(0, 0, this.width, this.height);
                
                // Reset to base pattern
                this.generateBasePattern();
                this.draw();
                
                console.log('Display cleared');
            }
        }

        // ========== APPLICATION INITIALIZATION ==========
        let scanner = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize scanner
            scanner = new FingerprintScanner();
            
            // Setup event listeners
            setupEventListeners();
            
            // Setup log system
            setupLogSystem();
            
            log('Hệ thống giả lập ZK4500 đã sẵn sàng', 'success');
        });

        function setupEventListeners() {
            // Connection buttons
            document.getElementById('connectBtn').addEventListener('click', () => {
                scanner.connect();
                updateConnectionStatus(true);
                log('Đã kết nối với máy quét vân tay ZK4500', 'success');
            });
            
            document.getElementById('disconnectBtn').addEventListener('click', () => {
                scanner.disconnect();
                updateConnectionStatus(false);
                log('Đã ngắt kết nối thiết bị', 'info');
            });
            
            // Scanner control buttons
            document.getElementById('startScanBtn').addEventListener('click', () => {
                scanner.startScanning();
                log('Bắt đầu chế độ quét liên tục', 'info');
            });
            
            document.getElementById('singleCaptureBtn').addEventListener('click', () => {
                scanner.captureFrame();
                log('Đã chụp ảnh vân tay', 'success');
            });
            
            document.getElementById('stopScanBtn').addEventListener('click', () => {
                scanner.stopScanning();
                log('Đã dừng quét', 'info');
            });
            
            document.getElementById('clearBtn').addEventListener('click', () => {
                scanner.clear();
                log('Đã xóa màn hình hiển thị', 'info');
            });
            
            // Parameter sliders
            setupParameterSliders();
            
            // Canvas click for manual capture
            document.getElementById('scannerCanvas').addEventListener('click', (e) => {
                if (!scanner.isConnected) {
                    log('Vui lòng kết nối thiết bị trước', 'warning');
                    return;
                }
                
                const rect = e.target.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Check if click is near center (finger placement area)
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
                
                if (distance < 100) {
                    scanner.captureFrame();
                    log('Phát hiện ngón tay - đang quét...', 'scan');
                }
            });
        }

        function setupParameterSliders() {
            const params = ['brightness', 'contrast', 'noise', 'detail'];
            
            params.forEach(param => {
                const slider = document.getElementById(`${param}Slider`);
                const valueDisplay = document.getElementById(`${param}Value`);
                
                slider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    valueDisplay.textContent = `${value}%`;
                    scanner.updateParameter(param, value);
                });
            });
        }

        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            // Update buttons
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const scanBtn = document.getElementById('startScanBtn');
            const captureBtn = document.getElementById('singleCaptureBtn');
            const stopBtn = document.getElementById('stopScanBtn');
            
            if (connected) {
                statusDot.classList.add('active');
                statusText.textContent = 'Đã kết nối';
                statusDot.style.background = 'var(--success)';
                
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                scanBtn.disabled = false;
                captureBtn.disabled = false;
                stopBtn.disabled = true;
            } else {
                statusDot.classList.remove('active');
                statusText.textContent = 'Ngắt kết nối';
                statusDot.style.background = 'var(--danger)';
                
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                scanBtn.disabled = true;
                captureBtn.disabled = true;
                stopBtn.disabled = true;
                
                // Stop scanning if active
                scanner.stopScanning();
            }
        }

        function setupLogSystem() {
            // Log container is already in HTML
        }

        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logPanel = document.getElementById('logPanel');
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span style="color: ${getLogColor(type)}">${message}</span>
            `;
            
            logPanel.appendChild(logEntry);
            logPanel.scrollTop = logPanel.scrollHeight;
            
            // Limit log entries
            const entries = logPanel.querySelectorAll('.log-entry');
            if (entries.length > 50) {
                logPanel.removeChild(entries[0]);
            }
        }

        function getLogColor(type) {
            switch(type) {
                case 'success': return 'var(--success)';
                case 'warning': return 'var(--warning)';
                case 'error': return 'var(--danger)';
                case 'scan': return 'var(--primary)';
                default: return 'var(--light)';
            }
        }
    </script>
</body>
</html>
